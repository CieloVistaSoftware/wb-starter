<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WB Parts - Permutation Test</title>
  <link rel="stylesheet" href="../src/styles/themes.css">
  <link rel="stylesheet" href="../src/styles/site.css">
  <style>
    body { padding: 2rem; }
    .test-section { margin-bottom: 3rem; border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
    .test-header { margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
    .permutation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
    .permutation-item { border: 1px dashed var(--border-color); padding: 1rem; border-radius: 4px; background: var(--bg-secondary); }
    .perm-label { font-family: monospace; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; display: block; white-space: pre-wrap; }
  </style>
</head>
<body>

  <h1>ðŸ§ª WB Parts Permutation Test</h1>
  <p>Exhaustive rendering of all component states based on registry definitions.</p>
  
  <div id="test-container"></div>

  <script type="module">
    import { initParts } from '../src/core/wb-parts.js';

    async function runTests() {
      // 1. Load Registry
      const response = await fetch('../src/parts/parts-registry.json');
      const registry = await response.json();
      
      // 2. Initialize Parts System
      await initParts({ registry: '../src/parts/parts-registry.json' });

      const container = document.getElementById('test-container');

      // 3. Generate Permutations for each part
      for (const [partName, def] of Object.entries(registry.parts)) {
        // Skip meta-parts that are containers for this test to avoid nesting hell
        if (['demo-section', 'example-block', 'stat-row', 'button-group', 'toolbar', 'badge-list', 'tag-list', 'file-toolbar'].includes(partName)) {
            continue;
        }

        const section = document.createElement('div');
        section.className = 'test-section';
        section.innerHTML = `
          <div class="test-header">
            <h2>&lt;${partName}&gt;</h2>
            <p>${def.description}</p>
          </div>
          <div class="permutation-grid" id="grid-${partName}"></div>
        `;
        container.appendChild(section);
        
        const grid = section.querySelector('.permutation-grid');
        const permutations = generatePermutations(def.attributes);

        permutations.forEach(props => {
          const wrapper = document.createElement('div');
          wrapper.className = 'permutation-item';
          
          // Create the element
          // Check if it needs auto-prefix
          const tagName = partName.includes('-') ? partName : `wb-${partName}`;
          const el = document.createElement(tagName);
          
          // Apply attributes
          let labelText = '';
          for (const [key, val] of Object.entries(props)) {
            if (val === true) {
              el.setAttribute(key, '');
              labelText += `${key} `;
            } else if (val !== false && val !== null && val !== undefined) {
              el.setAttribute(key, val);
              labelText += `${key}="${val}"\n`;
            }
          }

          // Add dummy content for body if needed
          // Some components expect body content
          if (!props.body && !props.text && !props.label) {
             el.textContent = 'Sample Content';
          }

          // Special handling for specific components that need data
          if (partName === 'badge-list') {
             // Skip complex data objects for now in this generic test
             wrapper.innerHTML = '<em>Complex data input skipped</em>';
          } else {
             wrapper.appendChild(el);
          }

          // Add label
          const label = document.createElement('small');
          label.className = 'perm-label';
          label.textContent = labelText || '(default)';
          wrapper.insertBefore(label, el);

          grid.appendChild(wrapper);
        });
      }
    }

    function generatePermutations(attributes) {
      const keys = Object.keys(attributes);
      const values = {};

      // Determine possible values for each attribute
      for (const key of keys) {
        const attr = attributes[key];
        if (attr.enum) {
          values[key] = attr.enum;
        } else if (attr.type === 'boolean') {
          values[key] = [true, false];
        } else if (attr.type === 'string') {
          // For string, we test: provided value vs not provided (if not required)
          const sample = getSampleString(key);
          if (attr.required) {
            values[key] = [sample];
          } else {
            values[key] = [sample, null]; // null means don't set attribute
          }
        } else {
           values[key] = [null];
        }
      }

      // Cartesian product
      // https://stackoverflow.com/a/43053803
      const cartesian = (...a) => a.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));
      
      const valueArrays = keys.map(k => values[k]);
      if (valueArrays.length === 0) return [{}];

      // If only 1 attribute, cartesian needs help
      let combos;
      if (valueArrays.length === 1) {
        combos = valueArrays[0].map(v => [v]);
      } else {
        combos = cartesian(...valueArrays);
      }

      // Map back to objects
      return combos.map(combo => {
        const obj = {};
        keys.forEach((key, i) => {
          if (combo[i] !== null) {
            obj[key] = combo[i];
          }
        });
        return obj;
      });
    }

    function getSampleString(key) {
      const samples = {
        label: 'Label',
        text: 'Sample Text',
        title: 'Card Title',
        subtitle: 'Subtitle',
        heading: 'Heading',
        message: 'This is a message body.',
        icon: 'â­',
        value: '1,234',
        trendValue: '+10%',
        name: 'John Doe',
        initials: 'JD',
        role: 'Admin',
        src: 'https://i.pravatar.cc/150?u=1',
        price: '$99',
        original: '$129',
        period: '/mo',
        href: '#',
        badge: '3'
      };
      return samples[key] || 'Sample';
    }

    runTests().catch(err => {
      console.error(err);
      document.body.innerHTML += `<pre style="color:red">${err.stack}</pre>`;
    });

  </script>
</body>
</html>
