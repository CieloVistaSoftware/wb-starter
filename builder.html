<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèóÔ∏è WB Page Builder</title>
  <!-- just two style sheets needed AutoLoad works great!  -->
  <link rel="stylesheet" href="src/styles/themes.css">
  <link rel="stylesheet" href="src/styles/site.css">
  <link rel="stylesheet" href="src/styles/builder.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* No duplicate rules: All styles here are unique to builder.html and not present in imported CSS files. Add page-specific overrides below if needed. */
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <h1>üèóÔ∏è WB Page Builder</h1>
    <div class="top-bar-actions">
      <button class="btn btn-secondary btn-sm" onclick="showConfigPanel()">‚öôÔ∏è Settings</button>
      <button class="btn btn-secondary btn-sm" onclick="showLoadSiteMenu(event)">üìÇ Load Site ‚ñæ</button>
      <button class="btn btn-secondary btn-sm" onclick="previewSite()">üëÅÔ∏è Preview</button>
      <button class="btn btn-secondary btn-sm" onclick="showExportMenu(event)">üì¶ Export ‚ñæ</button>
      <button class="btn btn-primary btn-sm" onclick="saveSite()">üíæ Save</button>
    </div>
  </div>

  <!-- Main Builder Layout -->
  <div class="builder-layout">
    
    <!-- Left Sidebar - Components (WB Drawer Layout) -->
    <aside class="sidebar-left wb-drawer-layout wb-drawer-layout--left" 
           id="leftDrawer"
           data-wb="drawerLayout" 
           data-wb-position="left" 
           data-wb-width="280px"
           data-wb-min-width="24px"
           data-wb-resizable="true"
           data-wb-save-state="true">
      <div class="drawer-content">
        <!-- Page Management -->
        <div class="pages-section">
          <h3>üìÑ Pages</h3>
          <div id="pagesList" class="pages-list"></div>
          <button class="btn btn-secondary btn-sm" style="width: 100%; margin-top: 0.5rem;" onclick="addNewPage()">
            + Add Page
          </button>
        </div>
        
        <!-- Dynamic Component Library - changes based on selected page -->
        <div id="componentLibrary"></div>
      </div>
      <button class="wb-drawer-toggle" onclick="toggleDrawer('leftDrawer')">‚óÄ</button>
      <div class="wb-drawer-handle" onmousedown="startResize(event, 'leftDrawer', 'left')"></div>
    </aside>

    <!-- Center Canvas -->
    <div class="canvas-area">
      <div class="canvas-toolbar">
        <span>Canvas</span>
        <span id="componentCount">0 components</span>
      </div>
      
      <div class="canvas-viewport">
        <div class="canvas">
          <!-- Header Section (SHARED across all pages) -->
          <div class="canvas-section header">
            <div class="section-label">Header <span style="font-size: 0.65rem; opacity: 0.7;">(shared)</span></div>
            <div class="components-container" id="header-container">
              <div class="canvas-drop-zone" data-section="header">
                üí° Drop header components here
              </div>
            </div>
          </div>

          <!-- Main Section -->
          <div class="canvas-section main">
            <div class="section-label">Main Content</div>
            <div class="components-container" id="main-container">
              <div class="canvas-drop-zone" data-section="main">
                üí° Drop content components here
              </div>
            </div>
          </div>

          <!-- Footer Section (SHARED across all pages) -->
          <div class="canvas-section footer">
            <div class="section-label">Footer <span style="font-size: 0.65rem; opacity: 0.7;">(shared)</span></div>
            <div class="components-container" id="footer-container">
              <div class="canvas-drop-zone" data-section="footer">
                üí° Drop footer components here
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar - Properties (WB Drawer Layout) -->
    <aside class="sidebar-right wb-drawer-layout wb-drawer-layout--right" 
           id="rightDrawer"
           data-wb="drawerLayout" 
           data-wb-position="right" 
           data-wb-width="350px"
           data-wb-min-width="24px"
           data-wb-resizable="true"
           data-wb-save-state="true">
      <button class="wb-drawer-toggle" onclick="toggleDrawer('rightDrawer')">‚ñ∂</button>
      <div class="wb-drawer-handle" onmousedown="startResize(event, 'rightDrawer', 'right')"></div>
      <div class="drawer-content">
        <div id="propertiesPanel" class="properties-empty">
          Click a component to edit its properties
        </div>
      </div>
    </aside>
  </div>

    <!-- Hidden file input for JSON upload -->
  <input type="file" id="jsonFileInput" accept=".json" onchange="handleJsonFileUpload(event)">

  <!-- Status Bar -->
  <div class="status-bar">
    <span id="activeElement"><span style="color: #10b981;"><strong>üìÑ Page:</strong> Home <code style="background: rgba(99, 102, 241, 0.2); padding: 0.15rem 0.4rem; border-radius: 3px; font-family: monospace; font-size: 0.8rem; margin-left: 0.5rem;">/</code></span></span>
    <span style="display: flex; align-items: center; gap: 1rem;">
      <span id="templateIndicator" style="display: none;"></span>
      <span id="status">Ready</span>
    </span>
  </div>

  <script>
    let draggedComponent = null;
    let selectedComponent = null;
    let components = [];  // Components for current page's MAIN section only
    let componentIdCounter = 0;
    
    // === SHARED HEADER/FOOTER STATE MODEL ===
    // Header and Footer are GLOBAL - shared across all pages
    // Only MAIN content is page-specific
    let globalSections = {
      header: [],  // Shared across ALL pages
      footer: []   // Shared across ALL pages
    };
    
    // Page Management - pages only store MAIN content
    let pages = [
      { 
        id: 'home', 
        name: 'Home', 
        slug: 'index.html', 
        main: [{
          id: 'comp-home-hero',
          type: 'hero',
          section: 'main',
          html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 4rem 2rem; text-align: center; color: white; border-radius: 8px;">
          <h2 style="font-size: 2.5rem; margin: 0 0 1rem 0;">Welcome to Your Site</h2>
          <p style="font-size: 1.1rem; margin: 0;">Your value proposition goes here</p>
        </div>`,
          data: {}
        }]
      }
    ];
    let currentPageId = 'home';
    
    // === PAGE-SPECIFIC COMPONENT LIBRARIES ===
    // Define which components are available for each page type
    const pageComponentSets = {
      // Home page gets ALL components
      home: {
        header: [
          { id: 'navbar', icon: 'üîù', name: 'Navigation Bar' },
          { id: 'header-logo', icon: 'üìç', name: 'Logo & Title' }
        ],
        main: [
          { id: 'hero', icon: 'ü¶∏', name: 'Hero Section' },
          { id: 'features', icon: '‚ú®', name: 'Features' },
          { id: 'testimonials', icon: 'üí¨', name: 'Testimonials' },
          { id: 'pricing', icon: 'üí∞', name: 'Pricing Table' },
          { id: 'team', icon: 'üë•', name: 'Team Members' },
          { id: 'gallery', icon: 'üñºÔ∏è', name: 'Image Gallery' },
          { id: 'faq', icon: '‚ùì', name: 'FAQ Section' },
          { id: 'cta', icon: 'üìû', name: 'Call to Action' },
          { id: 'card', icon: 'üÉè', name: 'Card' }
        ],
        footer: [
          { id: 'footer', icon: 'üîª', name: 'Footer' },
          { id: 'newsletter', icon: 'üìß', name: 'Newsletter' }
        ]
      },
      // About page - team, testimonials, gallery focus
      about: {
        main: [
          { id: 'hero', icon: 'ü¶∏', name: 'Page Header' },
          { id: 'team', icon: 'üë•', name: 'Team Members' },
          { id: 'testimonials', icon: 'üí¨', name: 'Testimonials' },
          { id: 'gallery', icon: 'üñºÔ∏è', name: 'Image Gallery' },
          { id: 'card', icon: 'üÉè', name: 'Content Card' },
          { id: 'cta', icon: 'üìû', name: 'Call to Action' }
        ]
      },
      // Contact page - CTA, forms, FAQ
      contact: {
        main: [
          { id: 'hero', icon: 'ü¶∏', name: 'Page Header' },
          { id: 'cta', icon: 'üìû', name: 'Contact Info' },
          { id: 'faq', icon: '‚ùì', name: 'FAQ Section' },
          { id: 'card', icon: 'üÉè', name: 'Info Card' },
          { id: 'newsletter', icon: 'üìß', name: 'Newsletter' }
        ]
      },
      // Default for custom pages
      default: {
        main: [
          { id: 'hero', icon: 'ü¶∏', name: 'Page Header' },
          { id: 'card', icon: 'üÉè', name: 'Content Card' },
          { id: 'gallery', icon: 'üñºÔ∏è', name: 'Image Gallery' },
          { id: 'testimonials', icon: 'üí¨', name: 'Testimonials' },
          { id: 'faq', icon: '‚ùì', name: 'FAQ Section' },
          { id: 'cta', icon: 'üìû', name: 'Call to Action' }
        ]
      }
    };
    
    // Render component library based on current page
    function renderComponentLibrary() {
      const library = document.getElementById('componentLibrary');
      if (!library) return;
      
      // Get component set for current page (or default)
      const pageSet = pageComponentSets[currentPageId] || pageComponentSets.default;
      
      let html = '';
      
      // Only show header/footer on Home page (they're shared globally)
      if (currentPageId === 'home') {
        if (pageSet.header && pageSet.header.length > 0) {
          html += '<h3>üîù Header Components</h3>';
          pageSet.header.forEach(comp => {
            html += `<div class="component-item" draggable="true" data-component="${comp.id}">${comp.icon} ${comp.name}</div>`;
          });
        }
      }
      
      // Main content components (always show)
      if (pageSet.main && pageSet.main.length > 0) {
        const sectionTitle = currentPageId === 'home' ? 'üìÑ Main Content' : `üìÑ ${getCurrentPage()?.name || 'Page'} Components`;
        html += `<h3>${sectionTitle}</h3>`;
        pageSet.main.forEach(comp => {
          html += `<div class="component-item" draggable="true" data-component="${comp.id}">${comp.icon} ${comp.name}</div>`;
        });
      }
      
      // Only show footer on Home page (they're shared globally)
      if (currentPageId === 'home') {
        if (pageSet.footer && pageSet.footer.length > 0) {
          html += '<h3>üîª Footer Components</h3>';
          pageSet.footer.forEach(comp => {
            html += `<div class="component-item" draggable="true" data-component="${comp.id}">${comp.icon} ${comp.name}</div>`;
          });
        }
      } else {
        // Show hint for non-home pages
        html += `
          <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.8rem; color: var(--text-secondary);">
            <strong>üí° Tip:</strong> Header & Footer are shared across all pages. Edit them on the Home page.
          </div>
        `;
      }
      
      library.innerHTML = html;
      
      // Re-attach drag handlers to new elements
      library.querySelectorAll('.component-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedComponent = item.dataset.component;
          e.dataTransfer.effectAllowed = 'copy';
        });
      });
    }
    
    // Get current page
    function getCurrentPage() {
      return pages.find(p => p.id === currentPageId);
    }
    
    // Get all components (global header/footer + current page main)
    function getAllComponents() {
      return [...globalSections.header, ...components, ...globalSections.footer];
    }
    
    // Render pages list (maintain navbar order: Home, About, Contact, then any custom pages)
    function renderPagesList() {
      // Sort pages to maintain navbar order
      const pageOrder = ['home', 'about', 'contact'];
      const sortedPages = [...pages].sort((a, b) => {
        const aIndex = pageOrder.indexOf(a.id);
        const bIndex = pageOrder.indexOf(b.id);
        if (aIndex === -1 && bIndex === -1) return 0;
        if (aIndex === -1) return 1;
        if (bIndex === -1) return -1;
        return aIndex - bIndex;
      });
      
      const list = document.getElementById('pagesList');
      list.innerHTML = sortedPages.map(page => `
        <div class="page-item ${page.id === currentPageId ? 'active' : ''}" onclick="switchToPage('${page.id}')">
          <span class="page-name">${page.name}</span>
          ${page.id !== 'home' && pages.length > 1 ? `<button class="page-delete" onclick="deletePage('${page.id}', event)">‚úï</button>` : ''}
        </div>
      `).join('');
    }
    
    // Switch to a different page
    // NOTE: Header and Footer are GLOBAL - they don't change!
    // Only MAIN content switches between pages
    function switchToPage(pageId) {
      console.log('switchToPage called:', pageId);
      
      // Save current page's MAIN content only
      const currentPage = getCurrentPage();
      if (currentPage) {
        currentPage.main = components
          .filter(c => c.section === 'main')
          .map(c => ({
            id: c.id,
            type: c.type,
            section: c.section,
            html: c.html,
            data: c.data
          }));
        console.log('Saved current page main:', currentPage.main.length, 'components');
      }
      
      // Switch page
      currentPageId = pageId;
      const newPage = getCurrentPage();
      console.log('New page:', newPage?.name, 'with', newPage?.main?.length || 0, 'components');
      
      // Only clear MAIN section - header/footer are shared!
      const mainContainer = document.getElementById('main-container');
      const mainDropZone = mainContainer.querySelector('.canvas-drop-zone');
      
      // Remove only main components from DOM
      mainContainer.querySelectorAll('.canvas-component').forEach(el => el.remove());
      mainDropZone.classList.remove('has-items');
      
      // Remove main components from components array
      components = components.filter(c => c.section !== 'main');
      console.log('After clearing main, components array has:', components.length);
      
      // Load new page's MAIN content
      selectedComponent = null;
      document.getElementById('propertiesPanel').innerHTML = 
        `<div class="properties-empty">Click a component to edit its properties</div>`;
      
      if (newPage && newPage.main && newPage.main.length > 0) {
        console.log('Loading', newPage.main.length, 'components for new page');
        newPage.main.forEach(compData => {
          console.log('Restoring component:', compData.type, compData.id);
          const template = componentTemplates[compData.type];
          if (template) {
            restoreComponent(compData, template);
          } else {
            console.error('Template not found for:', compData.type);
          }
        });
      } else {
        console.log('New page has no main content');
      }
      
      renderPagesList();
      updateComponentCount();
      
      // Show page properties in the panel
      showPageProperties(newPage);
      
      // Update active element in status bar
      updateActiveElement('page', newPage?.name || pageId);
      
      // Show/hide shared sections based on page
      // Non-home pages only show main content (header/footer are shared)
      updateCanvasSectionsVisibility(pageId);
      
      updateStatus(`Switched to ${newPage?.name || pageId}`);
      console.log('switchToPage complete, components:', components.length);
      
      // Update component library for this page type
      renderComponentLibrary();
    }
    
    // Show/hide canvas sections based on current page
    // Home page shows all sections; other pages show only main content
    function updateCanvasSectionsVisibility(pageId) {
      const headerSection = document.querySelector('.canvas-section.header');
      const footerSection = document.querySelector('.canvas-section.footer');
      const mainSection = document.querySelector('.canvas-section.main');
      const mainLabel = mainSection.querySelector('.section-label');
      
      const currentPage = pages.find(p => p.id === pageId);
      const pageName = currentPage?.name || pageId;
      
      if (pageId === 'home') {
        // Home page - show all sections
        headerSection.style.display = '';
        footerSection.style.display = '';
        mainSection.style.flex = '1';
        mainSection.style.minHeight = '';
        mainLabel.innerHTML = 'Main Content';
      } else {
        // Other pages - hide header/footer, expand main to fill canvas
        headerSection.style.display = 'none';
        footerSection.style.display = 'none';
        mainSection.style.flex = '1';
        mainSection.style.minHeight = '500px';
        mainLabel.innerHTML = `üìÑ ${pageName} <span style="font-size: 0.65rem; opacity: 0.7;">(main content)</span>`;
      }
    }
    
    // Show page properties in the properties panel
    function showPageProperties(page) {
      if (!page) return;
      
      const panel = document.getElementById('propertiesPanel');
      panel.innerHTML = `
        <div class="properties-section">
          <h4>üìÑ ${page.name} Settings</h4>
          
          <div class="property">
            <label>Page Name</label>
            <div class="editable-field" 
                 contenteditable="${page.id !== 'home'}" 
                 data-placeholder="Enter page name..."
                 data-field="name"
                 data-page-id="${page.id}"
                 onblur="updatePagePropertyFromEditable(this)">${page.name}</div>
            ${page.id === 'home' ? '<small style="color: var(--text-secondary); font-size: 0.75rem;">Home page cannot be renamed</small>' : ''}
          </div>
          
          <div class="property">
            <label>Relative URL</label>
            <div class="editable-field" 
                 contenteditable="${page.id !== 'home'}" 
                 data-placeholder="page-url.html"
                 data-field="slug"
                 data-page-id="${page.id}"
                 onblur="updatePagePropertyFromEditable(this)">${page.slug}</div>
            ${page.id === 'home' ? '<small style="color: var(--text-secondary); font-size: 0.75rem;">Home page slug cannot be changed</small>' : ''}
          </div>
          
          <div class="property">
            <label>Page Title (SEO)</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="${page.name} - My Website"
                 data-field="seoTitle"
                 data-page-id="${page.id}"
                 onblur="updatePagePropertyFromEditable(this)">${page.seoTitle || ''}</div>
          </div>
          
          <div class="property">
            <label>Meta Description (SEO)</label>
            <div class="editable-field tall" 
                 contenteditable="true" 
                 data-placeholder="Brief description for search engines... This text appears in search results below your page title."
                 data-field="seoDescription"
                 data-page-id="${page.id}"
                 style="min-height: 120px;"
                 onblur="updatePagePropertyFromEditable(this)">${page.seoDescription || ''}</div>
          </div>
        </div>
        
        <div class="properties-section">
          <h4>üìä Page Stats</h4>
          <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
            <strong>${page.main?.length || 0}</strong> components on this page
          </p>
        </div>
        
        ${page.id !== 'home' ? `
          <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary); border-radius: 8px;">
            <p style="margin: 0; font-size: 0.85rem; color: var(--primary);">
              üí° <strong>Editing Main Content Only</strong><br>
              <span style="color: var(--text-secondary); font-size: 0.8rem;">Header & Footer are shared across all pages. Switch to Home to edit them.</span>
            </p>
          </div>
          
          <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="deletePage('${page.id}', event)">
            üóëÔ∏è Delete Page
          </button>
        ` : ''}
        
        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 1rem; text-align: center;">
          Click a component to edit its properties
        </p>
      `;
    }
    
    // Update a page property
    function updatePageProperty(pageId, property, value) {
      const page = pages.find(p => p.id === pageId);
      if (!page) return;
      
      page[property] = value;
      
      // If name changed, update slug too (unless slug was manually set)
      if (property === 'name' && !page.slugManuallySet) {
        const newSlug = value.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') + '.html';
        page.slug = newSlug;
      }
      
      // If slug changed manually, mark it
      if (property === 'slug') {
        page.slugManuallySet = true;
      }
      
      renderPagesList();
      updateNavbarLinks();
      showPageProperties(page);
      updateStatus(`Updated page ${property}`);
    }
    
    // Update page property from contenteditable field
    function updatePagePropertyFromEditable(element) {
      const pageId = element.dataset.pageId;
      const field = element.dataset.field;
      const value = element.textContent.trim();
      
      if (pageId && field) {
        updatePageProperty(pageId, field, value);
      }
    }
    
    // Restore a component from saved data
    function restoreComponent(compData, template) {
      const componentId = compData.id || `comp-${componentIdCounter++}`;
      console.log('restoreComponent:', componentId, 'type:', compData.type, 'has html:', !!compData.html);
      
      // Get HTML - use saved, or generate from template with data
      let html = compData.html;
      if (!html && template.getHtml) {
        console.log('Generating HTML from template for', compData.type);
        // Navbar expects a string (logo text), others expect data object
        if (compData.type === 'navbar') {
          html = template.getHtml(compData.data?.logo || 'Logo');
        } else {
          html = template.getHtml(compData.data || {});
        }
      }
      if (!html) {
        html = template.html;
        console.log('Using default template HTML for', compData.type);
      }
      
      // Determine if component should be editable
      const isEditable = !template.isFeatureGrid && !template.isPricingGrid && !template.isCard && !template.isCTA;
      
      const componentEl = document.createElement('div');
      componentEl.className = 'canvas-component';
      componentEl.id = componentId;
      componentEl.tabIndex = 0;
      componentEl.innerHTML = `
        <div class="component-content" ${isEditable ? 'contenteditable="true"' : ''}>${html}</div>
        <div class="component-overlay">
          <span class="component-label">${template.icon} ${template.name}</span>
          <button class="component-delete-btn" onclick="deleteComponent('${componentId}', event)">üóëÔ∏è</button>
        </div>
      `;
      
      // Use mousedown for selection (fires before focus changes)
      componentEl.addEventListener('mousedown', (e) => {
        if (!e.target.classList.contains('component-delete-btn')) {
          selectComponent(componentEl, compData.type, template);
        }
      });
      
      // Save contenteditable changes
      const contentEl = componentEl.querySelector('.component-content');
      contentEl.addEventListener('blur', () => {
        const comp = components.find(c => c.id === componentId);
        if (comp) {
          comp.html = contentEl.innerHTML;
        }
      });
      contentEl.addEventListener('input', () => {
        const comp = components.find(c => c.id === componentId);
        if (comp) {
          comp.html = contentEl.innerHTML;
        }
      });
      
      // Only delete component if not editing text
      componentEl.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' && selectedComponent && selectedComponent.id === componentId) {
          // Check if we're in a contenteditable - if so, let it handle delete
          const activeEl = document.activeElement;
          if (activeEl && activeEl.getAttribute('contenteditable') === 'true') {
            return; // Let contenteditable handle the delete key
          }
          deleteComponent(componentId);
        }
      });
      
      const container = document.getElementById(`${compData.section}-container`);
      const dropZone = container.querySelector('.canvas-drop-zone');
      container.insertBefore(componentEl, dropZone);
      dropZone.classList.add('has-items');
      
      components.push({
        id: componentId,
        type: compData.type,
        section: compData.section,
        element: componentEl,
        template: template,
        html: html,
        data: compData.data || {}
      });
      
      // Set up click handlers for special component types
      if (template.isFeatureGrid) {
        setupFeatureGridClickHandlers(componentId);
      }
      if (template.isPricingGrid) {
        setupPricingGridClickHandlers(componentId);
      }
      
      console.log('restoreComponent complete:', componentId, 'added to', compData.section);
    }
    
    // Add new page
    function addNewPage() {
      // Close any existing dialog
      document.getElementById('newPageDialog')?.remove();
      
      // Page templates with display names
      const pageTemplates = [
        { id: 'blank', icon: 'üìã', name: 'Blank' },
        { id: 'services', icon: '‚öôÔ∏è', name: 'Services' },
        { id: 'contact', icon: 'üìû', name: 'Contact' },
        { id: 'about', icon: '‚ÑπÔ∏è', name: 'About' },
        { id: 'portfolio', icon: 'üñºÔ∏è', name: 'Portfolio' },
        { id: 'faq', icon: '‚ùì', name: 'FAQ' }
      ];
      
      // Create dialog
      const dialog = document.createElement('div');
      dialog.id = 'newPageDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      dialog.innerHTML = `
        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 2rem; width: 400px; max-width: 90%;">
          <h3 style="margin: 0 0 1.5rem 0; font-size: 1.2rem;">üìÑ Add New Page</h3>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">Select Page Type</label>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
              ${pageTemplates.map((t, i) => `
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--bg-tertiary); border: 2px solid ${i === 0 ? 'var(--primary)' : 'var(--border-color)'}; border-radius: 6px; cursor: pointer;
                <input type="radio" name="pageTemplate" value="${t.id}" data-name="${t.name}" ${i === 0 ? 'checked' : ''} style="accent-color: var(--primary);">
                <span>${t.icon} ${t.name}</span>
              </label>
            `).join('')}
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">Page Name <span style="opacity: 0.6;">(optional - defaults to selected type)</span></label>
            <input type="text" id="newPageName" placeholder="Custom name..." style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1rem;">
          </div>
          
          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="document.getElementById('newPageDialog').remove()" class="btn btn-secondary">Cancel</button>
            <button onclick="createNewPage()" class="btn btn-primary">Create Page</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);
      
      // Handle enter key
      document.getElementById('newPageName').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') createNewPage();
        if (e.key === 'Escape') dialog.remove();
      });
      
      // Update radio button styles on change
      dialog.querySelectorAll('input[name="pageTemplate"]').forEach(radio => {
        radio.addEventListener('change', () => {
          dialog.querySelectorAll('input[name="pageTemplate"]').forEach(r => {
            r.closest('label').style.borderColor = r.checked ? 'var(--primary)' : 'var(--border-color)';
          });
        });
      });
    }
    
    // Create the new page with selected template
    function createNewPage() {
      // Get selected template
      const selectedRadio = document.querySelector('input[name="pageTemplate"]:checked');
      const template = selectedRadio?.value || 'blank';
      const templateName = selectedRadio?.dataset.name || 'Page';
      
      // Use custom name if provided, otherwise use template name
      const customName = document.getElementById('newPageName').value.trim();
      const name = customName || templateName;
      
      // For blank template with no custom name, prompt user
      if (template === 'blank' && !customName) {
        alert('Please enter a page name for blank pages');
        document.getElementById('newPageName').focus();
        return;
      }
      
      const id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
      const slug = id + '.html';
      
      // Check for duplicate
      if (pages.find(p => p.id === id)) {
        alert(`A page named "${name}" already exists. Please choose a different name.`);
        document.getElementById('newPageName').focus();
        return;
      }
      
      // Create page with template content
      const newPage = { id, name, slug, main: [] };
      
      // Add template content
      switch (template) {
        case 'services':
          newPage.main = [
            {
              id: `comp-${id}-hero`,
              type: 'hero',
              section: 'main',
              html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem 2rem; text-align: center; color: white; border-radius: 8px;">
                <h2 style="font-size: 2rem; margin: 0 0 0.5rem 0;">Our Services</h2>
                <p style="font-size: 1rem; margin: 0;">What we can do for you</p>
              </div>`,
              data: {}
            },
            {
              id: `comp-${id}-features`,
              type: 'features',
              section: 'main',
              html: null,
              data: {
                cards: [
                  { icon: '‚öôÔ∏è', title: 'Service 1', description: 'Description of your first service' },
                  { icon: 'üõ†Ô∏è', title: 'Service 2', description: 'Description of your second service' },
                  { icon: 'üöÄ', title: 'Service 3', description: 'Description of your third service' }
                ],
                selectedCard: 0
              }
            }
          ];
          break;
          
        case 'contact':
          newPage.main = [
            {
              id: `comp-${id}-hero`,
              type: 'hero',
              section: 'main',
              html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem 2rem; text-align: center; color: white; border-radius: 8px;">
                <h2 style="font-size: 2rem; margin: 0 0 0.5rem 0;">Contact Us</h2>
                <p style="font-size: 1rem; margin: 0;">We'd love to hear from you</p>
              </div>`,
              data: {}
            },
            {
              id: `comp-${id}-cta`,
              type: 'cta',
              section: 'main',
              html: null,
              data: {
                contactType: 'phone',
                phoneNumber: '(555) 123-4567',
                title: 'Give Us a Call',
                description: 'Our team is ready to help you!',
                gradientStart: '#10b981',
                gradientEnd: '#059669'
              }
            }
          ];
          break;
          
        case 'about':
          newPage.main = [
            {
              id: `comp-${id}-hero`,
              type: 'hero',
              section: 'main',
              html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem 2rem; text-align: center; color: white; border-radius: 8px;">
                <h2 style="font-size: 2rem; margin: 0 0 0.5rem 0;">About Us</h2>
                <p style="font-size: 1rem; margin: 0;">Learn more about our story</p>
              </div>`,
              data: {}
            },
            {
              id: `comp-${id}-team`,
              type: 'team',
              section: 'main',
              html: componentTemplates.team.html,
              data: {}
            }
          ];
          break;
          
        case 'portfolio':
          newPage.main = [
            {
              id: `comp-${id}-hero`,
              type: 'hero',
              section: 'main',
              html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem 2rem; text-align: center; color: white; border-radius: 8px;">
                <h2 style="font-size: 2rem; margin: 0 0 0.5rem 0;">Our Portfolio</h2>
                <p style="font-size: 1rem; margin: 0;">Check out our latest work</p>
              </div>`,
              data: {}
            },
            {
              id: `comp-${id}-gallery`,
              type: 'gallery',
              section: 'main',
              html: componentTemplates.gallery.html,
              data: {}
            }
          ];
          break;
          
        case 'faq':
          newPage.main = [
            {
              id: `comp-${id}-hero`,
              type: 'hero',
              section: 'main',
              html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem 2rem; text-align: center; color: white; border-radius: 8px;">
                <h2 style="font-size: 2rem; margin: 0 0 0.5rem 0;">Frequently Asked Questions</h2>
                <p style="font-size: 1rem; margin: 0;">Find answers to common questions</p>
              </div>`,
              data: {}
            },
            {
              id: `comp-${id}-faq`,
              type: 'faq',
              section: 'main',
              html: componentTemplates.faq.html,
              data: {}
            }
          ];
          break;
          
        case 'blank':
        default:
          // Empty page
          break;
      }
      
      // Add page
      pages.push(newPage);
      console.log('Created new page:', newPage.name, 'with', newPage.main.length, 'components');
      console.log('New page main content:', JSON.stringify(newPage.main.map(c => ({ type: c.type, hasHtml: !!c.html }))));
      
      // Close dialog
      document.getElementById('newPageDialog').remove();
      
      // Switch to the new page
      console.log('About to switch to new page:', id);
      switchToPage(id);
      
      // Update navbar
      updateNavbarLinks();
      
      updateStatus(`‚úÖ Created "${name}" page with ${template} template`);
    }
    
    // Delete page
    function deletePage(pageId, event) {
      event.stopPropagation();
      if (pages.length <= 1) {
        alert('Cannot delete the last page');
        return;
      }
      
      const page = pages.find(p => p.id === pageId);
      if (!confirm(`Delete "${page.name}" page?`)) return;
      
      pages = pages.filter(p => p.id !== pageId);
      
      // Switch to first page if current was deleted
      if (currentPageId === pageId) {
        switchToPage(pages[0].id);
      } else {
        renderPagesList();
      }
      
      updateNavbarLinks();
      updateStatus(`Deleted page: ${page.name}`);
    }
    
    // Update all navbars when pages change
    function updateNavbarLinks() {
      components.forEach(comp => {
        if (comp.type === 'navbar') {
          // Rebuild navbar HTML with current pages
          const links = pages.slice(0, 4).map(p => 
            `<a href="${p.slug}" style="color: var(--text-secondary); text-decoration: none;">${p.name}</a>`
          ).join('');
          
          const logoText = comp.data?.logo || 'Logo';
          comp.html = `<div style="display: flex; gap: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; align-items: center;">
            <span style="font-weight: 700;">${logoText}</span>
            ${links}
          </div>`;
          
          comp.element.querySelector('.component-content').innerHTML = comp.html;
        }
      });
    }
    
    // Get pages for navbar
    function getNavbarPagesHtml(logoText = 'Logo') {
      const links = pages.slice(0, 4).map(p => 
        `<a href="${p.slug}" style="color: var(--text-secondary); text-decoration: none;">${p.name}</a>`
      ).join('');
      
      return `<div style="display: flex; gap: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; align-items: center;">
        <span style="font-weight: 700;">${logoText}</span>
        ${links}
      </div>`;
    }

    // Component templates
    const componentTemplates = {
      hero: {
        name: 'Hero Section',
        icon: 'ü¶∏',
        html: `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 4rem 2rem; text-align: center; color: white; border-radius: 8px;">
          <h2 style="font-size: 2.5rem; margin: 0 0 1rem 0;">Welcome to Your Site</h2>
          <p style="font-size: 1.1rem; margin: 0;">Your value proposition goes here</p>
        </div>`
      },
      navbar: {
        name: 'Navigation Bar',
        icon: 'üîù',
        html: null,  // Will be generated dynamically from pages
        getHtml: (logoText = 'Logo') => {
          const links = pages.slice(0, 4).map(p => 
            `<a href="${p.slug}" style="color: var(--text-secondary); text-decoration: none;">${p.name}</a>`
          ).join('');
          return `<div style="display: flex; gap: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; align-items: center;">
            <span style="font-weight: 700;">${logoText}</span>
            ${links}
          </div>`;
        }
      },
      'header-logo': {
        name: 'Logo & Title',
        icon: 'üìç',
        html: `<div style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px;">
          <div style="font-size: 2.5rem; width: 60px; height: 60px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">‚ñØ</div>
          <div>
            <h1 style="margin: 0; font-size: 1.8rem; font-weight: 800;">Your Brand</h1>
            <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">Tagline goes here</p>
          </div>
        </div>`
      },
      features: {
        name: 'Features Grid',
        icon: '‚ú®',
        isFeatureGrid: true,
        getHtml: (data) => {
          const cards = data?.cards || [
            { icon: '‚ú®', title: 'Feature 1', description: 'Description goes here' },
            { icon: '‚ö°', title: 'Feature 2', description: 'Description goes here' },
            { icon: 'üöÄ', title: 'Feature 3', description: 'Description goes here' }
          ];
          return `<div class="feature-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
            ${cards.map((card, i) => `
              <div class="feature-card-item" data-card-index="${i}" style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                <div class="feature-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">${card.icon}</div>
                <h3 class="feature-title" style="margin: 0 0 0.5rem 0;">${card.title}</h3>
                <p class="feature-desc" style="margin: 0; color: var(--text-secondary);">${card.description}</p>
              </div>
            `).join('')}
          </div>`;
        }
      },
      'feature-card': {
        name: 'Feature Card',
        icon: '‚ú®',
        html: `<div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
          <div class="feature-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">‚ú®</div>
          <h3 class="feature-title" style="margin: 0 0 0.5rem 0;">Feature Title</h3>
          <p class="feature-desc" style="margin: 0; color: var(--text-secondary);">Description goes here</p>
        </div>`
      },
      testimonials: {
        name: 'Testimonials',
        icon: 'üí¨',
        html: `<div style="padding: 2rem; background: var(--bg-secondary); border-radius: 8px;">
          <p style="font-style: italic; margin: 0 0 1rem 0; color: var(--text-secondary);">"Great service! Highly recommended."</p>
          <p style="margin: 0; font-weight: 600;">‚Äî John Doe, CEO at TechCorp</p>
        </div>`
      },
      pricing: {
        name: 'Pricing Table',
        icon: 'üí∞',
        isPricingGrid: true,
        getHtml: (data) => {
          const cards = data?.cards || [
            { name: 'Basic', price: '$29', period: '/month', features: ['Feature 1', 'Feature 2'], highlighted: false },
            { name: 'Pro', price: '$99', period: '/month', features: ['All Basic features', 'Feature 3', 'Feature 4'], highlighted: true },
            { name: 'Enterprise', price: 'Custom', period: '', features: ['All Pro features', 'Dedicated support', 'Custom integrations'], highlighted: false }
          ];
          return `<div class="pricing-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
            ${cards.map((card, i) => `
              <div class="pricing-card-item" data-card-index="${i}" style="padding: 2rem; border: ${card.highlighted ? '2px solid var(--primary)' : '1px solid var(--border-color)'}; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; ${card.highlighted ? 'background: rgba(99, 102, 241, 0.05);' : ''}">
                <h3 style="margin: 0 0 0.5rem 0;">${card.name}</h3>
                <div style="font-size: 2.5rem; font-weight: 700; margin: 1rem 0;">${card.price}<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">${card.period}</span></div>
                <ul style="text-align: left; margin: 1rem 0; padding-left: 1.25rem; color: var(--text-secondary);">
                  ${card.features.map(f => `<li style="margin-bottom: 0.5rem;">${f}</li>`).join('')}
                </ul>
              </div>
            `).join('')}
          </div>`;
        }
      },
      team: {
        name: 'Team Members',
        icon: 'üë•',
        html: `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem;">
          <div style="text-align: center;">
            <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Sarah Johnson" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid var(--primary);">
            <h3 style="margin: 0 0 0.5rem 0;">Sarah Johnson</h3>
            <p style="margin: 0; color: var(--primary); font-weight: 500;">CEO & Founder</p>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.85rem;">10+ years in tech leadership</p>
          </div>
          <div style="text-align: center;">
            <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Mike Chen" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid var(--primary);">
            <h3 style="margin: 0 0 0.5rem 0;">Mike Chen</h3>
            <p style="margin: 0; color: var(--primary); font-weight: 500;">CTO</p>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.85rem;">Former Google engineer</p>
          </div>
          <div style="text-align: center;">
            <img src="https://randomuser.me/api/portraits/women/68.jpg" alt="Emily Davis" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid var(--primary);">
            <h3 style="margin: 0 0 0.5rem 0;">Emily Davis</h3>
            <p style="margin: 0; color: var(--primary); font-weight: 500;">Head of Design</p>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.85rem;">Award-winning UX designer</p>
          </div>
        </div>`
      },
      gallery: {
        name: 'Image Gallery',
        icon: 'üñºÔ∏è',
        html: `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
          <div style="aspect-ratio: 1; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem;">üì∑</div>
          <div style="aspect-ratio: 1; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem;">üñºÔ∏è</div>
          <div style="aspect-ratio: 1; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem;">üé®</div>
        </div>`
      },
      faq: {
        name: 'FAQ Section',
        icon: '‚ùì',
        html: `<div style="max-width: 600px;">
          <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0;">What is this?</h4>
            <p style="margin: 0; color: var(--text-secondary);">This is an example FAQ item. Click to expand for more details.</p>
          </div>
          <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px;">
            <h4 style="margin: 0 0 0.5rem 0;">How do I get started?</h4>
            <p style="margin: 0; color: var(--text-secondary);">Instructions for getting started will go here.</p>
          </div>
        </div>`
      },
      cta: {
        name: 'Call to Action',
        icon: 'üìû',
        isCTA: true,
        getHtml: (data) => {
          const contactType = data?.contactType || 'phone';
          let contactContent = '';
          
          if (contactType === 'phone') {
            const phone = data?.phoneNumber || '(555) 123-4567';
            contactContent = `
              <a href="tel:${phone.replace(/[^0-9+]/g, '')}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 2rem; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; font-size: 1.1rem;">
                üìû ${phone}
              </a>
            `;
          } else {
            const email = data?.email || 'contact@example.com';
            const subject = data?.emailSubject || 'Contact Request';
            contactContent = `
              <a href="mailto:${email}?subject=${encodeURIComponent(subject)}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 2rem; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; text-decoration: none;">
                ‚úâÔ∏è ${data?.buttonText || 'Send Us an Email'}
              </a>
            `;
          }
          
          return `<div style="background: linear-gradient(135deg, ${data?.gradientStart || '#667eea'} 0%, ${data?.gradientEnd || '#764ba2'} 100%); padding: 3rem 2rem; border-radius: 8px; text-align: center; color: white;">
          <h2 style="margin: 0 0 1rem 0;">${data?.title || 'Ready to get started?'}</h2>
          <p style="margin: 0 0 1.5rem 0; opacity: 0.9;">${data?.description || 'Contact us today!'}</p>
          ${contactContent}
        </div>`;
        }
      },
      card: {
        name: 'Card',
        icon: 'üÉè',
        isCard: true,
        cardTypes: {
          basic: {
            name: 'Basic Card',
            getHtml: (data) => `<div style="padding: 1.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
              <div style="margin-bottom: 1rem; background: var(--bg-secondary); border-radius: 6px; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem;">
                ${data?.icon || 'üñºÔ∏è'}
              </div>
              <h3 style="margin: 0 0 0.75rem 0;">${data?.title || 'Card Title'}</h3>
              <p style="margin: 0; color: var(--text-secondary);">${data?.description || 'Card content goes here'}</p>
            </div>`
          },
          feature: {
            name: 'Feature Card',
            getHtml: (data) => `<div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
              <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">${data?.icon || '‚ú®'}</div>
              <h3 style="margin: 0 0 0.5rem 0;">${data?.title || 'Feature Title'}</h3>
              <p style="margin: 0; color: var(--text-secondary);">${data?.description || 'Description goes here'}</p>
            </div>`
          },
          pricing: {
            name: 'Pricing Card',
            getHtml: (data) => `<div style="padding: 2rem; border: ${data?.highlighted ? '2px solid var(--primary)' : '1px solid var(--border-color)'}; border-radius: 8px; text-align: center; ${data?.highlighted ? 'background: rgba(99, 102, 241, 0.05);' : ''}">
              <h3 style="margin: 0 0 0.5rem 0;">${data?.title || 'Plan Name'}</h3>
              <div style="font-size: 2.5rem; font-weight: 700; margin: 1rem 0;">${data?.price || '$99'}<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">${data?.period || '/month'}</span></div>
              <p style="margin: 0; color: var(--text-secondary);">${data?.description || 'Plan description'}</p>
            </div>`
          },
          team: {
            name: 'Team Member',
            getHtml: (data) => `<div style="text-align: center; padding: 1.5rem;">
              <img src="${data?.image || 'https://randomuser.me/api/portraits/lego/1.jpg'}" alt="${data?.title || 'Team Member'}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid var(--primary);">
              <h3 style="margin: 0 0 0.5rem 0;">${data?.title || 'Team Member'}</h3>
              <p style="margin: 0; color: var(--primary); font-weight: 500;">${data?.subtitle || 'Role / Position'}</p>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.85rem;">${data?.description || 'Short bio here'}</p>
            </div>`
          },
          testimonial: {
            name: 'Testimonial',
            getHtml: (data) => `<div style="padding: 2rem; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--primary);">
              <p style="font-style: italic; margin: 0 0 1rem 0; color: var(--text-secondary); font-size: 1.1rem;">"${data?.description || 'Great service! Highly recommended.'}"</p>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <img src="${data?.image || 'https://randomuser.me/api/portraits/lego/2.jpg'}" alt="${data?.title}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                <div>
                  <p style="margin: 0; font-weight: 600;">${data?.title || 'Customer Name'}</p>
                  <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem;">${data?.subtitle || 'CEO at Company'}</p>
                </div>
              </div>
            </div>`
          },
          cta: {
            name: 'Call to Action',
            getHtml: (data) => {
              const contactType = data?.contactType || 'phone';
              let contactContent = '';
              
              if (contactType === 'phone') {
                const phone = data?.phoneNumber || '(555) 123-4567';
                contactContent = `
                  <a href="tel:${phone.replace(/[^0-9+]/g, '')}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 2rem; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; font-size: 1.1rem;">
                    üìû ${phone}
                  </a>
                `;
              } else {
                const email = data?.email || 'contact@example.com';
                const subject = data?.emailSubject || 'Contact Request';
                contactContent = `
                  <a href="mailto:${email}?subject=${encodeURIComponent(subject)}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 2rem; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; text-decoration: none;">
                    ‚úâÔ∏è ${data?.buttonText || 'Send Us an Email'}
                  </a>
                `;
              }
              
              return `<div style="background: linear-gradient(135deg, ${data?.gradientStart || '#667eea'} 0%, ${data?.gradientEnd || '#764ba2'} 100%); padding: 2.5rem 2rem; border-radius: 8px; text-align: center; color: white;">
              <h3 style="margin: 0 0 0.75rem 0; font-size: 1.5rem;">${data?.title || 'Ready to get started?'}</h3>
              <p style="margin: 0 0 1.5rem 0; opacity: 0.9;">${data?.description || 'Contact us today!'}</p>
              ${contactContent}
            </div>`;
            }
          }
        },
        getHtml: (data) => {
          const cardType = data?.cardType || 'basic';
          const template = componentTemplates.card.cardTypes[cardType];
          return template ? template.getHtml(data) : componentTemplates.card.cardTypes.basic.getHtml(data);
        }
      },
      footer: {
        name: 'Footer',
        icon: 'üîª',
        html: `<div style="padding: 2rem; text-align: center; border-top: 1px solid var(--border-color);">
          <p style="margin: 0; color: var(--text-secondary);">¬© 2025 Your Company. All rights reserved.</p>
        </div>`
      },
      newsletter: {
        name: 'Newsletter Signup',
        icon: 'üìß',
        html: `<div style="padding: 2rem; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <h3 style="margin: 0 0 1rem 0;">Subscribe to our newsletter</h3>
          <div style="display: flex; gap: 0.5rem;">
            <input type="email" placeholder="your@email.com" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary);">
            <button style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Subscribe</button>
          </div>
        </div>`
      }
    };

    // Drag handlers
    document.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('component-item')) {
        draggedComponent = e.target.dataset.component;
        e.dataTransfer.effectAllowed = 'copy';
      }
    });

    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      const dropZone = e.target.closest('.canvas-drop-zone');
      if (dropZone) {
        dropZone.classList.add('drag-over');
        e.dataTransfer.dropEffect = 'copy';
      }
    });

    document.addEventListener('dragleave', (e) => {
      const dropZone = e.target.closest('.canvas-drop-zone');
      if (dropZone) {
        dropZone.classList.remove('drag-over');
      }
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      const dropZone = e.target.closest('.canvas-drop-zone');
      if (dropZone && draggedComponent) {
        const section = dropZone.dataset.section;
        addComponentToCanvas(draggedComponent, section);
        draggedComponent = null;
        dropZone.classList.remove('drag-over');
      }
    });

    // Add component to canvas
    function addComponentToCanvas(componentType, section, customData = null) {
      const template = componentTemplates[componentType];
      if (!template) return;

      // Restrict Features to main section only
      if (componentType === 'features' && section !== 'main') {
        alert('‚ö†Ô∏è Features component can only be added to the Main Content section');
        return;
      }

      // Check if component of same type already exists in this section
      const existingComponent = components.find(c => c.section === section && c.type === componentType);
      if (existingComponent && !customData) {
        const confirmed = confirm(`A "${template.name}" already exists in the ${section} section.\n\nAdd another one?`);
        if (!confirmed) return;
      }

      const componentId = `comp-${componentIdCounter++}`;
      
      // Initialize data for feature grid
      let componentData = customData || {};
      if (template.isFeatureGrid && !componentData.cards) {
        componentData.cards = [
          { icon: '‚ú®', title: 'Feature 1', description: 'Description goes here' },
          { icon: '‚ö°', title: 'Feature 2', description: 'Description goes here' },
          { icon: 'üöÄ', title: 'Feature 3', description: 'Description goes here' }
        ];
        componentData.selectedCard = 0;
      }
      
      // Initialize data for pricing grid
      if (template.isPricingGrid && !componentData.cards) {
        componentData.cards = [
          { name: 'Basic', price: '$29', period: '/month', features: ['Feature 1', 'Feature 2'], highlighted: false },
          { name: 'Pro', price: '$99', period: '/month', features: ['All Basic features', 'Feature 3', 'Feature 4'], highlighted: true },
          { name: 'Enterprise', price: 'Custom', period: '', features: ['All Pro features', 'Dedicated support', 'Custom integrations'], highlighted: false }
        ];
        componentData.selectedCard = 0;
      }
      
      // Initialize data for card component
      if (template.isCard && !componentData.cardType) {
        componentData.cardType = 'basic';
        componentData.icon = 'üñºÔ∏è';
        componentData.title = 'Card Title';
        componentData.description = 'Card content goes here';
      }
      
      // Initialize data for CTA component
      if (template.isCTA && !componentData.contactType) {
        componentData.contactType = 'phone';
        componentData.phoneNumber = '(555) 123-4567';
        componentData.email = 'contact@example.com';
        componentData.emailSubject = 'Contact Request';
        componentData.buttonText = 'Send Us an Email';
        componentData.title = 'Ready to get started?';
        componentData.description = 'Contact us today!';
        componentData.gradientStart = '#667eea';
        componentData.gradientEnd = '#764ba2';
      }
      
      // Get HTML
      let html;
      if (template.getHtml) {
        html = template.getHtml(componentData);
      } else {
        html = template.html;
      }
      
      // Create component element with actual rendered HTML
      const componentEl = document.createElement('div');
      componentEl.className = 'canvas-component';
      componentEl.id = componentId;
      componentEl.tabIndex = 0;
      
      // Feature grid, pricing grid, card, and CTA use custom click handlers, not contenteditable
      const isEditable = !template.isFeatureGrid && !template.isPricingGrid && !template.isCard && !template.isCTA;
      componentEl.innerHTML = `
        <div class="component-content" ${isEditable ? 'contenteditable="true"' : ''}>${html}</div>
        <div class="component-overlay">
          <span class="component-label">${template.icon} ${template.name}</span>
          <button class="component-delete-btn" onclick="deleteComponent('${componentId}', event)">üóëÔ∏è</button>
        </div>
      `;
      // Use mousedown for selection (fires before focus changes for contenteditable)
      componentEl.addEventListener('mousedown', (e) => {
        if (!e.target.classList.contains('component-delete-btn')) {
          selectComponent(componentEl, componentType, template);
        }
      });
      
      // Save contenteditable changes
      const contentEl = componentEl.querySelector('.component-content');
      contentEl.addEventListener('blur', () => {
        const comp = components.find(c => c.id === componentId);
        if (comp) {
          comp.html = contentEl.innerHTML;
        }
      });
      contentEl.addEventListener('input', () => {
        const comp = components.find(c => c.id === componentId);
        if (comp) {
          comp.html = contentEl.innerHTML;
        }
      });
      
      // Only delete component if not editing text
      componentEl.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' && selectedComponent && selectedComponent.id === componentId) {
          // Check if we're in a contenteditable - if so, let it handle delete
          const activeEl = document.activeElement;
          if (activeEl && activeEl.getAttribute('contenteditable') === 'true') {
            return; // Let contenteditable handle the delete key
          }
          deleteComponent(componentId);
        }
      });

      // Get the container for this section
      const container = document.getElementById(`${section}-container`);
      const dropZone = container.querySelector('.canvas-drop-zone');
      
      // Insert before drop zone so it stays at the bottom
      container.insertBefore(componentEl, dropZone);
      dropZone.classList.add('has-items');

      // Track component
      components.push({
        id: componentId,
        type: componentType,
        section: section,
        element: componentEl,
        template: template,
        html: html,
        data: componentData
      });
      
      // Set up click handlers for feature grid cards
      if (template.isFeatureGrid) {
        setupFeatureGridClickHandlers(componentId);
      }
      
      // Set up click handlers for pricing grid cards
      if (template.isPricingGrid) {
        setupPricingGridClickHandlers(componentId);
      }
      
      // If navbar, create the linked pages automatically
      if (componentType === 'navbar') {
        createNavbarPages();
      }

      updateComponentCount();
      updateStatus(`Added ${template.name}`);
    }
    
    // Create pages for navbar links
    // When navbar is dropped, auto-create pages from its links
    function createNavbarPages() {
      const navPages = [
        { 
          id: 'home', 
          name: 'Home', 
          slug: 'index.html',
          defaultContent: {
            type: 'hero',
            section: 'main',
            html: componentTemplates.hero.html
          }
        },
        { 
          id: 'about', 
          name: 'About', 
          slug: 'about.html',
          defaultContent: {
            type: 'card',
            section: 'main',
            html: `<div style="padding: 1.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
              <h2 style="margin: 0 0 1rem 0;">About Us</h2>
              <p style="margin: 0; color: var(--text-secondary);">Tell your story here. Who are you? What do you do? Why should visitors care?</p>
            </div>`
          }
        },
        { 
          id: 'contact', 
          name: 'Contact', 
          slug: 'contact.html',
          defaultContent: {
            type: 'card',
            section: 'main',
            html: `<div style="padding: 1.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
              <h2 style="margin: 0 0 1rem 0;">Contact Us</h2>
              <p style="margin: 0 0 1rem 0; color: var(--text-secondary);">Get in touch with us.</p>
              <p style="margin: 0; color: var(--text-secondary);">Email: hello@example.com</p>
            </div>`
          }
        }
      ];
      
      let created = [];
      navPages.forEach(np => {
        if (!pages.find(p => p.id === np.id)) {
          // Create page with default MAIN content (using new state model)
          const pageMain = [];
          if (np.defaultContent) {
            pageMain.push({
              id: `comp-${np.id}-main`,
              type: np.defaultContent.type,
              section: np.defaultContent.section,
              html: np.defaultContent.html,
              data: {}
            });
          }
          // Pages now store 'main' array, not 'components'
          pages.push({ id: np.id, name: np.name, slug: np.slug, main: pageMain });
          created.push(np.name);
        }
      });
      
      // Also add default content to Home if it's empty
      const homePage = pages.find(p => p.id === 'home');
      if (homePage && (!homePage.main || homePage.main.length === 0)) {
        const homeDefault = navPages.find(p => p.id === 'home');
        if (homeDefault && homeDefault.defaultContent) {
          homePage.main = [{
            id: 'comp-home-main',
            type: homeDefault.defaultContent.type,
            section: homeDefault.defaultContent.section,
            html: homeDefault.defaultContent.html,
            data: {}
          }];
        }
      }
      
      if (created.length > 0) {
        renderPagesList();
        updateNavbarLinks();
        
        // If we're on home page and just added default content, render it directly
        // DON'T use switchToPage - it would save current empty state first!
        if (currentPageId === 'home') {
          const homePage = pages.find(p => p.id === 'home');
          const mainComponents = components.filter(c => c.section === 'main');
          
          // Only restore if main is currently empty but home has content
          if (mainComponents.length === 0 && homePage && homePage.main && homePage.main.length > 0) {
            homePage.main.forEach(compData => {
              const template = componentTemplates[compData.type];
              if (template) {
                restoreComponent(compData, template);
              }
            });
            updateComponentCount();
          }
        }
        
        updateStatus(`Created pages: ${created.join(', ')}`);
      }
    }

    // Select component
    function selectComponent(element, componentType, template) {
      // Remove previous selection
      document.querySelectorAll('.canvas-component.selected').forEach(el => {
        el.classList.remove('selected');
      });

      // Select new
      element.classList.add('selected');
      selectedComponent = {
        id: element.id,
        type: componentType,
        element: element,
        template: template
      };

      // Update active element in status bar
      updateActiveElement('component', template.name, template.icon);

      // Show properties
      showProperties(template);
    }

    // Show properties panel
    function showProperties(template) {
      const panel = document.getElementById('propertiesPanel');
      const type = selectedComponent?.type;
      const comp = components.find(c => c.id === selectedComponent?.id);
      
      // Special handling for feature grid - show card selector
      if (type === 'features' && comp?.data?.cards) {
        const cardIndex = comp.data.selectedCard || 0;
        showFeatureGridProperties(comp, cardIndex);
        setupFeatureGridClickHandlers(comp.id);
        return;
      }
      
      // Special handling for pricing grid - show card selector
      if (type === 'pricing' && comp?.data?.cards) {
        const cardIndex = comp.data.selectedCard || 0;
        showPricingGridProperties(comp, cardIndex);
        setupPricingGridClickHandlers(comp.id);
        return;
      }
      
      // Special handling for card component - show card type selector
      if (type === 'card' && comp?.data) {
        showCardProperties(comp);
        return;
      }
      
      // Special handling for CTA component
      if (type === 'cta' && comp?.data) {
        showCTAProperties(comp);
        return;
      }
      
      // Component-specific property panels
      const propertyPanels = {
        navbar: `
          <div class="properties-section">
            <h4>${template.icon} ${template.name}</h4>
            
            <div class="property">
              <label>Logo Text</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="Logo"
                   onblur="updateNavbar('logo', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.data?.logo) return c.data.logo;
                     if (c?.element) {
                       const span = c.element.querySelector('span[style*="font-weight: 700"]');
                       return span?.textContent || 'Logo';
                     }
                     return 'Logo';
                   })()}</div>
            </div>
            
            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 1rem;">
              üí° Links are automatically generated from your pages. Add or remove pages in the sidebar to update navigation.
            </p>
          </div>
        `,
        
        'header-logo': `
          <div class="properties-section">
            <h4>${template.icon} ${template.name}</h4>
            
            <div class="property">
              <label>Brand Name</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="Your Brand"
                   onblur="updateHeaderLogo('brandName', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.data?.brandName) return c.data.brandName;
                     if (c?.element) {
                       const h1 = c.element.querySelector('h1');
                       return h1?.textContent || 'Your Brand';
                     }
                     return 'Your Brand';
                   })()}</div>
            </div>
            
            <div class="property">
              <label>Tagline</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="Tagline goes here"
                   onblur="updateHeaderLogo('tagline', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.data?.tagline) return c.data.tagline;
                     if (c?.element) {
                       const p = c.element.querySelector('p');
                       return p?.textContent || 'Tagline goes here';
                     }
                     return 'Tagline goes here';
                   })()}</div>
            </div>
            
            <div class="property">
              <label>Logo Icon/Emoji</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="‚ñØ"
                   onblur="updateHeaderLogo('icon', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.data?.icon) return c.data.icon;
                     return '‚ñØ';
                   })()}</div>
            </div>
          </div>
        `,
        
        'feature-card': `
          <div class="properties-section">
            <h4>${template.icon} ${template.name}</h4>
            
            <div class="property">
              <label>Icon/Emoji</label>
              <input type="text" id="feature-icon" value="${(() => { const c = components.find(c => c.id === selectedComponent?.id); return c?.data?.icon || '‚ú®'; })()}" onchange="updateFeatureCard('icon', this.value)">
            </div>
            
            <div class="property">
              <label>Title</label>
              <input type="text" id="feature-title" value="${(() => { const c = components.find(c => c.id === selectedComponent?.id); return c?.data?.title || 'Feature Title'; })()}" onchange="updateFeatureCard('title', this.value)">
            </div>
            
            <div class="property">
              <label>Description</label>
              <textarea id="feature-desc" onchange="updateFeatureCard('description', this.value)">${(() => { const c = components.find(c => c.id === selectedComponent?.id); return c?.data?.description || 'Description goes here'; })()}</textarea>
            </div>
          </div>
        `,
        
        hero: `
          <div class="properties-section">
            <h4>${template.icon} ${template.name}</h4>
            
            <div class="property">
              <label>Headline</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="Welcome to Your Site"
                   onblur="updateHero('headline', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.element) {
                       const h2 = c.element.querySelector('h2');
                       return h2?.textContent || 'Welcome to Your Site';
                     }
                     return 'Welcome to Your Site';
                   })()}</div>
            </div>
            
            <div class="property">
              <label>Subheadline</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="Your value proposition goes here"
                   style="min-height: 80px;"
                   onblur="updateHero('subheadline', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.element) {
                       const p = c.element.querySelector('p');
                       return p?.textContent || 'Your value proposition goes here';
                     }
                     return 'Your value proposition goes here';
                   })()}</div>
            </div>
            
            <div class="property">
              <label>Gradient Start Color</label>
              <input type="color" value="#667eea" onchange="updateHero('gradientStart', this.value)">
            </div>
            
            <div class="property">
              <label>Gradient End Color</label>
              <input type="color" value="#764ba2" onchange="updateHero('gradientEnd', this.value)">
            </div>
          </div>
        `,
        
        card: `
          <div class="properties-section">
            <h4>${template.icon} ${template.name}</h4>
            
            <div class="property">
              <label>Card Title</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="Card Title"
                   onblur="updateCard('title', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.data?.title) return c.data.title;
                     if (c?.element) {
                       const h3 = c.element.querySelector('h3');
                       return h3?.textContent || 'Card Title';
                     }
                     return 'Card Title';
                   })()}</div>
            </div>
            
            <div class="property">
              <label>Card Content</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="Card content goes here"
                   style="min-height: 80px;"
                   onblur="updateCard('content', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.data?.content) return c.data.content;
                     if (c?.element) {
                       const p = c.element.querySelector('p');
                       return p?.textContent || 'Card content goes here';
                     }
                     return 'Card content goes here';
                   })()}</div>
            </div>
            
            <div class="property">
              <label>Media Icon/Emoji</label>
              <div class="editable-field" 
                   contenteditable="true" 
                   data-placeholder="üñºÔ∏è"
                   onblur="updateCard('icon', this.textContent.trim())">${(() => {
                     const c = components.find(c => c.id === selectedComponent?.id);
                     if (c?.data?.icon) return c.data.icon;
                     return 'üñºÔ∏è';
                   })()}</div>
            </div>
          </div>
        `,
        
        footer: `
          <div class="properties-section">
            <h4>${template.icon} ${template.name}</h4>
            
            <div class="property">
              <label>Copyright Text</label>
              <input type="text" value="¬© 2025 Your Company. All rights reserved." onchange="updateFooter('copyright', this.value)">
            </div>
          </div>
        `,
        
        cta: `
          <div class="properties-section">
            <h4>${template.icon} ${template.name}</h4>
            
            <div class="property">
              <label>Headline</label>
              <input type="text" value="Ready to get started?" onchange="updateCTA('headline', this.value)">
            </div>
            
            <div class="property">
              <label>Subtext</label>
              <input type="text" value="Join thousands of satisfied customers." onchange="updateCTA('subtext', this.value)">
            </div>
            
            <div class="property">
              <label>Button Text</label>
              <input type="text" value="Get Started ‚Üí" onchange="updateCTA('buttonText', this.value)">
            </div>
          </div>
        `
      };
      
      // Default panel for components without specific properties
      const defaultPanel = `
        <div class="properties-section">
          <h4>${template.icon} ${template.name}</h4>
          <p style="color: var(--text-secondary); font-size: 0.85rem;">
            This component uses default styling. Preview to see how it looks.
          </p>
        </div>
      `;

      // Build nested children section if any exist
      let nestedChildrenHtml = '';
      if (comp?.data?.nestedComponents && comp.data.nestedComponents.length > 0) {
        nestedChildrenHtml = `
          <div class="properties-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
            <h4>üì¶ Nested Elements</h4>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1rem;">Click to edit child components</p>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              ${comp.data.nestedComponents.map(nested => {
                const info = getNestedComponentInfo(nested.type);
                const displayName = nested.config?.title || nested.config?.headline || info.name;
                return `
                  <button class="btn btn-secondary" style="text-align: left; display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem;" 
                          onclick="showNestedComponentProperties('${nested.id}', '${nested.type}', '${comp.id}')">
                    <span style="font-size: 1.2rem;">${info.icon}</span>
                    <span style="flex: 1;">${displayName}</span>
                    <span style="opacity: 0.5;">‚Ä∫</span>
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      panel.innerHTML = `
        ${propertyPanels[type] || defaultPanel}
        ${nestedChildrenHtml}
        <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="deleteComponent('${selectedComponent.id}')">üóëÔ∏è Delete (or press Delete key)</button>
      `;
      
      // Focus the canvas so keyboard events work
      if (selectedComponent && selectedComponent.element) {
        selectedComponent.element.focus();
      }
    }
    
    // Get info about a nested component type
    function getNestedComponentInfo(wbType) {
      for (const cat of wbComponentsForContextMenu) {
        const found = cat.items.find(item => item.id === wbType);
        if (found) return found;
      }
      return { id: wbType, icon: 'üì¶', name: wbType };
    }
    
    // Update feature card properties
    function updateFeatureCard(property, value) {
      const comp = components.find(c => c.id === selectedComponent?.id);
      if (!comp) return;
      
      comp.data = comp.data || { icon: '‚ú®', title: 'Feature Title', description: 'Description goes here' };
      comp.data[property] = value;
      
      const newHtml = `<div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
        <div class="feature-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">${comp.data.icon}</div>
        <h3 class="feature-title" style="margin: 0 0 0.5rem 0;">${comp.data.title}</h3>
        <p class="feature-desc" style="margin: 0; color: var(--text-secondary);">${comp.data.description}</p>
      </div>`;
      
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated feature card ${property}`);
    }
    
    // Setup click handlers for individual cards in feature grid
    function setupFeatureGridClickHandlers(componentId) {
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      const cardItems = comp.element.querySelectorAll('.feature-card-item');
      cardItems.forEach((card, index) => {
        card.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // Remove highlight from all cards
          cardItems.forEach(c => c.style.borderColor = 'transparent');
          
          // Highlight selected card
          card.style.borderColor = 'var(--primary)';
          
          // Update selected card index
          comp.data.selectedCard = index;
          
          // Show properties for this card
          showFeatureGridProperties(comp, index);
        });
      });
      
      // Highlight first card by default when component is selected
      if (cardItems[0]) {
        cardItems[0].style.borderColor = 'var(--primary)';
      }
    }
    
    // Show properties panel for feature grid with specific card selected
    function showFeatureGridProperties(comp, cardIndex) {
      const card = comp.data.cards[cardIndex];
      const panel = document.getElementById('propertiesPanel');
      
      panel.innerHTML = `
        <div class="properties-section">
          <h4>‚ú® Features Grid</h4>
          
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            ${comp.data.cards.map((c, i) => `
              <button 
                onclick="selectFeatureCard('${comp.id}', ${i})" 
                style="flex: 1; padding: 0.5rem; border: 2px solid ${i === cardIndex ? 'var(--primary)' : 'var(--border-color)'}; background: ${i === cardIndex ? 'var(--primary)' : 'var(--bg-tertiary)'}; color: ${i === cardIndex ? 'white' : 'var(--text-primary)'}; border-radius: 4px; cursor: pointer; font-size: 1.2rem;">
                ${c.icon}
              </button>
            `).join('')}
          </div>
          
          <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1rem;">Editing Card ${cardIndex + 1} of 3</p>
          
          <div class="property">
            <label>Icon/Emoji</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="‚ú®"
                 onblur="updateFeatureGridCard('${comp.id}', ${cardIndex}, 'icon', this.textContent.trim())">${card.icon}</div>
          </div>
          
          <div class="property">
            <label>Title</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="Feature Title"
                 onblur="updateFeatureGridCard('${comp.id}', ${cardIndex}, 'title', this.textContent.trim())">${card.title}</div>
          </div>
          
          <div class="property">
            <label>Description</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="Description goes here"
                 style="min-height: 80px;"
                 onblur="updateFeatureGridCard('${comp.id}', ${cardIndex}, 'description', this.textContent.trim())">${card.description}</div>
          </div>
        </div>
        
        <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="deleteComponent('${comp.id}')">üóëÔ∏è Delete Features Grid</button>
      `;
    }
    
    // Select a specific card in the feature grid
    function selectFeatureCard(componentId, cardIndex) {
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      comp.data.selectedCard = cardIndex;
      
      // Update visual highlight
      const cardItems = comp.element.querySelectorAll('.feature-card-item');
      cardItems.forEach((card, i) => {
        card.style.borderColor = i === cardIndex ? 'var(--primary)' : 'transparent';
      });
      
      // Update properties panel
      showFeatureGridProperties(comp, cardIndex);
    }
    
    // Update a specific card in the feature grid
    function updateFeatureGridCard(componentId, cardIndex, property, value) {
      const comp = components.find(c => c.id === componentId);
      if (!comp || !comp.data.cards) return;
      
      // Update the card data
      comp.data.cards[cardIndex][property] = value;
      
      // Regenerate HTML
      const template = componentTemplates.features;
      const newHtml = template.getHtml(comp.data);
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      // Re-setup click handlers
      setupFeatureGridClickHandlers(componentId);
      
      // Re-highlight the selected card
      const cardItems = comp.element.querySelectorAll('.feature-card-item');
      if (cardItems[cardIndex]) {
        cardItems[cardIndex].style.borderColor = 'var(--primary)';
      }
      
      updateStatus(`Updated card ${cardIndex + 1} ${property}`);
    }
    
    // Setup click handlers for individual cards in pricing grid
    function setupPricingGridClickHandlers(componentId) {
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      const cardItems = comp.element.querySelectorAll('.pricing-card-item');
      cardItems.forEach((card, index) => {
        card.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // Update selected card index
          comp.data.selectedCard = index;
          
          // Show properties for this card
          showPricingGridProperties(comp, index);
        });
      });
    }
    
    // Show properties panel for pricing grid with specific card selected
    function showPricingGridProperties(comp, cardIndex) {
      const card = comp.data.cards[cardIndex];
      const panel = document.getElementById('propertiesPanel');
      
      panel.innerHTML = `
        <div class="properties-section">
          <h4>üí∞ Pricing Table</h4>
          
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            ${comp.data.cards.map((c, i) => `
              <button 
                onclick="selectPricingCard('${comp.id}', ${i})" 
                style="flex: 1; padding: 0.5rem; border: 2px solid ${i === cardIndex ? 'var(--primary)' : 'var(--border-color)'}; background: ${i === cardIndex ? 'var(--primary)' : 'var(--bg-tertiary)'}; color: ${i === cardIndex ? 'white' : 'var(--text-primary)'}; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                ${c.name}
              </button>
            `).join('')}
          </div>
          
          <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1rem;">Editing: ${card.name} Plan</p>
          
          <div class="property">
            <label>Plan Name</label>
            <input type="text" value="${card.name}" onchange="updatePricingGridCard('${comp.id}', ${cardIndex}, 'name', this.value)">
          </div>
          
          <div class="property">
            <label>Price</label>
            <input type="text" value="${card.price}" onchange="updatePricingGridCard('${comp.id}', ${cardIndex}, 'price', this.value)">
          </div>
          
          <div class="property">
            <label>Period (e.g. /month)</label>
            <input type="text" value="${card.period}" onchange="updatePricingGridCard('${comp.id}', ${cardIndex}, 'period', this.value)">
          </div>
          
          <div class="property">
            <label>Features (one per line)</label>
            <textarea rows="4" onchange="updatePricingGridCard('${comp.id}', ${cardIndex}, 'features', this.value.split('\\n').filter(f => f.trim()))">${card.features.join('\n')}</textarea>
          </div>
          
          <div class="property">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" ${card.highlighted ? 'checked' : ''} onchange="updatePricingGridCard('${comp.id}', ${cardIndex}, 'highlighted', this.checked)" style="width: auto;">
              Highlight this plan
            </label>
          </div>
        </div>
        
        <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="deleteComponent('${comp.id}')">üóëÔ∏è Delete Pricing Table</button>
      `;
    }
    
    // Select a specific card in the pricing grid
    function selectPricingCard(componentId, cardIndex) {
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      comp.data.selectedCard = cardIndex;
      
      // Update properties panel
      showPricingGridProperties(comp, cardIndex);
    }
    
    // Update a specific card in the pricing grid
    function updatePricingGridCard(componentId, cardIndex, property, value) {
      const comp = components.find(c => c.id === componentId);
      if (!comp || !comp.data.cards) return;
      
      // Update the card data
      comp.data.cards[cardIndex][property] = value;
      
      // Regenerate HTML
      const template = componentTemplates.pricing;
      const newHtml = template.getHtml(comp.data);
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      // Re-setup click handlers
      setupPricingGridClickHandlers(componentId);
      
      updateStatus(`Updated ${comp.data.cards[cardIndex].name} plan ${property}`);
    }
    
    // Show properties panel for card component
    function showCardProperties(comp) {
      const panel = document.getElementById('propertiesPanel');
      const cardTypes = componentTemplates.card.cardTypes;
      const currentType = comp.data.cardType || 'basic';
      
      // Build card type options
      const typeOptions = Object.entries(cardTypes).map(([key, val]) => 
        `<option value="${key}" ${key === currentType ? 'selected' : ''}>${val.name}</option>`
      ).join('');
      
      // Build type-specific fields
      let extraFields = '';
      
      switch (currentType) {
        case 'basic':
        case 'feature':
          extraFields = `
            <div class="property">
              <label>Icon/Emoji</label>
              <input type="text" value="${comp.data.icon || 'üñºÔ∏è'}" onchange="updateCard('${comp.id}', 'icon', this.value)">
            </div>
            <div class="property">
              <label>Title</label>
              <input type="text" value="${comp.data.title || ''}" onchange="updateCard('${comp.id}', 'title', this.value)">
            </div>
            <div class="property">
              <label>Description</label>
              <textarea onchange="updateCard('${comp.id}', 'description', this.value)">${comp.data.description || ''}</textarea>
            </div>
          `;
          break;
          
        case 'pricing':
          extraFields = `
            <div class="property">
              <label>Plan Name</label>
              <input type="text" value="${comp.data.title || 'Plan Name'}" onchange="updateCard('${comp.id}', 'title', this.value)">
            </div>
            <div class="property">
              <label>Price</label>
              <input type="text" value="${comp.data.price || '$99'}" onchange="updateCard('${comp.id}', 'price', this.value)">
            </div>
            <div class="property">
              <label>Period</label>
              <input type="text" value="${comp.data.period || '/month'}" onchange="updateCard('${comp.id}', 'period', this.value)">
            </div>
            <div class="property">
              <label>Description</label>
              <textarea onchange="updateCard('${comp.id}', 'description', this.value)">${comp.data.description || ''}</textarea>
            </div>
            <div class="property">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" ${comp.data.highlighted ? 'checked' : ''} onchange="updateCard('${comp.id}', 'highlighted', this.checked)" style="width: auto;">
                Highlight this card
              </label>
            </div>
          `;
          break;
          
        case 'team':
          extraFields = `
            <div class="property">
              <label>Image URL</label>
              <input type="text" value="${comp.data.image || ''}" onchange="updateCard('${comp.id}', 'image', this.value)" placeholder="https://...">
            </div>
            <div class="property">
              <label>Name</label>
              <input type="text" value="${comp.data.title || ''}" onchange="updateCard('${comp.id}', 'title', this.value)">
            </div>
            <div class="property">
              <label>Role / Position</label>
              <input type="text" value="${comp.data.subtitle || ''}" onchange="updateCard('${comp.id}', 'subtitle', this.value)">
            </div>
            <div class="property">
              <label>Bio</label>
              <textarea onchange="updateCard('${comp.id}', 'description', this.value)">${comp.data.description || ''}</textarea>
            </div>
          `;
          break;
          
        case 'testimonial':
          extraFields = `
            <div class="property">
              <label>Quote</label>
              <textarea rows="3" onchange="updateCard('${comp.id}', 'description', this.value)">${comp.data.description || ''}</textarea>
            </div>
            <div class="property">
              <label>Image URL</label>
              <input type="text" value="${comp.data.image || ''}" onchange="updateCard('${comp.id}', 'image', this.value)" placeholder="https://...">
            </div>
            <div class="property">
              <label>Name</label>
              <input type="text" value="${comp.data.title || ''}" onchange="updateCard('${comp.id}', 'title', this.value)">
            </div>
            <div class="property">
              <label>Title / Company</label>
              <input type="text" value="${comp.data.subtitle || ''}" onchange="updateCard('${comp.id}', 'subtitle', this.value)">
            </div>
          `;
          break;
          
        case 'cta':
          const ctaContactType = comp.data.contactType || 'phone';
          extraFields = `
            <div class="property">
              <label>Headline</label>
              <input type="text" value="${comp.data.title || 'Ready to get started?'}" onchange="updateCard('${comp.id}', 'title', this.value)">
            </div>
            <div class="property">
              <label>Description</label>
              <textarea onchange="updateCard('${comp.id}', 'description', this.value)">${comp.data.description || 'Contact us today!'}</textarea>
            </div>
            <div class="property">
              <label>Contact Type</label>
              <select onchange="updateCard('${comp.id}', 'contactType', this.value); showCardProperties(components.find(c => c.id === '${comp.id}'))">
                <option value="phone" ${ctaContactType === 'phone' ? 'selected' : ''}>üìû Phone Number</option>
                <option value="email" ${ctaContactType === 'email' ? 'selected' : ''}>‚úâÔ∏è Email Form</option>
              </select>
            </div>
            ${ctaContactType === 'phone' ? `
              <div class="property">
                <label>Phone Number</label>
                <input type="tel" value="${comp.data.phoneNumber || '(555) 123-4567'}" onchange="updateCard('${comp.id}', 'phoneNumber', this.value)" placeholder="(555) 123-4567">
              </div>
            ` : `
              <div class="property">
                <label>Email Address</label>
                <input type="email" value="${comp.data.email || 'contact@example.com'}" onchange="updateCard('${comp.id}', 'email', this.value)" placeholder="contact@example.com">
              </div>
              <div class="property">
                <label>Email Subject</label>
                <input type="text" value="${comp.data.emailSubject || 'Contact Request'}" onchange="updateCard('${comp.id}', 'emailSubject', this.value)">
              </div>
              <div class="property">
                <label>Button Text</label>
                <input type="text" value="${comp.data.buttonText || 'Send Us an Email'}" onchange="updateCard('${comp.id}', 'buttonText', this.value)">
              </div>
            `}
            <div class="property">
              <label>Gradient Start</label>
              <input type="color" value="${comp.data.gradientStart || '#667eea'}" onchange="updateCard('${comp.id}', 'gradientStart', this.value)">
            </div>
            <div class="property">
              <label>Gradient End</label>
              <input type="color" value="${comp.data.gradientEnd || '#764ba2'}" onchange="updateCard('${comp.id}', 'gradientEnd', this.value)">
            </div>
          `;
          break;
      }
      
      panel.innerHTML = `
        <div class="properties-section">
          <h4>üÉè Card</h4>
          
          <div class="property">
            <label>Card Type</label>
            <select onchange="updateCardType('${comp.id}', this.value)">
              ${typeOptions}
            </select>
          </div>
          
          ${extraFields}
        </div>
        
        <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="deleteComponent('${comp.id}')">üóëÔ∏è Delete Card</button>
      `;
    }
    
    // Update card type (changes the entire card template)
    function updateCardType(componentId, newType) {
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      // Preserve some common data
      const oldData = { ...comp.data };
      
      // Set new type and reset type-specific defaults
      comp.data.cardType = newType;
      
      // Set sensible defaults based on new type
      switch (newType) {
        case 'basic':
          comp.data.icon = oldData.icon || 'üñºÔ∏è';
          comp.data.title = oldData.title || 'Card Title';
          comp.data.description = oldData.description || 'Card content goes here';
          break;
        case 'feature':
          comp.data.icon = oldData.icon || '‚ú®';
          comp.data.title = oldData.title || 'Feature Title';
          comp.data.description = oldData.description || 'Description goes here';
          break;
        case 'pricing':
          comp.data.title = oldData.title || 'Plan Name';
          comp.data.price = oldData.price || '$99';
          comp.data.period = oldData.period || '/month';
          comp.data.description = oldData.description || 'Plan description';
          comp.data.highlighted = oldData.highlighted || false;
          break;
        case 'team':
          comp.data.image = oldData.image || 'https://randomuser.me/api/portraits/lego/1.jpg';
          comp.data.title = oldData.title || 'Team Member';
          comp.data.subtitle = oldData.subtitle || 'Role / Position';
          comp.data.description = oldData.description || 'Short bio here';
          break;
        case 'testimonial':
          comp.data.image = oldData.image || 'https://randomuser.me/api/portraits/lego/2.jpg';
          comp.data.title = oldData.title || 'Customer Name';
          comp.data.subtitle = oldData.subtitle || 'CEO at Company';
          comp.data.description = oldData.description || 'Great service! Highly recommended.';
          break;
        case 'cta':
          comp.data.title = oldData.title || 'Ready to get started?';
          comp.data.description = oldData.description || 'Contact us today!';
          comp.data.contactType = oldData.contactType || 'phone';
          comp.data.phoneNumber = oldData.phoneNumber || '(555) 123-4567';
          comp.data.email = oldData.email || 'contact@example.com';
          comp.data.emailSubject = oldData.emailSubject || 'Contact Request';
          comp.data.buttonText = oldData.buttonText || 'Send Us an Email';
          comp.data.gradientStart = oldData.gradientStart || '#667eea';
          comp.data.gradientEnd = oldData.gradientEnd || '#764ba2';
          break;
      }
      
      // Regenerate HTML
      const newHtml = componentTemplates.card.getHtml(comp.data);
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      // Refresh properties panel with new type's fields
      showCardProperties(comp);
      
      updateStatus(`Changed card type to ${componentTemplates.card.cardTypes[newType].name}`);
    }
    
    // Update a single card property
    function updateCard(componentId, property, value) {
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      comp.data[property] = value;
      
      // Regenerate HTML
      const newHtml = componentTemplates.card.getHtml(comp.data);
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated card ${property}`);
    }
    
    // Show properties panel for CTA component
    function showCTAProperties(comp) {
      const panel = document.getElementById('propertiesPanel');
      const contactType = comp.data.contactType || 'phone';
      
      let contactFields = '';
      if (contactType === 'phone') {
        contactFields = `
          <div class="property">
            <label>Phone Number</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="(555) 123-4567"
                 onblur="updateCTA('${comp.id}', 'phoneNumber', this.textContent.trim())">${comp.data.phoneNumber || '(555) 123-4567'}</div>
          </div>
        `;
      } else {
        contactFields = `
          <div class="property">
            <label>Email Address</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="contact@example.com"
                 onblur="updateCTA('${comp.id}', 'email', this.textContent.trim())">${comp.data.email || 'contact@example.com'}</div>
          </div>
          <div class="property">
            <label>Email Subject</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="Contact Request"
                 onblur="updateCTA('${comp.id}', 'emailSubject', this.textContent.trim())">${comp.data.emailSubject || 'Contact Request'}</div>
          </div>
          <div class="property">
            <label>Button Text</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="Send Us an Email"
                 onblur="updateCTA('${comp.id}', 'buttonText', this.textContent.trim())">${comp.data.buttonText || 'Send Us an Email'}</div>
          </div>
        `;
      }
      
      panel.innerHTML = `
        <div class="properties-section">
          <h4>üìû Call to Action</h4>
          
          <div class="property">
            <label>Headline</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="Ready to get started?"
                 onblur="updateCTA('${comp.id}', 'title', this.textContent.trim())">${comp.data.title || 'Ready to get started?'}</div>
          </div>
          
          <div class="property">
            <label>Description</label>
            <div class="editable-field" 
                 contenteditable="true" 
                 data-placeholder="Contact us today!"
                 style="min-height: 80px;"
                 onblur="updateCTA('${comp.id}', 'description', this.textContent.trim())">${comp.data.description || 'Contact us today!'}</div>
          </div>
          
          <div class="property">
            <label>Contact Type</label>
            <select onchange="updateCTA('${comp.id}', 'contactType', this.value); showCTAProperties(components.find(c => c.id === '${comp.id}'))">
              <option value="phone" ${contactType === 'phone' ? 'selected' : ''}>üìû Phone Number</option>
              <option value="email" ${contactType === 'email' ? 'selected' : ''}>‚úâÔ∏è Email Form</option>
            </select>
          </div>
          
          ${contactFields}
          
          <div class="property">
            <label>Gradient Start</label>
            <input type="color" value="${comp.data.gradientStart || '#667eea'}" onchange="updateCTA('${comp.id}', 'gradientStart', this.value)">
          </div>
          
          <div class="property">
            <label>Gradient End</label>
            <input type="color" value="${comp.data.gradientEnd || '#764ba2'}" onchange="updateCTA('${comp.id}', 'gradientEnd', this.value)">
          </div>
        </div>
        
        <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="deleteComponent('${comp.id}')">üóëÔ∏è Delete CTA</button>
      `;
    }
    
    // Update CTA property
    function updateCTA(componentId, property, value) {
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      comp.data[property] = value;
      
      // Regenerate HTML
      const newHtml = componentTemplates.cta.getHtml(comp.data);
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated CTA ${property}`);
    }
    
    // Update navbar properties
    function updateNavbar(property, value) {
      const comp = components.find(c => c.id === selectedComponent?.id);
      if (!comp) return;
      
      comp.data = comp.data || { logo: 'Logo' };
      comp.data[property] = value;
      
      // Rebuild navbar with updated logo and current pages
      const links = pages.slice(0, 4).map(p => 
        `<a href="${p.slug}" style="color: var(--text-secondary); text-decoration: none;">${p.name}</a>`
      ).join('');
      
      comp.html = `<div style="display: flex; gap: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; align-items: center;">
        <span style="font-weight: 700;">${comp.data.logo}</span>
        ${links}
      </div>`;
      
      comp.element.querySelector('.component-content').innerHTML = comp.html;
      updateStatus(`Updated navbar ${property}`);
    }
    
    // Update header-logo properties
    function updateHeaderLogo(property, value) {
      const comp = components.find(c => c.id === selectedComponent?.id);
      if (!comp) return;
      
      comp.data = comp.data || { brandName: 'Your Brand', tagline: 'Tagline goes here', icon: '‚ñØ' };
      comp.data[property] = value;
      
      const newHtml = `<div style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-size: 2.5rem; width: 60px; height: 60px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">${comp.data.icon}</div>
        <div>
          <h1 style="margin: 0; font-size: 1.8rem; font-weight: 800;">${comp.data.brandName}</h1>
          <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">${comp.data.tagline}</p>
        </div>
      </div>`;
      
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated header ${property}`);
    }
    
    // Update hero properties
    function updateHero(property, value) {
      const comp = components.find(c => c.id === selectedComponent?.id);
      if (!comp) return;
      
      comp.data = comp.data || { headline: 'Welcome to Your Site', subheadline: 'Your value proposition goes here', gradientStart: '#667eea', gradientEnd: '#764ba2' };
      comp.data[property] = value;
      
      const newHtml = `<div style="background: linear-gradient(135deg, ${comp.data.gradientStart} 0%, ${comp.data.gradientEnd} 100%); padding: 4rem 2rem; text-align: center; color: white; border-radius: 8px;">
        <h2 style="font-size: 2.5rem; margin: 0 0 1rem 0;">${comp.data.headline}</h2>
        <p style="font-size: 1.1rem; margin: 0;">${comp.data.subheadline}</p>
      </div>`;
      
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated hero ${property}`);
    }
    
    // Update card properties
    function updateCard(property, value) {
      const comp = components.find(c => c.id === selectedComponent?.id);
      if (!comp) return;
      
      comp.data = comp.data || { title: 'Card Title', content: 'Card content goes here', icon: 'üñºÔ∏è' };
      comp.data[property] = value;
      
      const newHtml = `<div style="padding: 1.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
        <div style="margin-bottom: 1rem; background: var(--bg-secondary); border-radius: 6px; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 3rem;">
          ${comp.data.icon}
        </div>
        <h3 style="margin: 0 0 0.75rem 0;">${comp.data.title}</h3>
        <p style="margin: 0; color: var(--text-secondary);">${comp.data.content}</p>
      </div>`;
      
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated card ${property}`);
    }
    
    // Update footer properties
    function updateFooter(property, value) {
      const comp = components.find(c => c.id === selectedComponent?.id);
      if (!comp) return;
      
      comp.data = comp.data || { copyright: '¬© 2025 Your Company. All rights reserved.' };
      comp.data[property] = value;
      
      const newHtml = `<div style="padding: 2rem; text-align: center; border-top: 1px solid var(--border-color);">
        <p style="margin: 0; color: var(--text-secondary);">${comp.data.copyright}</p>
      </div>`;
      
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated footer ${property}`);
    }
    
    // Update CTA properties
    function updateCTA(property, value) {
      const comp = components.find(c => c.id === selectedComponent?.id);
      if (!comp) return;
      
      comp.data = comp.data || { headline: 'Ready to get started?', subtext: 'Join thousands of satisfied customers.', buttonText: 'Get Started ‚Üí' };
      comp.data[property] = value;
      
      const newHtml = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem 2rem; border-radius: 8px; text-align: center; color: white;">
        <h2 style="margin: 0 0 1rem 0;">${comp.data.headline}</h2>
        <p style="margin: 0 0 1.5rem 0; font-size: 1.1rem;">${comp.data.subtext}</p>
        <button style="padding: 0.75rem 2rem; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">${comp.data.buttonText}</button>
      </div>`;
      
      comp.html = newHtml;
      comp.element.querySelector('.component-content').innerHTML = newHtml;
      
      updateStatus(`Updated CTA ${property}`);
    }

    // Update card media
    function updateCardMedia(property, value) {
      if (!selectedComponent || selectedComponent.type !== 'card') return;
      
      const el = selectedComponent.element;
      const mediaDiv = el.querySelector('div > div');
      
      if (!mediaDiv) return;

      if (property === 'type') {
        selectedComponent.mediaType = value;
        if (value === 'image') {
          mediaDiv.innerHTML = `<img src="${selectedComponent.imageUrl || 'https://via.placeholder.com/400x300?text=Card+Image'}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;" alt="${selectedComponent.altText || 'Card image'}">`;
        } else if (value === 'video') {
          mediaDiv.innerHTML = `<iframe width="100%" height="100%" src="${selectedComponent.videoUrl || ''}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="border-radius: 6px;"></iframe>`;
        } else if (value === 'figure') {
          mediaDiv.innerHTML = `<div style="font-size: 4rem;">${selectedComponent.altText || 'üé®'}</div>`;
        }
        updateStatus(`Updated card media type`);
      } else if (property === 'imageUrl') {
        selectedComponent.imageUrl = value;
        if (selectedComponent.mediaType === 'image' || !selectedComponent.mediaType) {
          mediaDiv.innerHTML = `<img src="${value || 'https://via.placeholder.com/400x300?text=Card+Image'}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;" alt="${selectedComponent.altText || 'Card image'}">`;
        }
        updateStatus(`Updated card image URL`);
      } else if (property === 'videoUrl') {
        selectedComponent.videoUrl = value;
        if (selectedComponent.mediaType === 'video') {
          mediaDiv.innerHTML = `<iframe width="100%" height="100%" src="${value}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="border-radius: 6px;"></iframe>`;
        }
        updateStatus(`Updated card video URL`);
      } else if (property === 'altText') {
        selectedComponent.altText = value;
        if (selectedComponent.mediaType === 'figure' || !selectedComponent.mediaType) {
          mediaDiv.innerHTML = `<div style="font-size: 4rem;">${value || 'üé®'}</div>`;
        }
        updateStatus(`Updated card figure/icon`);
      }
    }

    // Update component property
    function updateComponentProperty(property, value) {
      if (!selectedComponent) return;
      
      const el = selectedComponent.element;
      
      switch (property) {
        case 'bgColor':
          el.style.backgroundColor = value;
          break;
        case 'textColor':
          el.style.color = value;
          break;
        case 'padding':
          el.style.padding = value;
          break;
      }
      
      updateStatus(`Updated ${property}`);
    }

    // Delete component
    function deleteComponent(id, event) {
      if (event) event.stopPropagation();
      
      const component = components.find(c => c.id === id);
      if (component) {
        // If deleting navbar, ask about pages
        if (component.type === 'navbar') {
          const navbarPages = pages.filter(p => p.id === 'about' || p.id === 'contact');
          if (navbarPages.length > 0) {
            const deletePages = confirm(
              `Delete the Navigation Bar?\n\nAlso delete the linked pages (${navbarPages.map(p => p.name).join(', ')})?\n\nClick OK to delete navbar AND pages\nClick Cancel to delete navbar only`
            );
            
            if (deletePages) {
              // Remove the pages
              pages = pages.filter(p => p.id !== 'about' && p.id !== 'contact');
              
              // If current page was deleted, switch to home
              if (currentPageId === 'about' || currentPageId === 'contact') {
                switchToPage('home');
              }
              renderPagesList();
            }
          }
        }
        
        component.element.remove();
        components = components.filter(c => c.id !== id);
        selectedComponent = null;
        document.getElementById('propertiesPanel').innerHTML = 
          `<div class="properties-empty">Click a component to edit its properties</div>`;
        updateComponentCount();
        updateStatus('Component deleted');
      }
    }

    // Update component count
    function updateComponentCount() {
      document.getElementById('componentCount').textContent = 
        `${components.length} component${components.length !== 1 ? 's' : ''}`;
    }

    // Update status
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }
    
    // Update active element in status bar
    function updateActiveElement(type, name, icon) {
      const el = document.getElementById('activeElement');
      if (type === 'page') {
        // Get the page to show relative URL
        const page = pages.find(p => p.name === name);
        const relUrl = page ? getRelativeUrl(page.slug) : '/';
        el.innerHTML = `<span style="color: #10b981;"><strong>üìÑ Page:</strong> ${name} <code style="background: rgba(99, 102, 241, 0.2); padding: 0.15rem 0.4rem; border-radius: 3px; font-family: monospace; font-size: 0.8rem; margin-left: 0.5rem;">${relUrl}</code></span>`;
      } else if (type === 'component') {
        el.innerHTML = `<span style="color: var(--primary);"><strong>${icon}</strong> ${name}</span>`;
      }
    }
    
    // Convert slug to relative URL format
    function getRelativeUrl(slug) {
      if (!slug) return '/';
      if (slug === 'index.html') return '/';
      // Remove .html extension and prepend /
      return '/' + slug.replace(/\.html$/, '');
    }
    
    // Update template indicator in status bar
    function setTemplateIndicator(templateName) {
      const el = document.getElementById('templateIndicator');
      if (!el) return;
      if (templateName) {
        el.innerHTML = `<span style="color: var(--primary); font-size: 0.85rem;">üé® Template: ${templateName}</span>`;
        el.style.display = 'inline';
      } else {
        el.style.display = 'none';
      }
    }

    // Save site - save current page's MAIN content and global sections
    function saveSite() {
      // Save current page's MAIN content only
      const currentPage = getCurrentPage();
      if (currentPage) {
        currentPage.main = components
          .filter(c => c.section === 'main')
          .map(c => ({
            id: c.id,
            type: c.type,
            section: c.section,
            html: c.html,
            data: c.data
          }));
      }
      
      // Save global header/footer
      globalSections.header = components
        .filter(c => c.section === 'header')
        .map(c => ({
          id: c.id,
          type: c.type,
          section: c.section,
          html: c.html,
          data: c.data
        }));
      globalSections.footer = components
        .filter(c => c.section === 'footer')
        .map(c => ({
          id: c.id,
          type: c.type,
          section: c.section,
          html: c.html,
          data: c.data
        }));
      
      // New state model: global sections + pages with main content only
      const siteData = {
        title: 'My Website',
        global: globalSections,
        pages: pages
      };
      
      console.log('Saving site (shared header/footer model):', siteData);
      updateStatus('‚úÖ Site saved!');
      alert('Site saved! (Check console for data)');
    }

    // Preview site - Generate HTML and open in new window
    // Uses SHARED header/footer across all pages!
    function previewSite() {
      // Save current page's MAIN content first
      const currentPage = getCurrentPage();
      if (currentPage) {
        currentPage.main = components
          .filter(c => c.section === 'main')
          .map(c => ({
            id: c.id,
            type: c.type,
            section: c.section,
            html: c.html,
            data: c.data
          }));
      }
      
      // Check if there's a navbar in the header
      const hasNavbar = components.some(c => c.section === 'header' && c.type === 'navbar');
      
      // Generate GLOBAL header HTML (shared across all pages)
      // Convert navbar links to hash-routing for preview
      let globalHeaderHTML = components
        .filter(c => c.section === 'header')
        .map(c => {
          let html = c.html || componentTemplates[c.type]?.html || '';
          // Convert navbar links to hash routing
          if (c.type === 'navbar') {
            pages.forEach(p => {
              // Replace href="page.html" with onclick handler for hash routing
              html = html.replace(
                new RegExp(`href="${p.slug}"`, 'g'),
                `href="#${p.id}" onclick="showPage('${p.id}'); return false;"`
              );
            });
          }
          return html;
        })
        .join('');
      
      // Generate GLOBAL footer HTML (shared across all pages)
      const globalFooterHTML = components
        .filter(c => c.section === 'footer')
        .map(c => c.html || componentTemplates[c.type]?.html || '')
        .join('');
      
      // Generate MAIN HTML for a specific page
      function generatePageMainHtml(page) {
        return (page.main || []).map(c => c.html || '').join('');
      }
      
      // Build navigation tabs for preview (only if no navbar exists)
      const navTabs = hasNavbar ? '' : pages.map(p => 
        `<button onclick="showPage('${p.id}')" class="nav-tab" data-page="${p.id}">${p.name}</button>`
      ).join('');
      
      // Build page content sections
      const pageContents = pages.map(p => {
        const mainHTML = generatePageMainHtml(p);
        return `
          <div class="page-content" id="page-${p.id}" style="display: ${p.id === currentPageId ? 'block' : 'none'};">
            ${mainHTML || '<p style="padding: 1rem; color: #888;">No main content - drop components here in the builder</p>'}
          </div>
        `;
      }).join('');

      // Create full HTML preview
      const previewHTML = `
        <!DOCTYPE html>
        <html lang="en" data-theme="dark">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>My Website Preview</title>
          <link rel="stylesheet" href="${window.location.origin}/src/styles/themes.css">
          <link rel="stylesheet" href="${window.location.origin}/src/styles/site.css">
          <link rel="stylesheet" href="${window.location.origin}/src/styles/builder.css">
          <link rel="preconnect" href="https://fonts.googleapis.com">
          <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
          <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
          <style>
            :root {
              --bg-color: #0f172a;
              --bg-secondary: #1e293b;
              --bg-tertiary: #334155;
              --text-primary: #f1f5f9;
              --text-secondary: #94a3b8;
              --border-color: #334155;
              --primary: #6366f1;
            }
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { 
              font-family: 'Inter', sans-serif; 
              background: var(--bg-color); 
              color: var(--text-primary);
              min-height: 100vh;
              display: flex;
              flex-direction: column;
            }
            header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
            main { max-width: 1200px; margin: 0 auto; padding: 2rem; min-height: 400px; }
            footer { background: var(--bg-secondary); border-top: 1px solid var(--border-color); margin-top: 3rem; }
            
            /* Navigation */
            .site-nav { display: flex; gap: 1rem; padding: 1rem 2rem; align-items: center; }
            .site-nav .brand { font-weight: 700; font-size: 1.2rem; margin-right: auto; }
            .nav-link { 
              color: var(--text-secondary); 
              text-decoration: none; 
              padding: 0.5rem 1rem;
              border-radius: 6px;
              transition: all 0.2s;
            }
            .nav-link:hover, .nav-link.active { 
              color: var(--text-primary); 
              background: var(--bg-tertiary); 
            }
            
            /* Pages */
            .page { display: none; }
            .page.active { display: block; }
          </style>
        </head>
        <body>
          ${hasNavbar ? '' : `<div class="preview-bar">
            <span>üëÅÔ∏è Preview Mode</span>
            ${navTabs}
          </div>`}
          
          ${globalHeaderHTML ? `<header>${globalHeaderHTML}</header>` : ''}
          
          <main>
            ${pageContents}
          </main>
          
          ${globalFooterHTML ? `<footer>${globalFooterHTML}</footer>` : ''}
          
          <script>
            function showPage(pageId) {
              document.querySelectorAll('.page-content').forEach(el => el.style.display = 'none');
              document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
              document.getElementById('page-' + pageId).style.display = 'block';
              const tab = document.querySelector('[data-page="' + pageId + '"]');
              if (tab) tab.classList.add('active');
            }
            // Set initial active tab
            document.querySelector('[data-page="${currentPageId}"]')?.classList.add('active');
          </script>
        </body>
        </html>`;
      
      // Open in new window
      const previewWindow = window.open('', 'preview', 'width=1200,height=800');
      previewWindow.document.write(previewHTML);
      previewWindow.document.close();
      updateStatus('‚úÖ Preview opened in new window');
    }

    // === EXPORT FUNCTIONALITY ===
    
    // Show export menu dropdown
    function showExportMenu(event) {
      event.stopPropagation();
      
      // Remove existing menu
      document.getElementById('exportMenu')?.remove();
      
      const menu = document.createElement('div');
      menu.id = 'exportMenu';
      menu.style.cssText = `
        position: fixed;
        top: ${event.target.getBoundingClientRect().bottom + 5}px;
        right: 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
        min-width: 220px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 10000;
      `;
      
      menu.innerHTML = `
        <div style="padding: 0.5rem; font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 700;">Export Options</div>
        <button onclick="exportAsSPA()" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem; background: none; border: none; color: var(--text-primary); cursor: pointer; border-radius: 6px; text-align: left; font-size: 0.9rem;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='none'">
          <span style="font-size: 1.2rem;">üìÑ</span>
          <div>
            <div style="font-weight: 600;">Single Page (SPA)</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);">One HTML file, hash routing</div>
          </div>
        </button>
        <button onclick="exportAsMPA()" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem; background: none; border: none; color: var(--text-primary); cursor: pointer; border-radius: 6px; text-align: left; font-size: 0.9rem;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='none'">
          <span style="font-size: 1.2rem;">üìÅ</span>
          <div>
            <div style="font-weight: 600;">Multi-Page (MPA)</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);">Separate HTML files</div>
          </div>
        </button>
        <button onclick="exportAsJSON()" style="display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem; background: none; border: none; color: var(--text-primary); cursor: pointer; border-radius: 6px; text-align: left; font-size: 0.9rem;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='none'">
          <span style="font-size: 1.2rem;">üíæ</span>
          <div>
            <div style="font-weight: 600;">Project JSON</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);">Import later to continue editing</div>
          </div>
        </button>
      `;
      
      document.body.appendChild(menu);
      
      // Close on outside click
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 10);
    }
    
    // Export as Single Page Application (SPA) with hash routing
    function exportAsSPA() {
      document.getElementById('exportMenu')?.remove();
      
      // Save current state
      const currentPage = getCurrentPage();
      if (currentPage) {
        currentPage.main = components
          .filter(c => c.section === 'main')
          .map(c => ({ id: c.id, type: c.type, section: c.section, html: c.html, data: c.data }));
      }
      
      // Get global sections
      const headerHTML = components
        .filter(c => c.section === 'header')
        .map(c => c.html || '')
        .join('');
      
      const footerHTML = components
        .filter(c => c.section === 'footer')
        .map(c => c.html || '')
        .join('');
      
      // Build page content with data attributes for routing
      const pageContents = pages.map(p => {
        const mainHTML = (p.main || []).map(c => c.html || '').join('');
        return `<section class="page" data-page="${p.id}">${mainHTML || '<p style="padding: 2rem; color: #888;">Empty page</p>'}</section>`;
      }).join('\n      ');
      
      // Build nav links with hash routing
      const navLinks = pages.map(p => 
        `<a href="#${p.id}" class="nav-link" data-page="${p.id}">${p.name}</a>`
      ).join('\n          ');
      
      const spaHTML = `<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Website</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --primary: #6366f1;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--bg-color); 
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
    main { flex: 1; max-width: 1200px; margin: 0 auto; padding: 2rem; width: 100%; }
    footer { background: var(--bg-secondary); border-top: 1px solid var(--border-color); margin-top: auto; }
    
    /* Navigation */
    .site-nav { display: flex; gap: 1rem; padding: 1rem 2rem; align-items: center; }
    .site-nav .brand { font-weight: 700; font-size: 1.2rem; margin-right: auto; }
    .nav-link { 
      color: var(--text-secondary); 
      text-decoration: none; 
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-link:hover, .nav-link.active { color: var(--text-primary); background: var(--bg-tertiary); }    
    /* Pages */
    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body>
  <header>
    ${headerHTML || `<nav class="site-nav">
      <span class="brand">My Site</span>
      ${navLinks}
    </nav>`}
  </header>
  
  <main>
    ${pageContents}
  </main>
  
  <footer>
    ${footerHTML || '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">¬© 2026 My Website</div>'}
  </footer>
  
  <script>
    // Hash-based routing
    function router() {
      const hash = window.location.hash.slice(1) || 'home';
      
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      
      // Show current page
      const page = document.querySelector('.page[data-page="' + hash + '"]');
      const link = document.querySelector('.nav-link[data-page="' + hash + '"]');
      
      if (page) page.classList.add('active');
      if (link) link.classList.add('active');
      
      // Fallback to home
      if (!page) {
        const home = document.querySelector('.page[data-page="home"]');
        const homeLink = document.querySelector('.nav-link[data-page="home"]');
        if (home) home.classList.add('active');
        if (homeLink) homeLink.classList.add('active');
      }
    }
    
    // Listen for hash changes
    window.addEventListener('hashchange', router);
    window.addEventListener('DOMContentLoaded', router);
  </script>
</body>
</html>`;
      
      // Download
      downloadFile('website-spa.html', spaHTML);
      updateStatus('‚úÖ Exported as SPA (single HTML file)');
    }
    
    // Export as Multi-Page Application (separate HTML files)
    function exportAsMPA() {
      document.getElementById('exportMenu')?.remove();
      
      // Save current state
      const currentPage = getCurrentPage();
      if (currentPage) {
        currentPage.main = components
          .filter(c => c.section === 'main')
          .map(c => ({ id: c.id, type: c.type, section: c.section, html: c.html, data: c.data }));
      }
      
      // Get global sections
      const headerHTML = components
        .filter(c => c.section === 'header')
        .map(c => c.html || '')
        .join('');
      
      const footerHTML = components
        .filter(c => c.section === 'footer')
        .map(c => c.html || '')
        .join('');
      
      // Build nav links for MPA (actual file links)
      const navLinks = pages.map(p => 
        `<a href="${p.slug}" class="nav-link ${p.id === 'home' ? 'active' : ''}">${p.name}</a>`
      ).join('\n          ');
      
      // Common styles
      const commonStyles = `
    :root {
      --bg-color: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --primary: #6366f1;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--bg-color); 
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
    main { flex: 1; max-width: 1200px; margin: 0 auto; padding: 2rem; width: 100%; }
    footer { background: var(--bg-secondary); border-top: 1px solid var(--border-color); margin-top: auto; }
    .site-nav { display: flex; gap: 1rem; padding: 1rem 2rem; align-items: center; }
    .site-nav .brand { font-weight: 700; font-size: 1.2rem; margin-right: auto; }
    .nav-link { 
      color: var(--text-secondary); 
      text-decoration: none; 
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-link:hover, .nav-link.active { color: var(--text-primary); background: var(--bg-tertiary); }`;
      
      // Generate HTML for each page
      const files = pages.map(p => {
        const mainHTML = (p.main || []).map(c => c.html || '').join('');
        const activeNavLinks = navLinks.replace(
          `href="${p.slug}" class="nav-link"`,
          `href="${p.slug}" class="nav-link active"`
        ).replace(
          `href="${p.slug}" class="nav-link active"`,
          `href="${p.slug}" class="nav-link active"`
        );
        
        const html = `<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${p.name} - My Website</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>${commonStyles}</style>
</head>
<body>
  <header>
    ${headerHTML || `<nav class="site-nav">
      <span class="brand">My Site</span>
      ${activeNavLinks}
    </nav>`}
  </header>
  
  <main>
    ${mainHTML || '<p style="padding: 2rem; color: #888;">Empty page</p>'}
  </main>
  
  <footer>
    ${footerHTML || '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">¬© 2026 My Website</div>'}
  </footer>
</body>
</html>`;
        
        return { name: p.slug, content: html };
      });
      
      // Download each file (or show instructions for multiple files)
      if (files.length === 1) {
        downloadFile(files[0].name, files[0].content);
      } else {
        // Download as individual files with delay
        let delay = 0;
        files.forEach(f => {
          setTimeout(() => downloadFile(f.name, f.content), delay);
          delay += 500; // 500ms between downloads
        });
        
        // Also create a manifest
        const manifest = {
          name: 'My Website',
          pages: files.map(f => f.name),
          generated: new Date().toISOString()
        };
        setTimeout(() => downloadFile('manifest.json', JSON.stringify(manifest, null, 2)), delay);
      }
      
      updateStatus(`‚úÖ Exported ${files.length} HTML files`);
    }
    
    // Export as JSON (for reimporting)
    function exportAsJSON() {
      document.getElementById('exportMenu')?.remove();
      
      // Save current state
      const currentPage = getCurrentPage();
      if (currentPage) {
        currentPage.main = components
          .filter(c => c.section === 'main')
          .map(c => ({ id: c.id, type: c.type, section: c.section, html: c.html, data: c.data }));
      }
      
      const projectData = {
        version: '1.0',
        title: 'My Website',
        created: new Date().toISOString(),
        global: {
          header: components.filter(c => c.section === 'header').map(c => ({
            id: c.id, type: c.type, section: c.section, html: c.html, data: c.data
          })),
          footer: components.filter(c => c.section === 'footer').map(c => ({
            id: c.id, type: c.type, section: c.section, html: c.html, data: c.data
          }))
        },
        pages: pages
      };
      
      downloadFile('website-project.json', JSON.stringify(projectData, null, 2));
      updateStatus('‚úÖ Exported project JSON (can reimport later)');
    }
    
    // Helper: Download file
    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // === LOAD SITE FROM JSON ===
    
    // Show load site dropdown menu
    function showLoadSiteMenu(event) {
      event.stopPropagation();
      console.log('showLoadSiteMenu called');
      
      // Remove existing menu if any
      document.getElementById('loadSiteMenu')?.remove();
      
      const btn = event.target.closest('.btn');
      const rect = btn.getBoundingClientRect();
      
      const menu = document.createElement('div');
      menu.id = 'loadSiteMenu';
      menu.className = 'dropdown-menu';
      menu.style.position = 'fixed';
      menu.style.top = rect.bottom + 5 + 'px';
      menu.style.left = rect.left + 'px';
      menu.style.zIndex = '10000';
      
      menu.innerHTML = `
        <div class="dropdown-divider">üíæ Presets</div>
        <div class="dropdown-menu-item" onclick="loadPreset('saas')">
          <span class="item-icon">üöÄ</span>
          <div class="item-text">
            <div class="item-title">SaaS Website</div>
            <div class="item-desc">Features, pricing, testimonials</div>
          </div>
        </div>
        <div class="dropdown-menu-item" onclick="loadPreset('ecommerce')">
          <span class="item-icon">üõçÔ∏è</span>
          <div class="item-text">
            <div class="item-title">E-Commerce</div>
            <div class="item-desc">Products, cart, checkout</div>
          </div>
        </div>
        <div class="dropdown-menu-item" onclick="loadPreset('portfolio')">
          <span class="item-icon">üé®</span>
          <div class="item-text">
            <div class="item-title">Portfolio</div>
            <div class="item-desc">Projects, about, contact</div>
          </div>
        </div>
        <div class="dropdown-menu-item" onclick="loadPreset('docs')">
          <span class="item-icon">üìö</span>
          <div class="item-text">
            <div class="item-title">Documentation</div>
            <div class="item-desc">Guides, API, tutorials</div>
          </div>
        </div>
        <div class="dropdown-divider">üìÅ Custom</div>
        <div class="dropdown-menu-item" onclick="triggerJsonUpload()">
          <span class="item-icon">üì§</span>
          <div class="item-text">
            <div class="item-title">Upload site.json</div>
            <div class="item-desc">Load from your own file</div>
          </div>
        </div>
        <div class="dropdown-menu-item" onclick="loadFromConfigJson()">
          <span class="item-icon">‚öôÔ∏è</span>
          <div class="item-text">
            <div class="item-title">Use config/site.json</div>
            <div class="item-desc">Load current project config</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(menu);
      console.log('Menu added to DOM');
      
      // Close on click outside
      setTimeout(() => {
        document.addEventListener('click', closeLoadSiteMenu);
      }, 10);
    }
    
    function closeLoadSiteMenu() {
      document.getElementById('loadSiteMenu')?.remove();
      document.removeEventListener('click', closeLoadSiteMenu);
    }
    
    // Trigger file upload
    function triggerJsonUpload() {
      console.log('triggerJsonUpload called');
      closeLoadSiteMenu();
      document.getElementById('jsonFileInput').click();
    }
    
    // Handle JSON file upload
    function handleJsonFileUpload(event) {
      console.log('handleJsonFileUpload called');
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);
          console.log('Parsed JSON:', json);
          loadSiteFromJson(json, file.name);
        } catch (err) {
          alert('Error parsing JSON: ' + err.message);
        }
      };
      reader.readAsText(file);
      
      // Reset input so same file can be selected again
      event.target.value = '';
    }
    
    // Load preset by name
    async function loadPreset(presetName) {
      console.log('loadPreset called:', presetName);
      closeLoadSiteMenu();
      updateStatus(`Loading ${presetName} preset...`);
      
      // Map preset names to display names
      const templateNames = {
        'saas': 'SaaS',
        'ecommerce': 'E-Commerce',
        'portfolio': 'Portfolio',
        'docs': 'Documentation'
      };
      
      try {
        const response = await fetch(`templates/presets/${presetName}/site.json`);
        console.log('Fetch response:', response.status);
        if (!response.ok) throw new Error(`Preset not found (${response.status})`);
        
        const json = await response.json();
        console.log('Loaded preset JSON:', json);
        loadSiteFromJson(json, `${presetName} preset`);
        // Show template indicator
        setTemplateIndicator(templateNames[presetName] || presetName);
      } catch (err) {
        console.error('loadPreset error:', err);
        alert('Error loading preset: ' + err.message);
        updateStatus('Failed to load preset');
      }
    }
    
    // Load from config/site.json
    async function loadFromConfigJson() {
      console.log('loadFromConfigJson called');
      closeLoadSiteMenu();
      updateStatus('Loading config/site.json...');
      
      try {
        const response = await fetch('config/site.json');
        console.log('Fetch response:', response.status);
        if (!response.ok) throw new Error(`config/site.json not found (${response.status})`);
        
        const json = await response.json();
        console.log('Loaded config JSON:', json);
        loadSiteFromJson(json, 'config/site.json');
      } catch (err) {
        console.error('loadFromConfigJson error:', err);
        alert('Error loading config: ' + err.message);
        updateStatus('Failed to load config');
      }
    }
    
    // Main function to load site from JSON structure
    function loadSiteFromJson(json, sourceName) {
      console.log('loadSiteFromJson called with:', sourceName);
      
      // Confirm before clearing
      if (components.length > 0 || pages.length > 1) {
        if (!confirm(`This will replace your current site with "${sourceName}".\n\nContinue?`)) {
          return;
        }
      }
      
      // Clear current state
      clearBuilder();
      
      // Detect JSON format and parse accordingly
      if (json.site || json.nav) {
        console.log('Detected preset format');
        // Preset format (site, nav, header, footer)
        loadPresetFormat(json);
      } else if (json.branding || json.navigationMenu) {
        console.log('Detected config format');
        // Config format (branding, navigationMenu, etc)
        loadConfigFormat(json);
      } else if (json.version && json.pages) {
        console.log('Detected project format');
        // Project format (from our export)
        loadProjectFormat(json);
      } else {
        alert('Unknown JSON format. Please use a valid site.json file.');
        return;
      }
      
      updateStatus(`‚úÖ Loaded site from ${sourceName}`);
    }
    
    // Clear the builder
    function clearBuilder() {
      console.log('clearBuilder called');
      // Clear all containers
      ['header', 'main', 'footer'].forEach(section => {
        const container = document.getElementById(`${section}-container`);
        const dropZone = container.querySelector('.canvas-drop-zone');
        container.querySelectorAll('.canvas-component').forEach(el => el.remove());
        dropZone.classList.remove('has-items');
      });
      
      // Reset state
      components = [];
      pages = [{ id: 'home', name: 'Home', slug: 'index.html', main: [] }];
      currentPageId = 'home';
      selectedComponent = null;
      componentIdCounter = 0;
      
      document.getElementById('propertiesPanel').innerHTML = 
        `<div class="properties-empty">Click a component to edit its properties</div>`;
      
      renderPagesList();
      updateComponentCount();
      console.log('clearBuilder complete');
    }
    
    // Load preset format JSON
    function loadPresetFormat(json) {
      console.log('loadPresetFormat called');
      const site = json.site || {};
      const nav = json.nav || [];
      const header = json.header || {};
      const footer = json.footer || {};
      
      console.log('Parsed preset - site:', site.name, 'nav:', nav.length);
      
      // Create pages from nav
      pages = nav.map((item, index) => ({
        id: item.id || item.page || `page-${index}`,
        name: item.label || item.menuItemText || 'Page',
        slug: (item.page || item.id || 'page') + '.html',
        main: []
      }));
      
      // Ensure home exists
      if (!pages.find(p => p.id === 'home')) {
        pages.unshift({ id: 'home', name: 'Home', slug: 'index.html', main: [] });
      }
      
      console.log('Created pages:', pages.map(p => p.name));
      currentPageId = 'home';
      
      // Add navbar to header
      const logoText = site.name || site.logo?.replace(/<[^>]*>/g, '') || 'My Site';
      console.log('Adding navbar with logo:', logoText);
      addComponentToCanvas('navbar', 'header');
      const navComp = components.find(c => c.type === 'navbar');
      if (navComp) {
        navComp.data = { logo: logoText };
        const newHtml = componentTemplates.navbar.getHtml(logoText);
        navComp.html = newHtml;
        navComp.element.querySelector('.component-content').innerHTML = newHtml;
      }
      
      // Add hero to home page
      console.log('Adding hero');
      addComponentToCanvas('hero', 'main');
      const heroComp = components.find(c => c.type === 'hero');
      if (heroComp && site.tagline) {
        const heroHtml = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 4rem 2rem; text-align: center; color: white; border-radius: 8px;">
          <h2 style="font-size: 2.5rem; margin: 0 0 1rem 0;">${site.name || 'Welcome'}</h2>
          <p style="font-size: 1.1rem; margin: 0;">${site.tagline}</p>
        </div>`;
        heroComp.html = heroHtml;
        heroComp.element.querySelector('.component-content').innerHTML = heroHtml;
      }
      
      // Add footer
      console.log('Adding footer');
      addComponentToCanvas('footer', 'footer');
      const footerComp = components.find(c => c.type === 'footer');
      if (footerComp && footer.copyright) {
        const footerHtml = `<div style="padding: 2rem; text-align: center; border-top: 1px solid var(--border-color);">
          <p style="margin: 0; color: var(--text-secondary);">${footer.copyright}</p>
        </div>`;
        footerComp.html = footerHtml;
        footerComp.element.querySelector('.component-content').innerHTML = footerHtml;
      }
      
      console.log('loadPresetFormat complete, components:', components.length);
      renderPagesList();
      renderComponentLibrary();
      updateComponentCount();
    }

    // ===== WB DRAWER LAYOUT FUNCTIONS =====
    
    // Builder settings (persisted)
    let builderSettings = {
      autoSave: false,
      autoSaveInterval: 30,
      showGrid: true,
      snapToGrid: false,
      gridSize: 20,
      defaultTheme: 'dark',
      confirmDelete: true,
      showTooltips: true,
      collapseLeftDrawer: false,
      collapseRightDrawer: false
    };
    
    // Load settings from localStorage
    function loadSettings() {
      const saved = localStorage.getItem('wb-builder-settings');
      if (saved) {
        try {
          builderSettings = { ...builderSettings, ...JSON.parse(saved) };
        } catch (e) {
          console.warn('Failed to load settings:', e);
        }
      }
    }
    
    // Save settings to localStorage
    function saveSettings() {
      localStorage.setItem('wb-builder-settings', JSON.stringify(builderSettings));
    }
    
    // Toggle drawer collapse
    function toggleDrawer(drawerId) {
      const drawer = document.getElementById(drawerId);
      if (!drawer) return;
      
      const isCollapsed = drawer.classList.contains('collapsed');
      const position = drawerId === 'leftDrawer' ? 'left' : 'right';
      const toggle = drawer.querySelector('.wb-drawer-toggle');
      
      if (isCollapsed) {
        // Expand
        drawer.classList.remove('collapsed');
        const savedWidth = localStorage.getItem(`wb-drawer-${drawerId}-width`);
        const defaultWidth = position === 'left' ? '280px' : '350px';
        drawer.style.width = savedWidth || defaultWidth;
        drawer.style.minWidth = savedWidth || defaultWidth;
        if (toggle) toggle.textContent = position === 'left' ? '‚óÄ' : '‚ñ∂';
      } else {
        // Collapse
        drawer.classList.add('collapsed');
        drawer.style.width = '24px';
        drawer.style.minWidth = '24px';
        if (toggle) toggle.textContent = position === 'left' ? '‚ñ∂' : '‚óÄ';
      }
    }
    
    // Resize drawer
    let resizingDrawer = null;
    let resizeStartX = 0;
    let resizeStartWidth = 0;
    
    function startResize(e, drawerId, position) {
      e.preventDefault();
      const drawer = document.getElementById(drawerId);
      if (!drawer || drawer.classList.contains('collapsed')) return;
      
      resizingDrawer = { drawer, position };
      resizeStartX = e.clientX;
      resizeStartWidth = drawer.offsetWidth;
      drawer.classList.add('resizing');
      
      document.addEventListener('mousemove', doResize);
      document.addEventListener('mouseup', stopResize);
    }
    
    function doResize(e) {
      if (!resizingDrawer) return;
      
      const { drawer, position } = resizingDrawer;
      let newWidth;
      
      if (position === 'left') {
        newWidth = resizeStartWidth + (e.clientX - resizeStartX);
      } else {
        newWidth = resizeStartWidth - (e.clientX - resizeStartX);
      }
      
      // Constraints
      newWidth = Math.max(200, Math.min(500, newWidth));
      
      drawer.style.width = newWidth + 'px';
      drawer.style.minWidth = newWidth + 'px';
    }
    
    function stopResize() {
      if (!resizingDrawer) return;
      
      const { drawer } = resizingDrawer;
      drawer.classList.remove('resizing');
      
      // Save width
      localStorage.setItem(`wb-drawer-${drawer.id}-width`, drawer.style.width);
      
      resizingDrawer = null;
      document.removeEventListener('mousemove', doResize);
      document.removeEventListener('mouseup', stopResize);
    }
    
    // Initialize drawers from saved state
    function initDrawers() {
      ['leftDrawer', 'rightDrawer'].forEach(id => {
        const drawer = document.getElementById(id);
        if (!drawer) return;
        
        const savedWidth = localStorage.getItem(`wb-drawer-${id}-width`);
        if (savedWidth) {
          drawer.style.width = savedWidth;
          drawer.style.minWidth = savedWidth;
        }
      });
    }
    
    // ===== CONTEXT MENU FUNCTIONS =====
    
    // WB Components available for insertion
    const wbComponentsForContextMenu = [
      { category: 'Layout', items: [
        { id: 'wb-container', icon: 'üì¶', name: 'Container' },
        { id: 'wb-stack', icon: '‚¨áÔ∏è', name: 'Stack (Column)' },
        { id: 'wb-cluster', icon: '‚û°Ô∏è', name: 'Cluster (Row)' },
        { id: 'wb-grid', icon: '‚ñëÔ∏è', name: 'Grid' }
      ]},
      { category: 'Content', items: [
        { id: 'wb-card', icon: 'üÉè', name: 'Card' },
        { id: 'wb-hero', icon: 'ü¶∏', name: 'Hero' },
        { id: 'wb-cta', icon: 'üìû', name: 'Call to Action' }
      ]},
      { category: 'Interactive', items: [
        { id: 'wb-tabs', icon: 'üìÅ', name: 'Tabs' },
        { id: 'wb-collapse', icon: 'üìÑ', name: 'Collapsible' },
        { id: 'wb-dropdown', icon: 'üîΩ', name: 'Dropdown' }
      ]},
      { category: 'Media', items: [
        { id: 'wb-gallery', icon: 'üñºÔ∏è', name: 'Gallery' },
        { id: 'wb-lightbox', icon: 'üîç', name: 'Lightbox' }
      ]}
    ];
    
    // Show context menu on right-click
    function showComponentContextMenu(e, componentEl) {
      e.preventDefault();
      
      // Remove any existing context menu
      document.getElementById('builderContextMenu')?.remove();
      
      const menu = document.createElement('div');
      menu.id = 'builderContextMenu';
      menu.className = 'context-menu';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      
      // Build menu HTML
      let menuHtml = `
        <button class="ctx-item" onclick="editComponentProperties('${componentEl.id}')">‚úèÔ∏è Edit Properties</button>
        <button class="ctx-item" onclick="duplicateComponent('${componentEl.id}')">üìã Duplicate</button>
        <hr class="ctx-divider">
        <div class="ctx-submenu">
          <button class="ctx-item">‚ûï Add WB Component</button>
          <div class="ctx-submenu-content">
      `;
      
      // Add WB components by category
      wbComponentsForContextMenu.forEach(cat => {
        menuHtml += `<div style="padding: 0.3rem 1rem; font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase;">${cat.category}</div>`;
        cat.items.forEach(item => {
          menuHtml += `<button class="ctx-item" onclick="addWBComponentToElement('${componentEl.id}', '${item.id}')">${item.icon} ${item.name}</button>`;
        });
      });
      
      menuHtml += `
          </div>
        </div>
        <hr class="ctx-divider">
        <button class="ctx-item" onclick="moveComponentUp('${componentEl.id}')">‚¨ÜÔ∏è Move Up</button>
        <button class="ctx-item" onclick="moveComponentDown('${componentEl.id}')">‚¨áÔ∏è Move Down</button>
        <hr class="ctx-divider">
        <button class="ctx-item ctx-item--danger" onclick="deleteComponent('${componentEl.id}')">üóëÔ∏è Delete</button>
      `;
      
      menu.innerHTML = menuHtml;
      document.body.appendChild(menu);
      
      // Adjust position if off-screen
      const rect = menu.getBoundingClientRect();
      if (rect.right > window.innerWidth) menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
      if (rect.bottom > window.innerHeight) menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
      
      // Close on click outside
      setTimeout(() => {
        const closeMenu = (ev) => {
          if (!menu.contains(ev.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        };
        document.addEventListener('click', closeMenu);
      }, 0);
    }
    
    // Add WB component to an element
    function addWBComponentToElement(parentId, wbComponentType) {
      document.getElementById('builderContextMenu')?.remove();
      
      const parentEl = document.getElementById(parentId);
      if (!parentEl) return;
      
      const contentEl = parentEl.querySelector('.component-content');
      if (!contentEl) return;
      
      // Generate unique ID for this nested component
      const nestedId = `nested-${componentIdCounter++}`;
      
      // Create placeholder for the WB component
      const placeholder = document.createElement('div');
      placeholder.className = 'wb-inserted-component';
      placeholder.id = nestedId;
      placeholder.dataset.wbType = wbComponentType;
      placeholder.dataset.parentId = parentId;
      placeholder.style.cssText = 'padding: 1rem; border: 2px dashed var(--primary); border-radius: 6px; margin: 0.5rem 0; text-align: center; cursor: pointer; transition: all 0.2s;';
      placeholder.innerHTML = `<span style="color: var(--primary); font-size: 0.85rem;">üì¶ ${wbComponentType} (Click to configure)</span>`;
      
      // Add click handler to show nested component properties
      placeholder.addEventListener('click', (e) => {
        e.stopPropagation();
        showNestedComponentProperties(nestedId, wbComponentType, parentId);
      });
      
      // Add hover effect
      placeholder.addEventListener('mouseenter', () => {
        placeholder.style.background = 'rgba(99, 102, 241, 0.1)';
        placeholder.style.borderColor = 'var(--primary)';
      });
      placeholder.addEventListener('mouseleave', () => {
        placeholder.style.background = '';
        placeholder.style.borderColor = 'var(--primary)';
      });
      
      contentEl.appendChild(placeholder);
      
      // Update the component's HTML and track nested components
      const comp = components.find(c => c.id === parentId);
      if (comp) {
        comp.html = contentEl.innerHTML;
        // Track nested components in parent's data
        if (!comp.data.nestedComponents) {
          comp.data.nestedComponents = [];
        }
        comp.data.nestedComponents.push({
          id: nestedId,
          type: wbComponentType,
          config: {} // Will hold component-specific config
        });
      }
      
      updateStatus(`Added ${wbComponentType} to component`);
    }
    
    // Show properties panel for a nested WB component
    function showNestedComponentProperties(nestedId, wbType, parentId) {
      const panel = document.getElementById('propertiesPanel');
      const parentComp = components.find(c => c.id === parentId);
      const nestedData = parentComp?.data?.nestedComponents?.find(n => n.id === nestedId);
      
      // Find the component info from the context menu list
      let componentInfo = null;
      for (const cat of wbComponentsForContextMenu) {
        const found = cat.items.find(item => item.id === wbType);
        if (found) {
          componentInfo = found;
          break;
        }
      }
      
      const icon = componentInfo?.icon || 'üì¶';
      const name = componentInfo?.name || wbType;
      
      panel.innerHTML = `
        <div class="properties-section">
          <h4>${icon} ${name}</h4>
          
          <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 1rem;">
            <p style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--text-secondary);">
              <strong>Type:</strong> ${wbType}
            </p>
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
              <strong>Parent:</strong> ${parentComp?.template?.name || 'Unknown'}
            </p>
          </div>
          
          ${getNestedComponentConfigFields(wbType, nestedId, parentId, nestedData?.config || {})}
          
          <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="selectParentComponent('${parentId}')">
              ‚¨ÜÔ∏è Back to Parent
            </button>
            <button class="btn btn-danger" style="flex: 1;" onclick="removeNestedComponent('${nestedId}', '${parentId}')">
              üóëÔ∏è Remove
            </button>
          </div>
        </div>
      `;
      
      // Update status bar
      updateActiveElement('nested', name, icon);
    }
    
    // Get config fields for different nested component types
    function getNestedComponentConfigFields(wbType, nestedId, parentId, config) {
      switch (wbType) {
        case 'wb-card':
          return `
            <div class="property">
              <label>Card Title</label>
              <input type="text" value="${config.title || ''}" placeholder="Card Title" 
                     onchange="updateNestedConfig('${nestedId}', '${parentId}', 'title', this.value)">
            </div>
            <div class="property">
              <label>Card Content</label>
              <textarea class="short" placeholder="Card content..." 
                        onchange="updateNestedConfig('${nestedId}', '${parentId}', 'content', this.value)">${config.content || ''}</textarea>
            </div>
            <div class="property">
              <label>Icon/Emoji</label>
              <input type="text" value="${config.icon || 'üì¶'}" 
                     onchange="updateNestedConfig('${nestedId}', '${parentId}', 'icon', this.value)">
            </div>
          `;
          
        case 'wb-hero':
          return `
            <div class="property">
              <label>Headline</label>
              <input type="text" value="${config.headline || ''}" placeholder="Hero Headline" 
                     onchange="updateNestedConfig('${nestedId}', '${parentId}', 'headline', this.value)">
            </div>
            <div class="property">
              <label>Subheadline</label>
              <textarea class="short" placeholder="Subheadline..." 
                        onchange="updateNestedConfig('${nestedId}', '${parentId}', 'subheadline', this.value)">${config.subheadline || ''}</textarea>
            </div>
          `;
          
        case 'wb-cta':
          return `
            <div class="property">
              <label>Button Text</label>
              <input type="text" value="${config.buttonText || 'Click Here'}" 
                     onchange="updateNestedConfig('${nestedId}', '${parentId}', 'buttonText', this.value)">
            </div>
            <div class="property">
              <label>Button Link</label>
              <input type="text" value="${config.buttonLink || '#'}" placeholder="https://..." 
                     onchange="updateNestedConfig('${nestedId}', '${parentId}', 'buttonLink', this.value)">
            </div>
          `;
          
        case 'wb-container':
        case 'wb-stack':
        case 'wb-cluster':
        case 'wb-grid':
          return `
            <div class="property">
              <label>Gap</label>
              <select onchange="updateNestedConfig('${nestedId}', '${parentId}', 'gap', this.value)">
                <option value="0" ${config.gap === '0' ? 'selected' : ''}>None</option>
                <option value="0.5rem" ${config.gap === '0.5rem' ? 'selected' : ''}>Small</option>
                <option value="1rem" ${config.gap === '1rem' || !config.gap ? 'selected' : ''}>Medium</option>
                <option value="2rem" ${config.gap === '2rem' ? 'selected' : ''}>Large</option>
              </select>
            </div>
            <div class="property">
              <label>Padding</label>
              <select onchange="updateNestedConfig('${nestedId}', '${parentId}', 'padding', this.value)">
                <option value="0" ${config.padding === '0' ? 'selected' : ''}>None</option>
                <option value="1rem" ${config.padding === '1rem' || !config.padding ? 'selected' : ''}>Normal</option>
                <option value="2rem" ${config.padding === '2rem' ? 'selected' : ''}>Large</option>
              </select>
            </div>
          `;
          
        default:
          return `
            <div style="padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 6px; text-align: center;">
              <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem;">
                üõ†Ô∏è Configuration options for <strong>${wbType}</strong> coming soon!
              </p>
            </div>
          `;
      }
    }
    
    // Update nested component config
    function updateNestedConfig(nestedId, parentId, key, value) {
      const comp = components.find(c => c.id === parentId);
      if (!comp?.data?.nestedComponents) return;
      
      const nested = comp.data.nestedComponents.find(n => n.id === nestedId);
      if (nested) {
        nested.config[key] = value;
        updateNestedComponentDisplay(nestedId, nested.type, nested.config);
        updateStatus(`Updated ${key}`);
      }
    }
    
    // Update the visual display of a nested component
    function updateNestedComponentDisplay(nestedId, wbType, config) {
      const el = document.getElementById(nestedId);
      if (!el) return;
      
      // Update the placeholder display based on config
      let displayText = wbType;
      if (config.title) displayText = config.title;
      else if (config.headline) displayText = config.headline;
      else if (config.buttonText) displayText = config.buttonText;
      
      const icon = config.icon || 'üì¶';
      el.innerHTML = `<span style="color: var(--primary); font-size: 0.85rem;">${icon} ${displayText}</span>`;
    }
    
    // Select parent component (go back from nested view)
    function selectParentComponent(parentId) {
      const el = document.getElementById(parentId);
      if (el) {
        el.click();
      }
    }
    
    // Remove a nested component
    function removeNestedComponent(nestedId, parentId) {
      const comp = components.find(c => c.id === parentId);
      if (!comp) return;
      
      // Remove from DOM
      const el = document.getElementById(nestedId);
      if (el) el.remove();
      
      // Remove from data
      if (comp.data.nestedComponents) {
        comp.data.nestedComponents = comp.data.nestedComponents.filter(n => n.id !== nestedId);
      }
      
      // Update parent's HTML
      const contentEl = document.getElementById(parentId)?.querySelector('.component-content');
      if (contentEl) {
        comp.html = contentEl.innerHTML;
      }
      
      // Go back to parent
      selectParentComponent(parentId);
      updateStatus('Nested component removed');
    }
    
    // Edit component properties (select it)
    function editComponentProperties(componentId) {
      document.getElementById('builderContextMenu')?.remove();
      const el = document.getElementById(componentId);
      if (el) el.click();
    }
    
    // Duplicate component
    function duplicateComponent(componentId) {
      document.getElementById('builderContextMenu')?.remove();
      
      const comp = components.find(c => c.id === componentId);
      if (!comp) return;
      
      // Create a copy
      const newId = `comp-${componentIdCounter++}`;
      const newComp = {
        ...comp,
        id: newId,
        data: { ...comp.data }
      };
      
      // Restore it to the canvas
      restoreComponent(newComp, comp.template);
      updateComponentCount();
      updateStatus('Component duplicated');
    }
    
    // Move component up
    function moveComponentUp(componentId) {
      document.getElementById('builderContextMenu')?.remove();
      
      const el = document.getElementById(componentId);
      if (!el || !el.previousElementSibling || el.previousElementSibling.classList.contains('section-label')) return;
      
      const prev = el.previousElementSibling;
      if (prev && !prev.classList.contains('canvas-drop-zone')) {
        el.parentNode.insertBefore(el, prev);
        updateStatus('Component moved up');
      }
    }
    
    // Move component down
    function moveComponentDown(componentId) {
      document.getElementById('builderContextMenu')?.remove();
      
      const el = document.getElementById(componentId);
      if (!el || !el.nextElementSibling) return;
      
      const next = el.nextElementSibling;
      if (next && !next.classList.contains('canvas-drop-zone')) {
        el.parentNode.insertBefore(next, el);
        updateStatus('Component moved down');
      }
    }
    
    // ===== CONFIGURATION PANEL =====
    
    function showConfigPanel() {
      // Remove existing
      document.getElementById('configPanel')?.remove();
      
      const panel = document.createElement('div');
      panel.id = 'configPanel';
      panel.className = 'config-panel';
      panel.onclick = (e) => { if (e.target === panel) panel.remove(); };
      
      panel.innerHTML = `
        <div class="config-dialog">
          <div class="config-header">
            <h2>‚öôÔ∏è Builder Settings</h2>
            <button class="config-close" onclick="document.getElementById('configPanel').remove()">&times;</button>
          </div>
          <div class="config-body">
            
            <div class="config-section">
              <h3>üíæ Auto-Save</h3>
              <div class="config-row">
                <div>
                  <label>Enable Auto-Save</label>
                  <small>Automatically save your work periodically</small>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="cfgAutoSave" ${builderSettings.autoSave ? 'checked' : ''} onchange="updateSetting('autoSave', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="config-row">
                <div>
                  <label>Auto-Save Interval (seconds)</label>
                  <small>How often to save automatically</small>
                </div>
                <input type="number" id="cfgAutoSaveInterval" value="${builderSettings.autoSaveInterval}" min="10" max="300" style="width: 80px; padding: 0.5rem; font-size: 0.95rem;" onchange="updateSetting('autoSaveInterval', parseInt(this.value))">
              </div>
            </div>
            
            <div class="config-section">
              <h3>üé® Canvas</h3>
              <div class="config-row">
                <div>
                  <label>Show Grid</label>
                  <small>Display alignment grid on canvas</small>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="cfgShowGrid" ${builderSettings.showGrid ? 'checked' : ''} onchange="updateSetting('showGrid', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="config-row">
                <div>
                  <label>Snap to Grid</label>
                  <small>Components snap to grid lines when moving</small>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="cfgSnapToGrid" ${builderSettings.snapToGrid ? 'checked' : ''} onchange="updateSetting('snapToGrid', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="config-row">
                <div>
                  <label>Grid Size (px)</label>
                  <small>Size of grid cells</small>
                </div>
                <input type="number" id="cfgGridSize" value="${builderSettings.gridSize}" min="5" max="50" style="width: 80px; padding: 0.5rem; font-size: 0.95rem;" onchange="updateSetting('gridSize', parseInt(this.value))">
              </div>
            </div>
            
            <div class="config-section">
              <h3>üñ•Ô∏è Interface</h3>
              <div class="config-row">
                <div>
                  <label>Default Theme</label>
                  <small>Color theme for the builder</small>
                </div>
                <select id="cfgTheme" style="padding: 0.5rem; font-size: 0.95rem;" onchange="updateSetting('defaultTheme', this.value); document.documentElement.dataset.theme = this.value;">
                  <option value="dark" ${builderSettings.defaultTheme === 'dark' ? 'selected' : ''}>Dark</option>
                  <option value="light" ${builderSettings.defaultTheme === 'light' ? 'selected' : ''}>Light</option>
                </select>
              </div>
              <div class="config-row">
                <div>
                  <label>Confirm Before Delete</label>
                  <small>Ask before deleting components</small>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="cfgConfirmDelete" ${builderSettings.confirmDelete ? 'checked' : ''} onchange="updateSetting('confirmDelete', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="config-row">
                <div>
                  <label>Show Tooltips</label>
                  <small>Display helpful tooltips on hover</small>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="cfgShowTooltips" ${builderSettings.showTooltips ? 'checked' : ''} onchange="updateSetting('showTooltips', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
            
            <div class="config-section">
              <h3>üìä Storage</h3>
              <div class="config-row">
                <div>
                  <label>Clear Saved Data</label>
                  <small>Remove all locally saved projects and settings</small>
                </div>
                <button class="btn btn-danger btn-sm" onclick="if(confirm('Clear all saved data?')) { localStorage.clear(); location.reload(); }">üóëÔ∏è Clear All</button>
              </div>
            </div>
            
          </div>
          <div class="config-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('configPanel').remove()">Close</button>
            <button class="btn btn-primary" onclick="saveSettings(); document.getElementById('configPanel').remove(); updateStatus('Settings saved');">Save Settings</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(panel);
    }
    
    function updateSetting(key, value) {
      builderSettings[key] = value;
      
      // Apply immediate effects
      if (key === 'showGrid') {
        const viewport = document.querySelector('.canvas-viewport');
        if (viewport) {
          viewport.style.background = value 
            ? 'linear-gradient(45deg, rgba(99, 102, 241, 0.05) 1px, transparent 1px), linear-gradient(-45deg, rgba(99, 102, 241, 0.05) 1px, transparent 1px)'
            : 'transparent';
          viewport.style.backgroundSize = value ? `${builderSettings.gridSize}px ${builderSettings.gridSize}px` : '';
        }
      }
    }
    
    // Load config format JSON (config/site.json style)
    function loadConfigFormat(json) {
      console.log('loadConfigFormat called');
      const branding = json.branding || {};
      const navMenu = json.navigationMenu || [];
      const footerSettings = json.footerSettings || {};
      const services = json.servicesList || [];
      const team = json.teamMembers || [];
      const testimonials = json.customerTestimonials || [];
      const faqs = json.frequentlyAskedQuestions || [];
      const company = json.companyInfo || {};
      
      console.log('Parsed config - branding:', branding.companyName, 'navMenu:', navMenu.length, 'services:', services.length);
      
      // Create pages from navigation
      pages = navMenu.map((item, index) => ({
        id: item.menuItemId || item.pageToLoad || `page-${index}`,
        name: item.menuItemText || 'Page',
        slug: (item.pageToLoad || item.menuItemId || 'page') + '.html',
        main: []
      }));
      
      // Ensure home exists
      if (!pages.find(p => p.id === 'home')) {
        pages.unshift({ id: 'home', name: 'Home', slug: 'index.html', main: [] });
      }
      
      console.log('Created pages:', pages.map(p => p.name));
      currentPageId = 'home';
      
      // Add navbar
      const logoText = branding.companyName || 'My Site';
      console.log('Adding navbar with logo:', logoText);
      addComponentToCanvas('navbar', 'header');
      const navComp = components.find(c => c.type === 'navbar');
      if (navComp) {
        navComp.data = { logo: logoText };
        const newHtml = componentTemplates.navbar.getHtml(logoText);
        navComp.html = newHtml;
        navComp.element.querySelector('.component-content').innerHTML = newHtml;
      }
      
      // Add hero with company info
      console.log('Adding hero');
      addComponentToCanvas('hero', 'main');
      const heroComp = components.find(c => c.type === 'hero');
      if (heroComp) {
        const heroHtml = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 4rem 2rem; text-align: center; color: white; border-radius: 8px;">
          <h2 style="font-size: 2.5rem; margin: 0 0 1rem 0;">${company.businessName || branding.companyName || 'Welcome'}</h2>
          <p style="font-size: 1.1rem; margin: 0;">${company.businessTagline || branding.headerSubtitle || 'Your tagline here'}</p>
        </div>`;
        heroComp.html = heroHtml;
        heroComp.element.querySelector('.component-content').innerHTML = heroHtml;
      }
      
      // Add features from services
      if (services.length > 0) {
        console.log('Adding features from', services.length, 'services');
        const featureCards = services.slice(0, 3).map(s => ({
          icon: s.serviceIcon || '‚ú®',
          title: s.serviceName || 'Service',
          description: s.serviceDescription || 'Description'
        }));
        
        addComponentToCanvas('features', 'main', { cards: featureCards, selectedCard: 0 });
        
        // Update the features grid with service data
        const featuresComp = components.find(c => c.type === 'features');
        if (featuresComp) {
          console.log('Features component found, updating with cards');
          featuresComp.data.cards = featureCards;
          const newHtml = componentTemplates.features.getHtml(featuresComp.data);
          featuresComp.html = newHtml;
          featuresComp.element.querySelector('.component-content').innerHTML = newHtml;
          setupFeatureGridClickHandlers(featuresComp.id);
        }
      }
      
      // Add footer
      console.log('Adding footer');
      addComponentToCanvas('footer', 'footer');
      const footerComp = components.find(c => c.type === 'footer');
      if (footerComp && footerSettings.footerCopyrightText) {
        const footerHtml = `<div style="padding: 2rem; text-align: center; border-top: 1px solid var(--border-color);">
          <p style="margin: 0; color: var(--text-secondary);">${footerSettings.footerCopyrightText}</p>
        </div>`;
        footerComp.html = footerHtml;
        footerComp.element.querySelector('.component-content').innerHTML = footerHtml;
      }
      
      console.log('loadConfigFormat complete, components:', components.length);
      renderPagesList();
      renderComponentLibrary();
      updateComponentCount();
    }
    
    // Load project format JSON (our own export format)
    function loadProjectFormat(json) {
      // Load pages
      pages = json.pages || [{ id: 'home', name: 'Home', slug: 'index.html', main: [] }];
      currentPageId = 'home';
      
      // Load global header components
      if (json.global?.header) {
        json.global.header.forEach(compData => {
          const template = componentTemplates[compData.type];
          if (template) {
            restoreComponent({ ...compData, section: 'header' }, template);
          }
        });
      }
      
      // Load home page main components
      const homePage = pages.find(p => p.id === 'home');
      if (homePage?.main) {
        homePage.main.forEach(compData => {
          const template = componentTemplates[compData.type];
          if (template) {
            restoreComponent(compData, template);
          }
        });
      }
      
      // Load global footer components
      if (json.global?.footer) {
        json.global.footer.forEach(compData => {
          const template = componentTemplates[compData.type];
          if (template) {
            restoreComponent({ ...compData, section: 'footer' }, template);
          }
        });
      }
      
      renderPagesList();
      renderComponentLibrary();
      updateComponentCount();
    }

    // Initialize
    function init() {
      // Load settings and initialize drawers
      loadSettings();
      initDrawers();
      
      renderPagesList();
      renderComponentLibrary(); // Render initial component library for Home page
      
      // Load Home page's initial content
      const homePage = pages.find(p => p.id === 'home');
      if (homePage && homePage.main && homePage.main.length > 0) {
        homePage.main.forEach(compData => {
          const template = componentTemplates[compData.type];
          if (template) {
            restoreComponent(compData, template);
          }
        });
      }
      
      updateComponentCount();
      
      // Show page properties for home page
      showPageProperties(homePage);
      
      // Set active element in status bar
      updateActiveElement('page', homePage?.name || 'Home');
      
      // Initialize canvas sections visibility
      updateCanvasSectionsVisibility(currentPageId);
      
      // Add global right-click handler for canvas components
      document.querySelector('.canvas').addEventListener('contextmenu', (e) => {
        const componentEl = e.target.closest('.canvas-component');
        if (componentEl) {
          showComponentContextMenu(e, componentEl);
        }
      });
    }
    
    init();
  </script>
  
  <!-- Builder Enhancements Module -->
  <script src="src/wb-viewmodels/builder-app/builder-enhancements.js"></script>
</body>
</html>
