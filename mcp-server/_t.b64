aW1wb3J0IHsgU2VydmVyIH0gZnJvbSAiQG1vZGVsY29udGV4dHByb3RvY29sL3Nkay9zZXJ2ZXIvaW5kZXguanMiOwppbXBvcnQgeyBTdGRpb1NlcnZlclRyYW5zcG9ydCB9IGZyb20gIkBtb2RlbGNvbnRleHRwcm90b2NvbC9zZGsvc2VydmVyL3N0ZGlvLmpzIjsKaW1wb3J0IHsKICBDYWxsVG9vbFJlcXVlc3RTY2hlbWEsCiAgTGlzdFRvb2xzUmVxdWVzdFNjaGVtYSwKfSBmcm9tICJAbW9kZWxjb250ZXh0cHJvdG9jb2wvc2RrL3R5cGVzLmpzIjsKaW1wb3J0IHsgc3Bhd24gfSBmcm9tICJjaGlsZF9wcm9jZXNzIjsKaW1wb3J0IHsgd3JpdGVGaWxlIH0gZnJvbSAiZnMvcHJvbWlzZXMiOwppbXBvcnQgeyB3cml0ZUZpbGVTeW5jLCBhcHBlbmRGaWxlU3luYywgcmVhZEZpbGVTeW5jLCBleGlzdHNTeW5jIH0gZnJvbSAiZnMiOwppbXBvcnQgeyBqb2luLCBkaXJuYW1lIH0gZnJvbSAicGF0aCI7CmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICJ1cmwiOwppbXBvcnQgeyBXb3JrZXIgfSBmcm9tICJ3b3JrZXJfdGhyZWFkcyI7Cgpjb25zdCBfX2Rpcm5hbWUgPSBkaXJuYW1lKGZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKSk7CmNvbnN0IFBST0pFQ1RfRElSID0gam9pbihfX2Rpcm5hbWUsICIuLiIpOwpjb25zdCBQUk9HUkVTU19GSUxFID0gam9pbihQUk9KRUNUX0RJUiwgImRhdGEiLCAidGVzdC1wcm9ncmVzcy5sb2ciKTsKbmQgPSBudWxsOyAvLyB7IHN0YXJ0VGltZSwgY29tbWFuZCwgcGlkIH0KCi8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAovLyAgVHJhZmZpYyBMb2dnZXIg4oCUIHJ1bnMgb24gYSBkZWRpY2F0ZWQgV29ya2VyIHRocmVhZAovLyAgc28gbG9nZ2luZyBJL08gbmV2ZXIgYmxvY2tzIE1DUCBtZXNzYWdlIHByb2Nlc3NpbmcKLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCgpjb25zdCBsb2dXb3JrZXIgPSBuZXcgV29ya2VyKGpvaW4oX19kaXJuYW1lLCAibG9nLXdvcmtlci5qcyIpLCB7CiAgd29ya2VyRGF0YTogeyBsb2dEaXI6IGpvaW4oX19kaXJuYW1lLCAibG9ncyIpIH0sCn0pOwpsb2dXb3JrZXIub24oImVycm9yIiwgKGVycikgPT4gewogIHByb2Nlc3Muc3RkZXJyLndyaXRlKGBbTE9HIFdPUktFUiBFUlJPUl0gJHtlcnIubWVzc2FnZX1cbmApOwp9KTsKbG9nV29ya2VyLnVucmVmKCk7IC8vIGRvbid0IGtlZXAgcHJvY2VzcyBhbGl2ZSBqdXN0IGZvciBsb2dnaW5nCgpmdW5jdGlvbiBsb2coZGlyZWN0aW9uLCBkYXRhKSB7CiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOwogIGxldCBzdW1tYXJ5LCBkZXRhaWw7CgogIGlmICh0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIpIHsKICAgIHN1bW1hcnkgPSBkYXRhOwogICAgZGV0YWlsID0gZGF0YTsKICB9IGVsc2UgewogICAgZGV0YWlsID0gSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMik7CgogICAgLy8gQnVpbGQgYSBjb21wYWN0IG9uZS1saW5lIHN1bW1hcnkKICAgIGNvbnN0IGlkID0gZGF0YS5pZCAhPSBudWxsID8gYFtpZDoke2RhdGEuaWR9XSBgIDogIiI7CgogICAgaWYgKGRhdGEubWV0aG9kKSB7CiAgICAgIC8vIEluYm91bmQgcmVxdWVzdCBvciBub3RpZmljYXRpb24KICAgICAgY29uc3QgcGFyYW1zID0gZGF0YS5wYXJhbXM7CiAgICAgIGlmIChwYXJhbXM/Lm5hbWUpIHsKICAgICAgICBjb25zdCBhcmdzID0gcGFyYW1zLmFyZ3VtZW50cwogICAgICAgICAgPyBgICR7SlNPTi5zdHJpbmdpZnkocGFyYW1zLmFyZ3VtZW50cyl9YAogICAgICAgICAgOiAiIjsKICAgICAgICBzdW1tYXJ5ID0gYCR7aWR9JHtkYXRhLm1ldGhvZH0gJHtwYXJhbXMubmFtZX0ke2FyZ3N9YDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdW1tYXJ5ID0gYCR7aWR9JHtkYXRhLm1ldGhvZH1gOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGRhdGEucmVzdWx0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgLy8gT3V0Ym91bmQgcmVzcG9uc2UgKHN1Y2Nlc3MpCiAgICAgIGNvbnN0IGNvbnRlbnQgPSBkYXRhLnJlc3VsdD8uY29udGVudDsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29udGVudCkpIHsKICAgICAgICBjb25zdCB0ZXh0TGVuID0gY29udGVudAogICAgICAgICAgLm1hcCgoYykgPT4gYy50ZXh0Py5sZW5ndGggfHwgMCkKICAgICAgICAgIC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICAgICAgICBzdW1tYXJ5ID0gYCR7aWR9cmVzdWx0IFske3RleHRMZW59IGNoYXJzXWA7CiAgICAgIH0gZWxzZSBpZiAoZGF0YS5yZXN1bHQ/LnRvb2xzKSB7CiAgICAgICAgc3VtbWFyeSA9IGAke2lkfXRvb2xzIFske2RhdGEucmVzdWx0LnRvb2xzLmxlbmd0aH0gdG9vbHNdYDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdW1tYXJ5ID0gYCR7aWR9cmVzdWx0ICR7SlNPTi5zdHJpbmdpZnkoZGF0YS5yZXN1bHQpLnN1YnN0cmluZygwLCAxMDApfWA7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZGF0YS5lcnJvcikgewogICAgICAvLyBPdXRib3VuZCByZXNwb25zZSAoZXJyb3IpCiAgICAgIHN1bW1hcnkgPSBgJHtpZH1lcnJvcjogJHtkYXRhLmVycm9yLm1lc3NhZ2UgfHwgSlNPTi5zdHJpbmdpZnkoZGF0YS5lcnJvcil9YDsKICAgIH0gZWxzZSB7CiAgICAgIHN1bW1hcnkgPSBgJHtpZH0ke0pTT04uc3RyaW5naWZ5KGRhdGEpLnN1YnN0cmluZygwLCAxMjApfWA7CiAgICB9CiAgfQoKICBsb2dXb3JrZXIucG9zdE1lc3NhZ2UoeyB0aW1lc3RhbXAsIGRpcmVjdGlvbiwgc3VtbWFyeSwgZGV0YWlsIH0pOwp9CgovLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKLy8gIExvZ2dpbmdUcmFuc3BvcnQg4oCUIHdyYXBzIFN0ZGlvU2VydmVyVHJhbnNwb3J0IHRvCi8vICBpbnRlcmNlcHQgQUxMIGluYm91bmQgKDwtKSBhbmQgb3V0Ym91bmQgKC0+KSB0cmFmZmljCi8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAoKY2xhc3MgTG9nZ2luZ1RyYW5zcG9ydCB7CiAgY29uc3RydWN0b3IoaW5uZXIpIHsKICAgIHRoaXMuX2lubmVyID0gaW5uZXI7CiAgfQoKICBnZXQgc2Vzc2lvbklkKCkgewogICAgcmV0dXJuIHRoaXMuX2lubmVyLnNlc3Npb25JZDsKICB9CiAgc2V0IHNlc3Npb25JZCh2YWwpIHsKICAgIHRoaXMuX2lubmVyLnNlc3Npb25JZCA9IHZhbDsKICB9CgogIHNldCBvbm1lc3NhZ2UoaGFuZGxlcikgewogICAgdGhpcy5faW5uZXIub25tZXNzYWdlID0gKG1zZykgPT4gewogICAgICBsb2coIjwtIiwgbXNnKTsKICAgICAgaGFuZGxlcihtc2cpOwogICAgfTsKICB9CgogIHNldCBvbmVycm9yKGhhbmRsZXIpIHsKICAgIHRoaXMuX2lubmVyLm9uZXJyb3IgPSAoZXJyKSA9PiB7CiAgICAgIGxvZygiPC0gRVJSIiwgU3RyaW5nKGVycikpOwogICAgICBoYW5kbGVyKGVycik7CiAgICB9OwogIH0KCiAgc2V0IG9uY2xvc2UoaGFuZGxlcikgewogICAgdGhpcy5faW5uZXIub25jbG9zZSA9ICgpID0+IHsKICAgICAgbG9nKCItLSIsICJjb25uZWN0aW9uIGNsb3NlZCIpOwogICAgICBoYW5kbGVyKCk7CiAgICB9OwogIH0KCiAgYXN5bmMgc3RhcnQoKSB7CiAgICBsb2coIi0tIiwgInRyYW5zcG9ydCBzdGFydGVkIik7CiAgICByZXR1cm4gdGhpcy5faW5uZXIuc3RhcnQoKTsKICB9CgogIGFzeW5jIHNlbmQobWVzc2FnZSkgewogICAgbG9nKCItPiIsIG1lc3NhZ2UpOwogICAgcmV0dXJuIHRoaXMuX2lubmVyLnNlbmQobWVzc2FnZSk7CiAgfQoKICBhc3luYyBjbG9zZSgpIHsKICAgIHJldHVybiB0aGlzLl9pbm5lci5jbG9zZSgpOwogIH0KfQoKLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCi8vICBNQ1AgU2VydmVyIERlZmluaXRpb24KLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCgpjb25zdCBzZXJ2ZXIgPSBuZXcgU2VydmVyKAogIHsKICAgIG5hbWU6ICJucG0tcnVubmVyIiwKICAgIHZlcnNpb246ICIxLjEuMCIsCiAgfSwKICB7CiAgICBjYXBhYmlsaXRpZXM6IHsKICAgICAgdG9vbHM6IHt9LAogICAgfSwKICB9Cik7CgovLyBMaXN0IGF2YWlsYWJsZSB0b29scwpzZXJ2ZXIuc2V0UmVxdWVzdEhhbmRsZXIoTGlzdFRvb2xzUmVxdWVzdFNjaGVtYSwgYXN5bmMgKCkgPT4gewogIHJldHVybiB7CiAgICB0b29sczogWwogICAgICB7CiAgICAgICAgbmFtZTogIm5wbV90ZXN0IiwKICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICJSdW4gbnBtIHRlc3QgaW4gdGhlIHdiLXN0YXJ0ZXIgcHJvamVjdC4gUmV0dXJucyB0ZXN0IHJlc3VsdHMgYW5kIHdyaXRlcyB0aGVtIHRvIGRhdGEvdGVzdC1yZXN1bHRzLmpzb24uIFByb2dyZXNzIHN0cmVhbXMgdG8gZGF0YS90ZXN0LXByb2dyZXNzLmxvZyBpbiByZWFsLXRpbWUuIiwKICAgICAgICBpbnB1dFNjaGVtYTogewogICAgICAgICAgdHlwZTogIm9iamVjdCIsCiAgICAgICAgICBwcm9wZXJ0aWVzOiB7CiAgICAgICAgICAgIGZpbHRlcjogewogICAgICAgICAgICAgIHR5cGU6ICJzdHJpbmciLAogICAgICAgICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAgICAgIk9wdGlvbmFsOiBmaWx0ZXIgdG8gcnVuIHNwZWNpZmljIHRlc3RzIChlLmcuLCAnc2NoZW1hJyBvciAnY29tcGxpYW5jZScpIiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2luZ2xlVGhyZWFkOiB7CiAgICAgICAgICAgICAgdHlwZTogImJvb2xlYW4iLAogICAgICAgICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgICAgICAgIlJ1biB0ZXN0cyBpbiBzaW5nbGUtdGhyZWFkZWQgbW9kZSBmb3IgZWFzaWVyIGRlYnVnZ2luZyIsCiAgICAgICAgICAgICAgZGVmYXVsdDogZmFsc2UsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9LAogICAgICAgICAgcmVxdWlyZWQ6IFtdLAogICAgICAgIH0sCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBuYW1lOiAibnBtX2NvbW1hbmQiLAogICAgICAgIGRlc2NyaXB0aW9uOiAiUnVuIGFueSBucG0gY29tbWFuZCBpbiB0aGUgd2Itc3RhcnRlciBwcm9qZWN0IiwKICAgICAgICBpbnB1dFNjaGVtYTogewogICAgICAgICAgdHlwZTogIm9iamVjdCIsCiAgICAgICAgICBwcm9wZXJ0aWVzOiB7CiAgICAgICAgICAgIGNvbW1hbmQ6IHsKICAgICAgICAgICAgICB0eXBlOiAic3RyaW5nIiwKICAgICAgICAgICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICAgICAgICJUaGUgbnBtIGNvbW1hbmQgdG8gcnVuIChlLmcuLCAncnVuIGJ1aWxkJywgJ2luc3RhbGwnLCAncnVuIGxpbnQnKSIsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9LAogICAgICAgICAgcmVxdWlyZWQ6IFsiY29tbWFuZCJdLAogICAgICAgIH0sCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBuYW1lOiAiY2hlY2tfcHJvZ3Jlc3MiLAogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgIkNoZWNrIHJlYWwtdGltZSBwcm9ncmVzcyBvZiBhIHJ1bm5pbmcgbnBtIGNvbW1hbmQuIFJlYWRzIHRoZSBzdHJlYW1pbmcgb3V0cHV0IGZyb20gZGF0YS90ZXN0LXByb2dyZXNzLmxvZy4gVXNlICd0YWlsJyBwYXJhbSB0byBnZXQgbGFzdCBOIGxpbmVzLiIsCiAgICAgICAgaW5wdXRTY2hlbWE6IHsKICAgICAgICAgIHR5cGU6ICJvYmplY3QiLAogICAgICAgICAgcHJvcGVydGllczogewogICAgICAgICAgICB0YWlsOiB7CiAgICAgICAgICAgICAgdHlwZTogIm51bWJlciIsCiAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJOdW1iZXIgb2YgbGluZXMgZnJvbSBlbmQgdG8gcmV0dXJuIChkZWZhdWx0OiAzMCkiLAogICAgICAgICAgICAgIGRlZmF1bHQ6IDMwLAogICAgICAgICAgICB9LAogICAgICAgICAgfSwKICAgICAgICAgIHJlcXVpcmVkOiBbXSwKICAgICAgICB9LAogICAgICB9LAogICAgXSwKICB9Owp9KTsKCi8vIEhhbmRsZSB0b29sIGNhbGxzCnNlcnZlci5zZXRSZXF1ZXN0SGFuZGxlcihDYWxsVG9vbFJlcXVlc3RTY2hlbWEsIGFzeW5jIChyZXF1ZXN0KSA9PiB7CiAgY29uc3QgeyBuYW1lLCBhcmd1bWVudHM6IGFyZ3MgfSA9IHJlcXVlc3QucGFyYW1zOwoKICBpZiAobmFtZSA9PT0gIm5wbV90ZXN0IikgewogICAgcmV0dXJuIGF3YWl0IHJ1bk5wbVRlc3QoYXJncz8uZmlsdGVyLCBhcmdzPy5zaW5nbGVUaHJlYWQpOwogIH0KCiAgaWYgKG5hbWUgPT09ICJucG1fY29tbWFuZCIpIHsKICAgIHJldHVybiBhd2FpdCBydW5OcG1Db21tYW5kKGFyZ3MuY29tbWFuZCk7CiAgfQoKICBpZiAobmFtZSA9PT0gImNoZWNrX3Byb2dyZXNzIikgewogICAgcmV0dXJuIGNoZWNrUHJvZ3Jlc3MoYXJncz8udGFpbCB8fCAzMCk7CiAgfQoKICByZXR1cm4gewogICAgY29udGVudDogW3sgdHlwZTogInRleHQiLCB0ZXh0OiBgVW5rbm93biB0b29sOiAke25hbWV9YCB9XSwKICAgIGlzRXJyb3I6IHRydWUsCiAgfTsKfSk7CgovLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKLy8gIFRvb2wgSW1wbGVtZW50YXRpb25zCi8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKV