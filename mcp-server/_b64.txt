import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from "@modelcontextprotocol/sdk/types.js";
import { spawn } from "child_process";
import { writeFile } from "fs/promises";
import { writeFileSync, appendFileSync, readFileSync, existsSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";
import { Worker } from "worker_threads";

const __dirname = dirname(fileURLToPath(import.meta.url));
const PROJECT_DIR = join(__dirname, "..");
const PROGRESS_FILE = join(PROJECT_DIR, "data", "test-progress.log");
const RESULTS_FILE = join(PROJECT_DIR, "data", "test-results.json");

// Track running command state
let runningCommand = null; // { startTime, command, pid, process }

// ════════════════════════════════════════════════════════
//  Traffic Logger — runs on a dedicated Worker thread
// ════════════════════════════════════════════════════════

const logWorker = new Worker(join(__dirname, "log-worker.js"), {
  workerData: { logDir: join(__dirname, "logs") },
});
logWorker.on("error", (err) => {
  process.stderr.write(`[LOG WORKER ERROR] ${err.message}\n`);
});
logWorker.unref();

function log(direction, data) {
  const timestamp = new Date().toISOString();
  let summary, detail;

  if (typeof data === "string") {
    summary = data;
    detail = data;
  } else {
    detail = JSON.stringify(data, null, 2);
    const id = data.id != null ? `[id:${data.id}] ` : "";

    if (data.method) {
      const params = data.params;
      if (params?.name) {
        const args = params.arguments ? ` ${JSON.stringify(params.arguments)}` : "";
        summary = `${id}${data.method} ${params.name}${args}`;
      } else {
        summary = `${id}${data.method}`;
      }
    } else if (data.result !== undefined) {
      const content = data.result?.content;
      if (Array.isArray(content)) {
        const textLen = content.map((c) => c.text?.length || 0).reduce((a, b) => a + b, 0);
        summary = `${id}result [${textLen} chars]`;
      } else if (data.result?.tools) {
        summary = `${id}tools [${data.result.tools.length} tools]`;
      } else {
        summary = `${id}result ${JSON.stringify(data.result).substring(0, 100)}`;
      }
    } else if (data.error) {
      summary = `${id}error: ${data.error.message || JSON.stringify(data.error)}`;
    } else {
      summary = `${id}${JSON.stringify(data).substring(0, 120)}`;
    }
  }

  logWorker.postMessage({ timestamp, direction, summary, detail });
}

// ════════════════════════════════════════════════════════
//  LoggingTransport
// ════════════════════════════════════════════════════════

class LoggingTransport {
  constructor(inner) { this._inner = inner; }
  get sessionId() { return this._inner.sessionId; }
  set sessionId(val) { this._inner.sessionId = val; }
  set onmessage(handler) {
    this._inner.onmessage = (msg) => { log("<-", msg); handler(msg); };
  }
  set onerror(handler) {
    this._inner.onerror = (err) => { log("<- ERR", String(err)); handler(err); };
  }
  set onclose(handler) {
    this._inner.onclose = () => { log("--", "connection closed"); handler(); };
  }
  async start() { log("--", "transport started"); return this._inner.start(); }
  async send(message) { log("->", message); return this._inner.send(message); }
  async close() { return this._inner.close(); }
}

// ════════════════════════════════════════════════════════
//  MCP Server Definition
// ════════════════════════════════════════════════════════

const server = new Server(
  { name: "npm-runner", version: "2.0.0" },
  { capabilities: { tools: {} } }
);

server.setRequestHandler(ListToolsRequestSchema, async () => {
  return {
    tools: [
      {
        name: "npm_test",
        description:
          "Run npm test in the wb-starter project. Returns test results and writes them to data/test-results.json. Progress streams to data/test-progress.log in real-time.",
        inputSchema: {
          type: "object",
          properties: {
            filter: {
              type: "string",
              description: "Optional: filter to run specific tests (e.g., 'schema' or 'compliance')",
            },
            singleThread: {
              type: "boolean",
              description: "Run tests in single-threaded mode for easier debugging",
              default: false,
            },
          },
          required: [],
        },
      },
      {
        name: "npm_command",
  