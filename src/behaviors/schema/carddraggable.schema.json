{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Card Draggable",
  "description": "Draggable card component. INHERITS from card.base (IS-A card), CONTAINS drag behavior (HAS-A drag handle, drag events).",
  "behavior": "carddraggable",
  
  "$extends": "card.base.schema.json",
  "$inheritance": {
    "type": "IS-A",
    "parent": "card",
    "inherits": [
      "semantic.element",
      "semantic.structure.header",
      "semantic.structure.main",
      "semantic.structure.footer",
      "compliance.containerTag",
      "accessibility"
    ]
  },
  
  "$containment": [
    {
      "type": "HAS-A",
      "name": "dragHandle",
      "element": "HEADER .wb-card__drag-handle",
      "description": "Drag handle element for initiating drag"
    }
  ],
  
  "properties": {
    
    "title": {
      "type": "string",
      "description": "Card title",
      "mapsTo": "header",
      "default": "Draggable Card",
      "permutations": {
        "type": "EXPLICIT",
        "values": ["Draggable Card", "Drag Me", "Moveable"],
        "assertions": {
          "Draggable Card": {
            "selector": "header h3.wb-card__title",
            "checks": { "exists": true, "textContains": "Draggable Card" }
          }
        }
      }
    },
    "content": {
      "type": "string",
      "description": "Card content",
      "mapsTo": "main",
      "default": "Drag the handle to move this card.",
      "inputType": "textarea",
      "permutations": {
        "type": "EXPLICIT",
        "values": [
          "Short content",
          "This card can be dragged around. Use the handle in the header to move it."
        ],
        "assertions": {
          "Short content": {
            "selector": "main.wb-card__main",
            "checks": { "textContains": "Short content" }
          }
        }
      }
    },
    "constrain": {
      "type": "string",
      "description": "Constrain drag to parent, viewport, or none",
      "enum": ["none", "parent", "viewport"],
      "default": "none",
      "inputType": "select"
    },
    "axis": {
      "type": "string",
      "description": "Constrain drag to axis",
      "enum": ["both", "x", "y"],
      "default": "both",
      "inputType": "select"
    },
    "snapToGrid": {
      "type": "number",
      "description": "Snap to grid size in pixels (0 = disabled)",
      "default": 0
    },
    "elevated": {
      "type": "boolean",
      "description": "Has shadow/elevation effect",
      "default": false
    }
  },
  
  "compliance": {
    "$inherits": "card.base.schema.json#compliance",
    "baseClass": "wb-card",
    "additionalClasses": ["wb-card--draggable"],
    "containerTag": {
      "preferred": "ARTICLE",
      "allowed": ["ARTICLE", "SECTION", "DIV"]
    },
    "styles": {
      "position": "absolute or relative",
      "cursor": "grab on handle"
    },
    "requiredChildren": {
      "header.wb-card__header": {
        "description": "Header with drag handle",
        "tagName": "HEADER",
        "required": true,
        "children": {
          ".wb-card__drag-handle": {
            "required": true,
            "relationship": "HAS-A",
            "style": { "cursor": "grab" }
          },
          "h3.wb-card__title": { "tagName": "H3" }
        }
      },
      "main.wb-card__main": {
        "description": "Card content",
        "tagName": "MAIN",
        "required": true
      }
    }
  },
  
  "interactions": {
    "elements": {
      ".wb-card__drag-handle": {
        "type": "drag-handle",
        "draggable": true,
        "cursor": {
          "default": "grab",
          "active": "grabbing"
        }
      }
    },
    "mouse": {
      "mousedown": {
        "target": ".wb-card__drag-handle",
        "action": "Start drag",
        "event": "wb:carddraggable:dragstart"
      },
      "mousemove": {
        "condition": "while dragging",
        "action": "Update position",
        "event": "wb:carddraggable:drag"
      },
      "mouseup": {
        "condition": "while dragging",
        "action": "End drag",
        "event": "wb:carddraggable:dragend"
      }
    },
    "states": {
      "idle": {
        "class": "",
        "handleCursor": "grab"
      },
      "dragging": {
        "class": "wb-card--dragging",
        "handleCursor": "grabbing",
        "cardStyle": { "opacity": "0.8", "zIndex": "1000" }
      }
    }
  },
  
  "accessibility": {
    "$inherits": "card.base.schema.json#accessibility",
    "dragHandle": {
      "ariaLabel": "Drag to move card",
      "role": "button"
    }
  },
  
  "events": {
    "wb:carddraggable:dragstart": {
      "source": ".wb-card__drag-handle",
      "bubbles": true,
      "detail": { "x": "number", "y": "number" },
      "firesWhen": "Drag starts"
    },
    "wb:carddraggable:drag": {
      "source": "element",
      "bubbles": true,
      "detail": { "x": "number", "y": "number", "deltaX": "number", "deltaY": "number" },
      "firesWhen": "During drag"
    },
    "wb:carddraggable:dragend": {
      "source": "element",
      "bubbles": true,
      "detail": { "x": "number", "y": "number" },
      "firesWhen": "Drag ends"
    }
  },
  
  "api": {
    "element.wbCardDraggable": {
      "setPosition": { "description": "Set card position", "params": ["x: number", "y: number"], "returns": "void" },
      "getPosition": { "description": "Get current position", "returns": "{ x: number, y: number }" },
      "reset": { "description": "Reset to original position", "returns": "void" }
    }
  },
  
  "test": {
    "setup": [
      "<article data-wb=\"carddraggable\" data-title=\"Drag Me\">Content</article>",
      "<article data-wb=\"carddraggable\" data-title=\"Constrained\" data-constrain=\"parent\">Content</article>"
    ],
    
    "matrix": {
      "description": "Test all property combinations",
      "combinations": [
        { "title": "Basic", "content": "Content" },
        { "title": "Constrained", "content": "Content", "constrain": "parent" },
        { "title": "Viewport", "content": "Content", "constrain": "viewport" },
        { "title": "X Only", "content": "Content", "axis": "x" },
        { "title": "Y Only", "content": "Content", "axis": "y" },
        { "title": "Snap", "content": "Content", "snapToGrid": 20 },
        { "title": "Full", "content": "Content", "constrain": "parent", "axis": "both", "elevated": true }
      ]
    },
    
    "functional": {
      "semantic": [
        {
          "name": "Container should be ARTICLE (inherited)",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "expect": { "selector": "element", "tagName": "ARTICLE" }
        },
        {
          "name": "Drag handle exists in HEADER (HAS-A)",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "expect": { "selector": "header .wb-card__drag-handle", "exists": true }
        },
        {
          "name": "Title in HEADER H3 (inherited)",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "expect": { "selector": "header h3.wb-card__title", "tagName": "H3" }
        },
        {
          "name": "Content in MAIN (inherited)",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "expect": { "selector": "main.wb-card__main", "tagName": "MAIN" }
        }
      ],
      
      "rendering": [
        {
          "name": "Has wb-card--draggable class",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "expect": { "selector": "element", "checks": { "hasClass": "wb-card--draggable" } }
        },
        {
          "name": "Drag handle has grab cursor",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "expect": { "selector": ".wb-card__drag-handle", "checks": { "style": { "cursor": "grab" } } }
        }
      ],
      
      "interactions": [
        {
          "name": "Mousedown on handle starts drag",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" }
          ],
          "expect": { "selector": "element", "checks": { "hasClass": "wb-card--dragging" } }
        },
        {
          "name": "Mouseup ends drag",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" },
            { "action": "mouseup", "selector": "document" }
          ],
          "expect": { "selector": "element", "checks": { "notHasClass": "wb-card--dragging" } }
        },
        {
          "name": "Cursor changes to grabbing during drag",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" }
          ],
          "expect": { "selector": ".wb-card__drag-handle", "checks": { "style": { "cursor": "grabbing" } } }
        },
        {
          "name": "Card opacity reduces during drag",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" }
          ],
          "expect": { "selector": "element", "checks": { "style": { "opacity": "0.8" } } }
        },
        {
          "name": "Dispatches dragstart event",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle", "position": { "x": 100, "y": 100 } }
          ],
          "expect": { 
            "event": "wb:carddraggable:dragstart",
            "detail": { "x": 100, "y": 100 }
          }
        },
        {
          "name": "Dispatches dragend event",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" },
            { "action": "mouseup", "selector": "document" }
          ],
          "expect": { "event": "wb:carddraggable:dragend" }
        }
      ],
      
      "constraints": [
        {
          "name": "constrain=parent keeps card within parent",
          "setup": "<div style=\"width:200px;height:200px;position:relative\"><article data-wb=\"carddraggable\" data-title=\"Test\" data-constrain=\"parent\" style=\"width:50px\">C</article></div>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" },
            { "action": "mousemove", "position": { "x": 300, "y": 300 } },
            { "action": "mouseup", "selector": "document" }
          ],
          "expect": { 
            "selector": "element", 
            "checks": { 
              "style": { "left": "<=150px", "top": "<=150px" } 
            }
          }
        },
        {
          "name": "axis=x restricts to horizontal movement",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\" data-axis=\"x\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" },
            { "action": "mousemove", "delta": { "x": 50, "y": 50 } },
            { "action": "mouseup", "selector": "document" }
          ],
          "expect": { 
            "selector": "element", 
            "checks": { "positionYUnchanged": true }
          }
        },
        {
          "name": "axis=y restricts to vertical movement",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\" data-axis=\"y\">Content</article>",
          "steps": [
            { "action": "mousedown", "selector": ".wb-card__drag-handle" },
            { "action": "mousemove", "delta": { "x": 50, "y": 50 } },
            { "action": "mouseup", "selector": "document" }
          ],
          "expect": { 
            "selector": "element", 
            "checks": { "positionXUnchanged": true }
          }
        }
      ],
      
      "accessibility": [
        {
          "name": "Drag handle has aria-label",
          "setup": "<article data-wb=\"carddraggable\" data-title=\"Test\">Content</article>",
          "expect": { 
            "selector": ".wb-card__drag-handle", 
            "checks": { "attribute": { "aria-label": "Drag to move card" } }
          }
        }
      ]
    }
  },
  
  "builder": {
    "category": "Cards",
    "icon": "ðŸŽ¯",
    "name": "Card Draggable",
    "description": "Card that can be dragged around",
    "defaults": {
      "title": "Draggable Card",
      "content": "Drag the handle to move this card.",
      "constrain": "none",
      "axis": "both"
    },
    "propertyPanel": {
      "groups": [
        {
          "name": "Content",
          "properties": ["title", "content"]
        },
        {
          "name": "Constraints",
          "properties": ["constrain", "axis", "snapToGrid"]
        },
        {
          "name": "Style",
          "properties": ["elevated", "hoverable"]
        }
      ]
    }
  }
}
