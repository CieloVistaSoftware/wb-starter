{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "schema.schema.json",
  "schemaType": "definition",
  "title": "WB Component Schema Meta-Schema",
  "description": "Validates WB schema files across 3 tiers. Component schemas (default) require all fields. Base schemas (inherited from, never instantiated) relax $view/$methods/behavior. Definition schemas (pure reference docs) require only title + description. Enforces v3.0 rules: every property must have type + default, enums must be arrays, $view items need name + tag.",

  "type": "object",

  "_schemaTypes": {
    "component": {
      "description": "Default. Real components users interact with. Full rules apply.",
      "required": ["title", "description", "properties", "$view", "$methods"],
      "requiresBehaviorOrSchemaFor": true,
      "propertyRules": "type + default mandatory on every property"
    },
    "base": {
      "description": "Abstract schemas inherited by other schemas. Never instantiated directly.",
      "required": ["title", "description", "properties"],
      "requiresBehaviorOrSchemaFor": false,
      "propertyRules": "type + default mandatory on every property"
    },
    "definition": {
      "description": "Pure reference documents defining rules or contracts. Not components.",
      "required": ["title", "description"],
      "requiresBehaviorOrSchemaFor": false,
      "propertyRules": "none — properties section optional"
    },
    "page": {
      "description": "Page-level schema. Defines layout rows, page rules, and content placement. Not a component.",
      "required": ["title", "description", "pageRules", "$layout"],
      "requiresBehaviorOrSchemaFor": false,
      "propertyRules": "type + default on data properties"
    }
  },

  "required": ["title", "description"],

  "properties": {
    "src": {
      "type": "string",
      "description": "Path to the JavaScript file implementing this behavior (e.g. 'src/wb-viewmodels/ripple.js')"
    },
    "category": {
      "type": "string",
      "description": "Behavior category (e.g. 'inputs', 'buttons', etc.)"
    },
    "name": {
      "type": "string",
      "description": "Unique identifier for the behavior"
    },

    "schemaType": {
      "type": "string",
      "enum": ["component", "base", "definition", "page"],
      "default": "component",
      "description": "Schema tier. 'component' (default) = full rules. 'base' = abstract/inherited, $view/$methods optional. 'definition' = reference doc, only title+description required."
    },
    "$schema": {
      "type": "string",
      "description": "JSON Schema draft reference"
    },
    "$id": {
      "type": "string",
      "description": "Schema identifier (filename)",
      "pattern": "^[a-z][a-z0-9-]*\\.schema\\.json$"
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "description": "Human-readable component name"
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "description": "What this component does"
    },

    "behavior": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Behavior name in kebab-case"
    },
    "schemaFor": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Legacy behavior identifier (prefer 'behavior')"
    },
    "baseClass": {
      "type": "string",
      "pattern": "^wb-[a-z][a-z0-9-]*$",
      "description": "Base CSS class (BEM block). Must start with wb-"
    },

    "semanticElement": {
      "type": "object",
      "properties": {
        "tagName": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Default HTML element (lowercase)"
        },
        "implicitRole": {
          "type": "string",
          "description": "WAI-ARIA implicit role"
        }
      },
      "required": ["tagName"]
    },

    "compliance": {
      "type": "object",
      "description": "Legacy compliance section (retained for backward compat)",
      "properties": {
        "baseClass": { "type": "string" },
        "supportLevel": {
          "type": "string",
          "enum": ["stable", "experimental", "deprecated"]
        },
        "accessibility": {
          "type": "string",
          "enum": ["high", "medium", "low", "none"]
        }
      }
    },

    "properties": {
      "type": "object",
      "description": "Model — data inputs (attributes). Every property MUST have type + default.",
      "additionalProperties": {
        "$ref": "#/$defs/componentProperty"
      }
    },

    "$view": {
      "type": "array",
      "description": "View — DOM structure. Array of view items (can be empty).",
      "items": {
        "$ref": "#/$defs/viewItem"
      }
    },

    "$methods": {
      "type": "object",
      "description": "ViewModel — callable functions bound to the element.",
      "additionalProperties": {
        "$ref": "#/$defs/methodItem"
      }
    },

    "$cssAPI": {
      "type": "object",
      "description": "Public CSS custom properties for theming.",
      "additionalProperties": {
        "$ref": "#/$defs/cssApiItem"
      }
    },

    "accessibility": {
      "type": "object",
      "description": "Accessibility configuration",
      "properties": {
        "role": { "type": "string" },
        "ariaValueMin": { "type": "string" },
        "ariaValueMax": { "type": "string" },
        "ariaValueNow": { "type": "string" },
        "ariaLabel": { "type": "string" }
      }
    },

    "pageRules": {
      "$ref": "#/$defs/pageRules"
    },

    "$layout": {
      "$ref": "#/$defs/pageLayout"
    },

    "test": {
      "$ref": "#/$defs/testConfig"
    },

    "_metadata": {
      "type": "object",
      "description": "Categorization, icons, versioning",
      "properties": {
        "category": { "type": "string" },
        "icon": { "type": "string" },
        "since": { "type": "string" },
        "status": {
          "type": "string",
          "enum": ["stable", "experimental", "deprecated"]
        }
      }
    }
  },

  "anyOf": [
    { "required": ["behavior"] },
    { "required": ["schemaFor"] }
  ],

  "$defs": {

    "componentProperty": {
      "type": "object",
      "description": "A single component property (attribute). Must have type and default.",
      "required": ["type", "default"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["string", "boolean", "number", "integer", "array", "object"],
          "description": "Data type"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description"
        },
        "default": {
          "description": "Default value when attribute is absent. MANDATORY — no exceptions."
        },
        "enum": {
          "type": "array",
          "minItems": 1,
          "description": "Complete set of allowed values. If present, no other values are valid."
        },
        "minimum": {
          "type": "number",
          "description": "Minimum allowed value (number/integer types only)"
        },
        "maximum": {
          "type": "number",
          "description": "Maximum allowed value (number/integer types only)"
        },
        "required": {
          "type": "boolean",
          "description": "Is this attribute required?"
        },
        "appliesClass": {
          "type": "string",
          "description": "CSS class applied when truthy. Supports {{value}} template."
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "string" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "default": { "type": "string" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "boolean" } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "default": { "type": "boolean" }
            }
          }
        },
        {
          "if": {
            "properties": { "type": { "enum": ["number", "integer"] } },
            "required": ["type"]
          },
          "then": {
            "properties": {
              "default": { "type": "number" }
            }
          }
        },
        {
          "if": {
            "properties": {
              "minimum": true
            },
            "required": ["minimum"]
          },
          "then": {
            "properties": {
              "type": { "enum": ["number", "integer"] }
            }
          }
        },
        {
          "if": {
            "properties": {
              "maximum": true
            },
            "required": ["maximum"]
          },
          "then": {
            "properties": {
              "type": { "enum": ["number", "integer"] }
            }
          }
        }
      ]
    },

    "viewItem": {
      "type": "object",
      "description": "A single element in the $view DOM structure.",
      "required": ["name", "tag"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-zA-Z0-9-]*$",
          "description": "Part identifier — generates BEM class"
        },
        "tag": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "HTML element tag (lowercase)"
        },
        "parent": {
          "type": "string",
          "description": "Nest inside another part (by name)"
        },
        "content": {
          "type": "string",
          "description": "Template with {{prop}} interpolation"
        },
        "required": {
          "type": "boolean",
          "description": "Always create this element"
        },
        "createdWhen": {
          "type": "string",
          "description": "Conditional creation expression (e.g. 'title OR subtitle')"
        },
        "public": {
          "type": "boolean",
          "default": true,
          "description": "Is this part of the public API? Private parts get __- prefix."
        },
        "class": {
          "type": "string",
          "description": "Additional CSS classes"
        },
        "description": {
          "type": "string",
          "description": "Documentation for this part"
        }
      }
    },

    "methodItem": {
      "type": "object",
      "description": "A callable method on the component.",
      "required": ["description"],
      "properties": {
        "description": {
          "type": "string",
          "description": "What the method does"
        },
        "params": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Parameter names"
        },
        "returns": {
          "type": "string",
          "description": "Return type"
        }
      }
    },

    "cssApiItem": {
      "type": "object",
      "description": "A public CSS custom property.",
      "required": ["default", "description"],
      "properties": {
        "default": {
          "type": "string",
          "description": "Default CSS value"
        },
        "description": {
          "type": "string",
          "description": "What this property controls"
        },
        "type": {
          "type": "string",
          "description": "CSS value type hint (color, length, number, etc.)"
        }
      }
    },

    "pageRules": {
      "type": "object",
      "description": "Page-level rules that govern how the page is generated and validated.",
      "required": ["showcase", "fragment"],
      "properties": {
        "showcase": {
          "type": "boolean",
          "description": "If true, all sections are wrapped in wb-demo (shows source code). False for production pages."
        },
        "fragment": {
          "type": "boolean",
          "description": "If true, page is a fragment (no DOCTYPE/html/head/body). Server shell wraps it."
        },
        "noInlineStyles": {
          "type": "boolean",
          "default": true,
          "description": "No inline styles allowed on any element."
        },
        "noPageSpecificCSS": {
          "type": "boolean",
          "default": true,
          "description": "No page-specific CSS file. All styling comes from component CSS."
        }
      }
    },

    "layoutRow": {
      "type": "object",
      "description": "A single row in the page layout. Rows stack vertically. Each row has 1+ columns.",
      "required": ["columns", "content"],
      "properties": {
        "columns": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of columns in this row. Collapses to 1 on mobile (mobile-first)."
        },
        "rows": {
          "type": "integer",
          "minimum": 1,
          "description": "Fixed row count for grid layouts. Omit for auto (content fills and wraps)."
        },
        "direction": {
          "type": "string",
          "enum": ["row", "column"],
          "default": "row",
          "description": "Fill order. 'row' = left to right then wrap. 'column' = top to bottom then wrap."
        },
        "ratio": {
          "type": "string",
          "description": "Column width ratio. Examples: '50/50', '70/30', '30/70', '33/33/33', '25/50/25'. Only for 2-3 columns.",
          "pattern": "^[0-9]+(/[0-9]+){1,2}$"
        },
        "width": {
          "type": "string",
          "description": "Row width. 'full-bleed' = edge to edge. A CSS value (e.g. '900px', '1200px') = contained with max-width.",
          "default": "contained"
        },
        "align": {
          "type": "string",
          "enum": ["top", "center", "bottom", "stretch"],
          "default": "stretch",
          "description": "Vertical alignment of items within this row."
        },
        "heading": {
          "type": "string",
          "description": "Section heading text. Rendered as an h-tag above the row content."
        },
        "headingLevel": {
          "type": "integer",
          "minimum": 1,
          "maximum": 6,
          "default": 2,
          "description": "HTML heading level (1-6). h1 for page title (hero), h2 for major sections, h3 for subsections."
        },
        "subheading": {
          "type": "string",
          "description": "Optional description text below the heading."
        },
        "gap": {
          "type": "string",
          "description": "Override horizontal gap between columns in this row. Defaults to layout-level gap."
        },
        "content": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "maxItems": 3,
          "description": "Section names placed in this row's columns. Must match $view section names."
        }
      }
    },

    "pageLayout": {
      "type": "object",
      "description": "Page layout definition. Rows stacked vertically, each row 1-3 columns. Mobile-first: all columns collapse to 1 on small screens.",
      "required": ["gap", "rows"],
      "properties": {
        "gap": {
          "type": "string",
          "default": "2rem",
          "description": "Vertical gap between rows and horizontal gap between columns."
        },
        "maxWidth": {
          "type": "string",
          "default": "1200px",
          "description": "Default max-width for contained rows. Individual rows can override."
        },
        "rows": {
          "type": "array",
          "items": { "$ref": "#/$defs/layoutRow" },
          "minItems": 1,
          "description": "Ordered list of layout rows. Each row stacks on top of the next."
        }
      }
    },

    "testConfig": {
      "type": "object",
      "description": "Test configuration for the component.",
      "properties": {
        "functional": {
          "type": "boolean",
          "description": "Whether functional tests exist"
        },
        "setup": {
          "type": "array",
          "items": { "type": "string" },
          "description": "HTML strings to instantiate the component for testing"
        },
        "matrix": {
          "type": "object",
          "description": "Permutation test matrix",
          "properties": {
            "combinations": {
              "type": "array",
              "items": { "type": "object" },
              "minItems": 1,
              "description": "Array of attribute objects — each is one test permutation. Single source of truth for what is tested."
            }
          },
          "required": ["combinations"]
        },
        "site": {
          "type": "object",
          "description": "Page-level integration test config",
          "properties": {
            "page": {
              "type": "string",
              "description": "Which page this component appears on"
            },
            "tag": {
              "type": "string",
              "description": "HTML tag to search for"
            },
            "renders": {
              "type": "boolean",
              "description": "Whether the component renders on the page"
            },
            "baseClass": {
              "type": "string",
              "description": "Base CSS class to verify"
            },
            "minInstances": {
              "type": "integer",
              "minimum": 0,
              "description": "Minimum expected instances on page"
            },
            "checkText": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Text content to verify exists"
            },
            "checkClasses": {
              "type": "array",
              "items": { "type": "string" },
              "description": "CSS classes to verify exist"
            },
            "checkAttributes": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Attributes to verify exist"
            },
            "layout": {
              "type": "object",
              "description": "Layout rule assertions for page tests.",
              "properties": {
                "noWbDemo": { "type": "boolean" },
                "noInlineStyles": { "type": "boolean" },
                "isFragment": { "type": "boolean" },
                "sectionOrder": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            },
            "mobileFirst": {
              "type": "object",
              "description": "Mobile-first visual assertions.",
              "properties": {
                "breakpoint": { "type": "integer", "description": "Mobile viewport width in px (e.g. 375)" },
                "noOverflow": { "type": "boolean", "description": "No element wider than viewport" },
                "gridCollapses": { "type": "boolean", "description": "Grid collapses to single column" },
                "statsWrap": { "type": "boolean", "description": "Stats row wraps on mobile" },
                "noHorizontalScroll": { "type": "boolean", "description": "No horizontal scrollbar" }
              }
            },
            "fluent": {
              "type": "object",
              "description": "Fluent layout assertions — no visual artifacts.",
              "properties": {
                "noDashedBorders": { "type": "boolean" },
                "noBuilderBackground": { "type": "boolean" },
                "noForcedMinHeight": { "type": "boolean" },
                "maxStatHeight": { "type": "integer", "description": "Max pixel height for stat cards" },
                "minSectionGap": { "type": "integer", "description": "Min px gap between sections (1rem = 16px)" },
                "maxSectionGap": { "type": "integer", "description": "Max px gap between sections" }
              }
            }
          }
        }
      }
    }
  }
}
