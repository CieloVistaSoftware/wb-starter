name: lock-prune

on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 6 * * 1' # weekly on Monday UTC

jobs:
  detect-stale-locks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install deps (fast)
        run: npm ci --no-audit --no-fund
      - name: Run lock-prune (detect-only)
        run: |
          npm run lock:prune -- --age 30
        env:
          CI: true

  comment-on-pr:
    needs: detect-stale-locks
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Post PR reminder
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `:warning: This PR contains or depends on stale lock files older than 30 days. Please run \`npm run lock:prune -- --age 30 --apply\` locally (or update the PR) to remove released locks or explain why they should stay.`;
            await github.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body });
