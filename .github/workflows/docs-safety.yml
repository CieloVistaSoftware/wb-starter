name: Docs & Shell safety

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/**'
      - 'CONTRIBUTING.md'
      - 'scripts/**'
      - 'tests/**'
  push:
    branches: [ main ]

jobs:
  md-powershell-lint:
    name: Markdown PowerShell lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install deps
        run: npm ci --no-audit
      - name: Run PowerShell-snippet linter
        run: npm run lint:md-powershell

  stale-locks:
    name: Stale Lock check
    runs-on: ubuntu-latest
    needs: md-powershell-lint
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install deps
        run: npm ci --no-audit
      - name: Check Lock/ entries
        run: npm run check:stale-locks

  builder-del-guard:
    name: Builder del() guard (quick)
    runs-on: ubuntu-latest
    needs: [md-powershell-lint, stale-locks]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install deps + Playwright
        run: |
          npm ci --no-audit || true
          if [ ! -d node_modules/@playwright/test ]; then
            npm install --no-audit --no-fund --no-package-lock --save-dev @playwright/test
          fi
          npx playwright install --with-deps
      - name: Run builder del() contract test
        run: npx playwright test tests/behaviors/ui/builder-del-return.spec.ts --project=base --reporter=list
        shell: bash
