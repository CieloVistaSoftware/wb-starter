<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documentation Viewer</title>
  <link rel="stylesheet" href="/src/styles/themes.css">
  <link rel="stylesheet" href="/src/styles/site.css">
  <link rel="stylesheet" href="/src/styles/transitions.css">
  <link rel="stylesheet" href="/node_modules/highlight.js/styles/atom-one-dark.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { 
      padding: 2rem; 
      max-width: 900px; 
      margin: 0 auto; 
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, sans-serif;
    }
    .back-link { 
      display: inline-flex; 
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2rem; 
      color: var(--text-secondary); 
      text-decoration: none; 
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }
    .back-link:hover { 
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--primary);
    }
    
    /* Markdown Styles */
    .wb-mdhtml { line-height: 1.6; }
    .wb-mdhtml h1 { font-size: 2rem; margin-bottom: 1.5rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
    .wb-mdhtml h2 { font-size: 1.5rem; margin-top: 2rem; margin-bottom: 1rem; color: var(--text-primary); }
    .wb-mdhtml h3 { font-size: 1.25rem; margin-top: 1.5rem; margin-bottom: 0.75rem; }
    .wb-mdhtml p { margin-bottom: 1rem; color: var(--text-secondary); }
    .wb-mdhtml ul, .wb-mdhtml ol { margin-bottom: 1rem; padding-left: 1.5rem; color: var(--text-secondary); }
    .wb-mdhtml li { margin-bottom: 0.5rem; }
    .wb-mdhtml code { background: var(--bg-tertiary); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace; font-size: 0.9em; color: var(--text-primary); font-weight: 600; }
    .wb-mdhtml a { color: var(--primary-light); text-decoration: underline; }
    .wb-mdhtml pre { background: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto; margin: 0 auto 1.5rem auto; border: 1px solid var(--border-color); line-height: 1.2; width: fit-content; min-width: 50%; }
    .wb-mdhtml pre code { background: none; padding: 0; color: var(--text-primary); font-weight: normal !important; font-size: 13px; font-family: Consolas, 'Courier New', monospace; white-space: pre; font-variant-ligatures: none; tab-size: 4; letter-spacing: 0; }
    .wb-mdhtml blockquote { border-left: 4px solid var(--primary); margin: 0 0 1.5rem 0; padding-left: 1rem; color: var(--text-muted); font-style: italic; }
    .wb-mdhtml table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
    .wb-mdhtml th, .wb-mdhtml td { padding: 0.75rem; border: 1px solid var(--border-color); text-align: left; }
    .wb-mdhtml th { background: var(--bg-secondary); font-weight: 600; }
    
    .loading { color: var(--text-muted); font-style: italic; }
    .error { color: var(--danger); padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid var(--danger); }
  </style>
</head>
<body id="doc-viewer-body">
  <a id="close-button" href="javascript:window.close()" class="back-link">âœ• Close</a>
  <div id="content" class="wb-mdhtml">
    <div id="loading-message" class="loading">Loading documentation...</div>
  </div>

  <script type="module">
    import { mdhtml } from '/src/wb-viewmodels/mdhtml.js';
    import hljs from '/src/lib/highlight.js';
    
    // Hide close button if not opened via script/link
    if (!window.opener) {
      const closeBtn = document.getElementById('close-button');
      if (closeBtn) closeBtn.style.display = 'none';
    }

    const params = new URLSearchParams(window.location.search);
    let file = params.get('file') || '/docs/index.md';
    // If file is not an absolute path, prefix with /docs/
    if (file && !file.startsWith('/') && !file.startsWith('docs/')) {
      file = '/docs/' + file.replace(/^\/?/, '');
    }
    
    // Helper to resolve relative paths
    function resolveRelativePath(base, relative) {
      // Remove filename from base if present, or ensure it ends with /
      // Actually base passed in is usually the directory
      const stack = base.split('/').filter(p => p.length > 0);
      
      const parts = relative.split('/');
      
      for (const part of parts) {
        if (part === '.') continue;
        if (part === '..') {
          if (stack.length > 0 && stack[stack.length - 1] !== '..') {
            stack.pop();
          } else {
            stack.push('..');
          }
        } else {
          stack.push(part);
        }
      }
      
      return stack.join('/');
    }

    // Link Interceptor for Markdown navigation
    document.addEventListener('click', (e) => {
      const link = e.target.closest('a');
      if (!link) return;
      
      const href = link.getAttribute('href');
      if (!href) return;
      
      // Handle internal anchor links (e.g., #overview)
      if (href.startsWith('#')) {
        e.preventDefault();
        const id = decodeURIComponent(href.substring(1));
        const element = document.getElementById(id);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });
          history.pushState(null, '', href);
        }
        return;
      }
      
      // Check if it's a relative markdown link
      // Matches .md or .md#anchor, but not http:// or /absolute
      if (href.match(/\.md(#.*)?$/) && !href.match(/^https?:/) && !href.startsWith('/')) {
        e.preventDefault();
        
        const currentFile = new URLSearchParams(window.location.search).get('file') || '';
        const currentDir = currentFile.substring(0, currentFile.lastIndexOf('/') + 1);
        
        // Handle hash
        const [path, hash] = href.split('#');
        
        // Resolve path
        const resolvedPath = resolveRelativePath(currentDir, path);
        
        // Construct new URL
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('file', resolvedPath);
        
        // If it's the same file, just scroll (handled by browser if we didn't preventDefault, but we did)
        if (resolvedPath === currentFile && hash) {
             const element = document.getElementById(hash);
             if (element) element.scrollIntoView();
             history.pushState(null, '', newUrl.toString());
             return;
        }

        if (hash) newUrl.hash = hash;
        else newUrl.hash = '';
        
        window.location.href = newUrl.toString();
      }
    });

    // Scroll to hash after load and apply highlighting
    document.addEventListener('wb:mdhtml:loaded', () => {
      // Apply syntax highlighting
      document.querySelectorAll('pre code').forEach((block) => {
        // If no language class is present, force plaintext to prevent auto-detection
        // which can mess up ASCII art alignment
        const hasLanguage = Array.from(block.classList).some(cls => cls.startsWith('language-'));
        if (!hasLanguage) {
           block.classList.add('language-plaintext');
        }
        hljs.highlightElement(block);
      });

      if (window.location.hash) {
        // Decode hash to handle special characters
        const id = decodeURIComponent(window.location.hash.substring(1));
        const element = document.getElementById(id);
        if (element) {
            setTimeout(() => element.scrollIntoView(), 100);
        }
      }
    });
    
    if (file) {
      const content = document.getElementById('content');
      content.dataset.src = file;
      // Disable sanitization to allow embedded HTML/Scripts in documentation
      content.dataset.sanitize = "false";
      
      // Initialize mdhtml
      mdhtml(content, { size: 'md' }).catch(err => {
        content.innerHTML = `<div class="error">Failed to load documentation: ${err.message}</div>`;
      });
    } else {
      document.getElementById('content').innerHTML = '<div class="error">No file specified.</div>';
    }
  </script>
</body>
</html>